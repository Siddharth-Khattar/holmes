# ABOUTME: GitHub Actions CI/CD pipeline for deploying Holmes to GCP Cloud Run.
# ABOUTME: Uses Workload Identity Federation for keyless authentication and builds/deploys both backend and frontend.

name: Deploy to Cloud Run

on:
  push:
    branches: [main, development, test-deployment]
  workflow_dispatch: # Allow manual triggers

env:
  REGION: europe-west3
  BACKEND_SERVICE: holmes-backend
  FRONTEND_SERVICE: holmes-frontend

jobs:
  # Job 1: Type generation check
  types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "backend/uv.lock"

      - name: Install dependencies
        run: |
          bun install
          cd backend && uv sync --dev

      - name: Generate types
        run: make generate-types

      - name: Check for uncommitted type changes
        run: |
          if [ -n "$(git status --porcelain packages/types/)" ]; then
            echo "Type generation produced changes. Please run 'make generate-types' and commit."
            git diff packages/types/
            exit 1
          fi

  # Job 2: Backend lint and build
  backend:
    runs-on: ubuntu-latest
    needs: types
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "backend/uv.lock"

      - name: Install and lint
        run: |
          cd backend
          uv sync
          uv run ruff check .
          uv run ruff format --check .

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions
          service_account: github-actions@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push backend image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/backend:${{ github.sha }} ./backend
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/backend:${{ github.sha }}

      - name: Deploy backend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/backend:${{ github.sha }}

  # Job 3: Frontend lint and build
  frontend:
    runs-on: ubuntu-latest
    needs: [types, backend] # Backend must deploy first for API URL
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install and lint
        run: |
          bun install
          cd frontend
          bun run lint

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions
          service_account: github-actions@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push frontend image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ steps.backend-url.outputs.url }} \
            -f frontend/Dockerfile \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend:${{ github.sha }} \
            .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend:${{ github.sha }}

      - name: Deploy frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend:${{ github.sha }}

  # Job 4: Run database migrations
  migrate:
    runs-on: ubuntu-latest
    needs: backend
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions
          service_account: github-actions@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Run migrations via Cloud Run job
        run: |
          gcloud run jobs execute holmes-migrate --region=${{ env.REGION }} --wait
        continue-on-error: true # First deploy won't have job yet

  # Job 5: Verify deployment
  verify:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions
          service_account: github-actions@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get service URLs
        id: urls
        run: |
          BACKEND_URL=$(gcloud run services describe holmes-backend --region=${{ env.REGION }} --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe holmes-frontend --region=${{ env.REGION }} --format='value(status.url)')
          echo "backend=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Verify backend health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.backend }}/health)
          if [ "$STATUS" != "200" ]; then
            echo "Backend health check failed with status $STATUS"
            exit 1
          fi
          echo "Backend healthy at ${{ steps.urls.outputs.backend }}"

      - name: Verify frontend
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.frontend }})
          if [ "$STATUS" != "200" ]; then
            echo "Frontend health check failed with status $STATUS"
            exit 1
          fi
          echo "Frontend healthy at ${{ steps.urls.outputs.frontend }}"

      - name: Output URLs
        run: |
          echo "## Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ steps.urls.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ steps.urls.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
