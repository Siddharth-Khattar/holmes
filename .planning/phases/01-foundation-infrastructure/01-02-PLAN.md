---
phase: 01-foundation-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - terraform/main.tf
  - terraform/variables.tf
  - terraform/outputs.tf
  - terraform/cloud-run.tf
  - terraform/cloud-sql.tf
  - terraform/gcs.tf
  - terraform/iam.tf
  - terraform/artifact-registry.tf
autonomous: false

must_haves:
  truths:
    - "terraform init succeeds without errors"
    - "terraform plan shows resources to create"
    - "After terraform apply, Cloud SQL instance exists"
    - "After terraform apply, GCS bucket exists"
    - "After terraform apply, WIF pool exists for GitHub Actions"
  artifacts:
    - path: "terraform/main.tf"
      provides: "Terraform provider and API configuration"
      contains: "google-beta"
    - path: "terraform/cloud-sql.tf"
      provides: "PostgreSQL database instance"
      contains: "google_sql_database_instance"
    - path: "terraform/gcs.tf"
      provides: "Evidence storage bucket"
      contains: "google_storage_bucket"
    - path: "terraform/iam.tf"
      provides: "Workload Identity Federation for CI/CD"
      contains: "workload_identity_pool"
    - path: "terraform/cloud-run.tf"
      provides: "Cloud Run service definitions"
      contains: "google_cloud_run_v2_service"
  key_links:
    - from: "terraform/cloud-run.tf"
      to: "terraform/cloud-sql.tf"
      via: "Cloud SQL connection"
      pattern: "cloud_sql_instance"
    - from: "terraform/iam.tf"
      to: "terraform/cloud-run.tf"
      via: "Service account binding"
      pattern: "google_service_account"
---

<objective>
Create Terraform infrastructure configuration for GCP resources.

Purpose: Defines all cloud infrastructure (Cloud Run, Cloud SQL, GCS, IAM) as code for reproducible deployments.
Output: Complete Terraform configuration ready to provision GCP resources.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Terraform base configuration</name>
  <files>
    - terraform/main.tf
    - terraform/variables.tf
    - terraform/outputs.tf
  </files>
  <action>
Create terraform directory and base files:

1. terraform/main.tf:
- Terraform version constraint >= 1.9
- Google provider v6.x and google-beta provider
- Required APIs to enable:
  - run.googleapis.com
  - sqladmin.googleapis.com
  - storage.googleapis.com
  - artifactregistry.googleapis.com
  - iam.googleapis.com
  - iamcredentials.googleapis.com
  - cloudresourcemanager.googleapis.com
- Local state (no backend - hackathon mode per CONTEXT.md)

2. terraform/variables.tf:
- project_id (string, required)
- region (string, default: "europe-west3" per CONTEXT.md)
- github_org (string, required - for WIF restriction)
- github_repo (string, required - for WIF restriction)
- environment (string, default: "prod")

3. terraform/outputs.tf:
- backend_url (Cloud Run backend URL)
- frontend_url (Cloud Run frontend URL)
- database_connection_name (Cloud SQL connection string)
- bucket_name (GCS bucket name)
- workload_identity_provider (WIF provider for GitHub Actions)
- github_actions_service_account_email (for CI/CD)
  </action>
  <verify>
- cd terraform && terraform init succeeds
- terraform validate passes
  </verify>
  <done>
Terraform base configuration is valid and initialized.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Cloud SQL and GCS resources</name>
  <files>
    - terraform/cloud-sql.tf
    - terraform/gcs.tf
  </files>
  <action>
1. terraform/cloud-sql.tf (from 01-RESEARCH.md patterns):
- google_sql_database_instance "main":
  - name: "holmes-db"
  - database_version: "POSTGRES_17" (per REQUIREMENTS.md)
  - region: var.region
  - tier: "db-f1-micro" (cheapest per CONTEXT.md)
  - No automatic backups (per CONTEXT.md)
  - deletion_protection: false (hackathon mode)
- google_sql_database "holmes"
- google_sql_user "backend" with random_password
- random_password resource for DB password (32 chars, no special)

2. terraform/gcs.tf (from 01-RESEARCH.md patterns):
- google_storage_bucket "evidence":
  - name: "${var.project_id}-evidence"
  - location: var.region
  - uniform_bucket_level_access: true
  - force_destroy: true (hackathon mode)
  - CORS configuration for frontend uploads
  - 30-day lifecycle rule for cleanup
  </action>
  <verify>
- terraform validate passes with these files
- terraform plan shows Cloud SQL instance, database, user, and GCS bucket
  </verify>
  <done>
Cloud SQL PostgreSQL and GCS bucket resources are defined.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create IAM, Artifact Registry, and Cloud Run resources</name>
  <files>
    - terraform/iam.tf
    - terraform/artifact-registry.tf
    - terraform/cloud-run.tf
  </files>
  <action>
1. terraform/iam.tf (from 01-RESEARCH.md WIF pattern):
- google_iam_workload_identity_pool "github"
- google_iam_workload_identity_pool_provider "github_actions":
  - OIDC configuration for GitHub
  - attribute_condition restricts to github_org
  - Attribute mapping for repository, actor
- google_service_account "github_actions" for CI/CD
- google_service_account_iam_binding for WIF user
- IAM bindings for github_actions SA:
  - roles/run.admin
  - roles/artifactregistry.writer
  - roles/iam.serviceAccountUser
- google_service_account "backend" for Cloud Run backend
- google_service_account "frontend" for Cloud Run frontend
- IAM bindings for backend SA:
  - roles/cloudsql.client
  - roles/storage.objectAdmin on evidence bucket

2. terraform/artifact-registry.tf:
- google_artifact_registry_repository "holmes":
  - format: DOCKER
  - location: var.region

3. terraform/cloud-run.tf (from 01-RESEARCH.md pattern):
- google_cloud_run_v2_service "backend":
  - min_instance_count: 0
  - max_instance_count: 10
  - Container port 8080
  - Cloud SQL volume mount
  - Environment: DATABASE_URL, PYTHONUNBUFFERED=1, GCS_BUCKET
  - timeout: 300s for SSE
  - Service account: backend SA
- google_cloud_run_v2_service "frontend":
  - Similar config, port 3000
  - Environment: NEXT_PUBLIC_API_URL pointing to backend
- google_cloud_run_v2_service_iam_member for public access (allUsers invoker)
  </action>
  <verify>
- terraform validate passes
- terraform plan shows all resources (WIF pool, SAs, Artifact Registry, Cloud Run services)
  </verify>
  <done>
Complete Terraform configuration for IAM, Artifact Registry, and Cloud Run is ready.
  </done>
</task>

</tasks>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Terraform configuration for GCP infrastructure</what-built>
  <how-to-verify>
1. Review terraform plan output for expected resources:
   - 1 Cloud SQL instance (db-f1-micro, PostgreSQL 17)
   - 1 GCS bucket
   - 1 Artifact Registry repository
   - 2 Cloud Run services (backend, frontend)
   - 1 Workload Identity Pool with GitHub provider
   - 3 Service accounts (github-actions, backend, frontend)

2. Verify WIF restriction includes correct GitHub org/repo

3. If ready to provision, run: terraform apply
   (Note: This will create billable GCP resources)

4. After apply, verify outputs show:
   - backend_url
   - frontend_url
   - workload_identity_provider
  </how-to-verify>
  <resume-signal>Type "infrastructure provisioned" after terraform apply succeeds, or describe issues</resume-signal>
</checkpoint>

<verification>
1. terraform init succeeds
2. terraform validate passes
3. terraform plan shows expected resource count
4. After apply: gcloud run services list shows holmes-backend and holmes-frontend
5. After apply: gcloud sql instances list shows holmes-db
6. After apply: gsutil ls shows evidence bucket
</verification>

<success_criteria>
- All Terraform files pass validation
- terraform plan shows complete resource graph
- After terraform apply (user-initiated):
  - Cloud SQL instance is RUNNABLE
  - GCS bucket exists and is accessible
  - Cloud Run services exist (will show unhealthy until images deployed)
  - WIF pool exists for GitHub Actions
  - Artifact Registry repository exists
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md`
</output>
