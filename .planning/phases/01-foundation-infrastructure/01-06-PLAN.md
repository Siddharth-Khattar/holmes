---
phase: 01-foundation-infrastructure
plan: 06
type: execute
wave: 3
depends_on: ["01-02", "01-04", "01-05"]
files_modified:
  - .github/workflows/deploy.yml
autonomous: false

user_setup:
  - service: gcp
    why: "Terraform needs GCP project and credentials"
    env_vars:
      - name: GCP_PROJECT_ID
        source: "GCP Console -> Project selector -> Copy project ID"
      - name: GCP_PROJECT_NUMBER
        source: "GCP Console -> Project settings -> Project number"
    dashboard_config:
      - task: "Create new GCP project (if not done)"
        location: "console.cloud.google.com -> Create Project"
      - task: "Enable billing"
        location: "GCP Console -> Billing"
  - service: github
    why: "Workflow needs repository variables for WIF"
    env_vars:
      - name: GCP_PROJECT_ID (as repo variable)
        source: "Same as above"
      - name: GCP_PROJECT_NUMBER (as repo variable)
        source: "Same as above"
    dashboard_config:
      - task: "Add repository variables"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> Variables tab"

must_haves:
  truths:
    - "Push to main branch triggers GitHub Actions workflow"
    - "Workflow authenticates to GCP via Workload Identity Federation"
    - "Backend Docker image is built and pushed to Artifact Registry"
    - "Frontend Docker image is built and pushed to Artifact Registry"
    - "Cloud Run services are updated with new images"
    - "/health endpoint returns 200 from Cloud Run URL"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline configuration"
      contains: "google-github-actions/auth"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "terraform/iam.tf"
      via: "Workload Identity Federation"
      pattern: "workload_identity_provider"
    - from: ".github/workflows/deploy.yml"
      to: "backend/Dockerfile"
      via: "Docker build"
      pattern: "docker build"
---

<objective>
Create GitHub Actions CI/CD pipeline with Workload Identity Federation authentication to GCP.

Purpose: Enables automated deployment on push to main, completing the infrastructure foundation.
Output: Working CI/CD pipeline that builds and deploys both services to Cloud Run.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md (for Terraform outputs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions deployment workflow</name>
  <files>
    - .github/workflows/deploy.yml
  </files>
  <action>
Create .github/workflows/deploy.yml with comprehensive CI/CD pipeline:

```yaml
name: Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

env:
  REGION: europe-west3
  BACKEND_SERVICE: holmes-backend
  FRONTEND_SERVICE: holmes-frontend

jobs:
  # Job 1: Type generation check
  types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          bun install
          cd backend && uv sync

      - name: Generate types
        run: make generate-types

      - name: Check for uncommitted type changes
        run: |
          if [ -n "$(git status --porcelain packages/types/)" ]; then
            echo "Type generation produced changes. Please run 'make generate-types' and commit."
            git diff packages/types/
            exit 1
          fi

  # Job 2: Backend lint and build
  backend:
    runs-on: ubuntu-latest
    needs: types
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install and lint
        run: |
          cd backend
          uv sync
          uv run ruff check .
          uv run ruff format --check .

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push backend image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/backend:${{ github.sha }} ./backend
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/backend:${{ github.sha }}

      - name: Deploy backend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/backend:${{ github.sha }}

  # Job 3: Frontend lint and build
  frontend:
    runs-on: ubuntu-latest
    needs: [types, backend]  # Backend must deploy first for API URL
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install and lint
        run: |
          bun install
          cd frontend
          bun run lint

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push frontend image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ steps.backend-url.outputs.url }} \
            -f frontend/Dockerfile \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend:${{ github.sha }} \
            .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend:${{ github.sha }}

      - name: Deploy frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend:${{ github.sha }}

  # Job 4: Run database migrations
  migrate:
    runs-on: ubuntu-latest
    needs: backend
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions

      - name: Run migrations via Cloud Run job
        run: |
          gcloud run jobs execute holmes-migrate --region=${{ env.REGION }} --wait
        continue-on-error: true  # First deploy won't have job yet

  # Job 5: Verify deployment
  verify:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get service URLs
        id: urls
        run: |
          BACKEND_URL=$(gcloud run services describe holmes-backend --region=${{ env.REGION }} --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe holmes-frontend --region=${{ env.REGION }} --format='value(status.url)')
          echo "backend=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Verify backend health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.backend }}/health)
          if [ "$STATUS" != "200" ]; then
            echo "Backend health check failed with status $STATUS"
            exit 1
          fi
          echo "Backend healthy at ${{ steps.urls.outputs.backend }}"

      - name: Verify frontend
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.urls.outputs.frontend }})
          if [ "$STATUS" != "200" ]; then
            echo "Frontend health check failed with status $STATUS"
            exit 1
          fi
          echo "Frontend healthy at ${{ steps.urls.outputs.frontend }}"

      - name: Output URLs
        run: |
          echo "## Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ steps.urls.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ steps.urls.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
```
  </action>
  <verify>
- .github/workflows/deploy.yml exists with valid YAML syntax
- GitHub Actions shows workflow in Actions tab (after push)
  </verify>
  <done>
GitHub Actions workflow created with WIF authentication, Docker builds, and Cloud Run deployment.
  </done>
</task>

</tasks>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CI/CD pipeline with GitHub Actions and Workload Identity Federation</what-built>
  <how-to-verify>
Before the workflow can run successfully, you need to:

1. **Verify Terraform has been applied** (from Plan 02):
   - Run `terraform output` in terraform directory
   - Note the workload_identity_provider value

2. **Add GitHub repository variables**:
   - Go to: GitHub repo -> Settings -> Secrets and variables -> Actions -> Variables tab
   - Add variable: GCP_PROJECT_ID = (your project ID)
   - Add variable: GCP_PROJECT_NUMBER = (your project number)

3. **Wait for WIF propagation** (if just created):
   - IAM changes take up to 5 minutes to propagate
   - First deployment attempt may fail; retry after 5 minutes

4. **Trigger the workflow**:
   - Push to main branch, OR
   - Go to Actions tab -> Deploy to Cloud Run -> Run workflow

5. **Verify deployment**:
   - All jobs should pass (types, backend, frontend, verify)
   - Check job summary for deployment URLs
   - Visit backend URL + /health (should return 200)
   - Visit frontend URL (should show Holmes home page)

6. **Verify database connection**:
   - Visit backend URL + /health/db
   - Should show database: "connected"
  </how-to-verify>
  <resume-signal>Type "deployment verified" with the Cloud Run URLs, or describe any issues</resume-signal>
</checkpoint>

<verification>
1. Workflow file exists: `.github/workflows/deploy.yml`
2. Workflow appears in GitHub Actions tab
3. After push to main: All jobs complete successfully
4. Backend health: `curl https://holmes-backend-xxx.run.app/health` returns 200
5. Frontend loads: `https://holmes-frontend-xxx.run.app` shows home page
6. Database connected: `/health/db` shows connected status
</verification>

<success_criteria>
- GitHub Actions workflow triggers on push to main
- WIF authentication works (no service account key needed)
- Both Docker images built and pushed to Artifact Registry
- Both Cloud Run services updated with new revisions
- /health endpoint returns 200 with status: healthy
- /health/db shows database connected
- Frontend home page loads from Cloud Run URL
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-06-SUMMARY.md`
</output>
