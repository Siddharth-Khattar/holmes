---
phase: 02-authentication-case-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/auth.py
  - backend/app/models/case.py
  - backend/app/models/__init__.py
  - backend/app/api/auth.py
  - backend/app/main.py
  - backend/alembic/versions/XXXXXX_add_auth_case_tables.py
  - backend/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "FastAPI can validate Better Auth sessions from cookies"
    - "Database has user, session, account, verification, jwks tables"
    - "Database has cases table with user_id foreign key"
    - "Unauthenticated requests to protected endpoints return 401"
  artifacts:
    - path: "backend/app/models/auth.py"
      provides: "SQLAlchemy models for Better Auth tables (read-only)"
      contains: "class User"
    - path: "backend/app/models/case.py"
      provides: "Case model with status enum and user relationship"
      contains: "class Case"
    - path: "backend/app/api/auth.py"
      provides: "get_current_user dependency for session validation"
      exports: ["get_current_user", "CurrentUser"]
    - path: "backend/alembic/versions"
      provides: "Migration for auth and case tables"
  key_links:
    - from: "backend/app/api/auth.py"
      to: "backend/app/models/auth.py"
      via: "Session and User model imports"
      pattern: "from app.models.auth import"
---

<objective>
Set up backend authentication infrastructure for Better Auth session validation and case model.

Purpose: FastAPI needs to validate sessions created by Better Auth in Next.js and enforce case ownership.
Output: Database models for auth tables (read-only), Case model, session validation dependency, and Alembic migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-case-shell/02-CONTEXT.md
@.planning/phases/02-authentication-case-shell/02-RESEARCH.md
@backend/app/database.py
@backend/app/models/base.py
@backend/app/config.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth models and session validation dependency</name>
  <files>
    backend/app/models/auth.py
    backend/app/api/auth.py
    backend/app/models/__init__.py
    backend/pyproject.toml
  </files>
  <action>
1. Add PyJWT to pyproject.toml dependencies (required for potential future JWT verification):
   ```
   "PyJWT>=2.10.0",
   ```

2. Create `backend/app/models/auth.py` with SQLAlchemy models matching Better Auth schema (READ-ONLY, these tables are managed by Better Auth):
   - User: id (TEXT PK), name, email (UNIQUE), email_verified, image, created_at, updated_at
   - Session: id (TEXT PK), user_id (FK), token (UNIQUE), expires_at, ip_address, user_agent, created_at, updated_at
   - Account: id (TEXT PK), user_id (FK), account_id, provider_id, access_token, refresh_token, access_token_expires_at, refresh_token_expires_at, scope, id_token, password, created_at, updated_at
   - Verification: id (TEXT PK), identifier, value, expires_at, created_at, updated_at
   - Jwks: id (TEXT PK), public_key, private_key, created_at

   Notes:
   - Use `mapped_column(String)` for TEXT columns
   - All tables have `__tablename__` matching Better Auth defaults (lowercase: user, session, account, verification, jwks)
   - Mark with docstring: "Read-only models for Better Auth tables"

3. Create `backend/app/api/auth.py` with session validation:
   ```python
   async def get_current_user(
       request: Request,
       db: Annotated[AsyncSession, Depends(get_db)],
   ) -> User:
   ```
   - Read session token from cookie named "better-auth.session_token"
   - Query Session table where token matches AND expires_at > now (UTC timezone-aware)
   - Query User by session.user_id
   - Raise HTTPException 401 if missing/expired/invalid
   - Export `CurrentUser = Annotated[User, Depends(get_current_user)]`

4. Update `backend/app/models/__init__.py` to export all models:
   ```python
   from app.models.auth import User, Session, Account, Verification, Jwks
   __all__ = ["Base", "User", "Session", "Account", "Verification", "Jwks"]
   ```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && python -c "from app.models import User, Session; from app.api.auth import get_current_user, CurrentUser; print('Models and auth imported successfully')"
  </verify>
  <done>Auth models and session validation dependency exist and import without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create Case model and database migration</name>
  <files>
    backend/app/models/case.py
    backend/app/models/__init__.py
    backend/alembic/versions/XXXXXX_add_auth_case_tables.py
  </files>
  <action>
1. Create `backend/app/models/case.py`:
   - CaseStatus enum: DRAFT, PROCESSING, READY, ERROR (using Python enum.Enum and SQLAlchemy Enum type)
   - CaseType enum: FRAUD, CORPORATE, CIVIL, CRIMINAL, OTHER
   - Case model:
     - id: UUID (gen_random_uuid default)
     - user_id: String (FK to "user".id, NOT NULL, ON DELETE CASCADE)
     - name: String(100) NOT NULL
     - description: Text (optional)
     - type: CaseType (default OTHER)
     - status: CaseStatus (default DRAFT)
     - file_count: Integer (default 0)
     - created_at: DateTime with timezone (default now)
     - updated_at: DateTime with timezone (default now, onupdate=now)
     - deleted_at: DateTime with timezone (nullable, for soft delete)

   Add relationship to User: `user = relationship("User", back_populates=None)` (no backref since User is read-only)

   Add indexes:
   - idx_cases_user_id on user_id
   - Partial index on deleted_at WHERE deleted_at IS NULL (for active cases query)

2. Update `backend/app/models/__init__.py` to include Case:
   ```python
   from app.models.case import Case, CaseStatus, CaseType
   __all__ = [..., "Case", "CaseStatus", "CaseType"]
   ```

3. Generate Alembic migration:
   ```bash
   cd backend && alembic revision --autogenerate -m "add auth and case tables"
   ```

   Review the generated migration and ensure:
   - Auth tables (user, session, account, verification, jwks) are created
   - cases table is created with proper foreign key to user
   - Enum types are created (case_status, case_type)
   - Indexes are included

   Note: DO NOT apply the migration yet. Better Auth will manage auth tables; we need to coordinate with frontend setup. The migration is for schema documentation and for cases table only in practice.
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && python -c "from app.models import Case, CaseStatus, CaseType; print(f'Case model ready with status: {list(CaseStatus)}')"
  </verify>
  <done>Case model created with status/type enums, migration generated (not applied)</done>
</task>

<task type="auto">
  <name>Task 3: Register auth router and add settings</name>
  <files>
    backend/app/main.py
    backend/app/config.py
  </files>
  <action>
1. Update `backend/app/config.py` to add frontend URL setting:
   ```python
   frontend_url: str = "http://localhost:3000"  # For JWKS endpoint if needed later
   ```

2. Create a simple test endpoint in `backend/app/api/auth.py` to verify auth works:
   ```python
   from fastapi import APIRouter

   router = APIRouter(prefix="/api/auth", tags=["auth"])

   @router.get("/me")
   async def get_me(current_user: CurrentUser) -> dict:
       """Return current authenticated user info."""
       return {
           "id": current_user.id,
           "name": current_user.name,
           "email": current_user.email,
           "image": current_user.image,
       }
   ```

3. Update `backend/app/main.py` to include auth router:
   ```python
   from app.api import auth
   app.include_router(auth.router, tags=["auth"])
   ```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && ruff check app/ && python -c "from app.main import app; print('App configured with auth router')"
  </verify>
  <done>Auth router registered, /api/auth/me endpoint ready to test authenticated requests</done>
</task>

</tasks>

<verification>
1. All imports work: `python -c "from app.models import User, Session, Case; from app.api.auth import CurrentUser"`
2. Ruff passes: `ruff check app/`
3. Migration file exists in alembic/versions/
4. FastAPI app includes auth router
</verification>

<success_criteria>
- SQLAlchemy models exist for User, Session, Account, Verification, Jwks (read-only)
- Case model exists with proper enums and user foreign key
- get_current_user dependency validates sessions from cookies
- Alembic migration generated (not applied - frontend needs to init Better Auth first)
- /api/auth/me endpoint exists for testing auth
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-case-shell/02-01-SUMMARY.md`
</output>
