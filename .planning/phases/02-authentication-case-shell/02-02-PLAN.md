---
phase: 02-authentication-case-shell
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/api/cases.py
  - backend/app/schemas/case.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "User can create a new case via POST /api/cases"
    - "User can list their cases via GET /api/cases"
    - "User can delete a case via DELETE /api/cases/{id}"
    - "User cannot access another user's cases"
  artifacts:
    - path: "backend/app/schemas/case.py"
      provides: "Pydantic schemas for case CRUD operations"
      exports: ["CaseCreate", "CaseResponse", "CaseListResponse"]
    - path: "backend/app/api/cases.py"
      provides: "Case CRUD endpoints with user ownership enforcement"
      exports: ["router"]
  key_links:
    - from: "backend/app/api/cases.py"
      to: "backend/app/api/auth.py"
      via: "CurrentUser dependency"
      pattern: "current_user: CurrentUser"
    - from: "backend/app/api/cases.py"
      to: "backend/app/models/case.py"
      via: "Case model for database operations"
      pattern: "from app.models import Case"
---

<objective>
Implement case CRUD API endpoints with user ownership enforcement.

Purpose: Enable creating, listing, and deleting cases. All operations are scoped to the authenticated user.
Output: FastAPI router with /api/cases endpoints and Pydantic schemas.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication-case-shell/02-CONTEXT.md
@.planning/phases/02-authentication-case-shell/02-RESEARCH.md
@.planning/REQUIREMENTS.md (REQ-CASE-001, REQ-CASE-002, REQ-CASE-003)
@backend/app/models/case.py
@backend/app/api/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic schemas for case operations</name>
  <files>
    backend/app/schemas/case.py
  </files>
  <action>
Create `backend/app/schemas/case.py` with the following schemas:

1. CaseCreate (request body for POST /api/cases):
   - name: str (min 3 chars, max 100 chars)
   - description: str | None = None (max 5000 chars)
   - type: CaseType = CaseType.OTHER

2. CaseResponse (response model for single case):
   - id: UUID
   - name: str
   - description: str | None
   - type: CaseType
   - status: CaseStatus
   - file_count: int
   - created_at: datetime
   - updated_at: datetime

   Use `model_config = ConfigDict(from_attributes=True)` for SQLAlchemy compatibility.

3. CaseListResponse (response for GET /api/cases):
   - cases: list[CaseResponse]
   - total: int
   - page: int
   - per_page: int

4. CaseListQuery (query params for GET /api/cases):
   - page: int = 1 (ge=1)
   - per_page: int = 20 (ge=1, le=100)
   - sort_by: Literal["name", "created_at", "updated_at", "status"] = "updated_at"
   - sort_order: Literal["asc", "desc"] = "desc"

Import enums from app.models.case.
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && python -c "from app.schemas.case import CaseCreate, CaseResponse, CaseListResponse; print('Case schemas imported successfully')"
  </verify>
  <done>Pydantic schemas for case CRUD operations created with validation</done>
</task>

<task type="auto">
  <name>Task 2: Implement case CRUD endpoints</name>
  <files>
    backend/app/api/cases.py
    backend/app/main.py
  </files>
  <action>
1. Create `backend/app/api/cases.py`:

```python
# ABOUTME: Case CRUD API endpoints with user ownership enforcement.
# ABOUTME: All case operations are scoped to the authenticated user.

from typing import Annotated
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Query, status
from sqlalchemy import func, select
from sqlalchemy.ext.asyncio import AsyncSession

from app.api.auth import CurrentUser
from app.database import get_db
from app.models import Case, CaseStatus
from app.schemas.case import (
    CaseCreate,
    CaseListQuery,
    CaseListResponse,
    CaseResponse,
)

router = APIRouter(prefix="/api/cases", tags=["cases"])
```

2. POST /api/cases - Create case:
   - Accept CaseCreate body
   - Create Case with user_id from CurrentUser
   - Return CaseResponse with 201 status

3. GET /api/cases - List user's cases:
   - Accept CaseListQuery as query params
   - Query cases WHERE user_id = current_user.id AND deleted_at IS NULL
   - Apply sorting based on sort_by and sort_order
   - Paginate results
   - Return CaseListResponse with total count

4. GET /api/cases/{case_id} - Get single case:
   - Query case by id WHERE user_id = current_user.id AND deleted_at IS NULL
   - Raise 404 if not found
   - Return CaseResponse

5. DELETE /api/cases/{case_id} - Soft delete case:
   - Query case by id WHERE user_id = current_user.id AND deleted_at IS NULL
   - Raise 404 if not found
   - Set deleted_at = now()
   - Return 204 No Content

Important: Always filter by user_id to prevent cross-user access (REQ-AUTH-004).

6. Update `backend/app/main.py` to include cases router:
   ```python
   from app.api import cases
   app.include_router(cases.router)
   ```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && ruff check app/ && python -c "from app.main import app; routes = [r.path for r in app.routes if hasattr(r, 'path')]; assert '/api/cases' in str(routes); print('Cases router registered')"
  </verify>
  <done>Case CRUD endpoints implemented with user ownership enforcement</done>
</task>

<task type="auto">
  <name>Task 3: Add case update endpoint</name>
  <files>
    backend/app/schemas/case.py
    backend/app/api/cases.py
  </files>
  <action>
1. Add CaseUpdate schema to `backend/app/schemas/case.py`:
   - name: str | None = None (min 3, max 100 if provided)
   - description: str | None = None (max 5000 if provided)

   Note: Type and status are not user-editable in Phase 2. Status changes come from processing pipeline.

2. Add PATCH /api/cases/{case_id} endpoint:
   - Query case by id WHERE user_id = current_user.id AND deleted_at IS NULL
   - Raise 404 if not found
   - Update only provided fields (exclude_unset=True)
   - Update updated_at timestamp
   - Return CaseResponse

Ensure the endpoint validates that at least one field is provided (don't allow empty updates).
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && ruff check app/api/cases.py && python -c "from app.schemas.case import CaseUpdate; print('CaseUpdate schema ready')"
  </verify>
  <done>Case update endpoint added with partial update support</done>
</task>

</tasks>

<verification>
1. All schemas import: `python -c "from app.schemas.case import CaseCreate, CaseResponse, CaseListResponse, CaseUpdate"`
2. Ruff passes: `ruff check app/`
3. App includes cases router with all endpoints
4. Mypy passes: `mypy app/api/cases.py --ignore-missing-imports`
</verification>

<success_criteria>
- POST /api/cases creates a case for the authenticated user
- GET /api/cases returns paginated list of user's cases (excludes deleted)
- GET /api/cases/{id} returns single case if owned by user
- PATCH /api/cases/{id} updates case name/description
- DELETE /api/cases/{id} soft-deletes the case
- All endpoints return 401 for unauthenticated requests
- All endpoints return 404 for cases not owned by user (no 403 to avoid enumeration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-case-shell/02-02-SUMMARY.md`
</output>
