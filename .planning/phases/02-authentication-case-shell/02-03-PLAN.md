---
phase: 02-authentication-case-shell
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/lib/auth.ts
  - frontend/src/lib/auth-client.ts
  - frontend/src/lib/api-client.ts
  - frontend/src/app/api/auth/[...all]/route.ts
  - frontend/src/middleware.ts
  - frontend/.env.local
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OAuth login"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> Same location as client ID"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/callback/google"
        location: "OAuth 2.0 Client ID settings"

must_haves:
  truths:
    - "Better Auth is configured and serving /api/auth/* endpoints"
    - "Email/password and Google OAuth providers are enabled"
    - "JWT plugin enabled with JWKS endpoint at /api/auth/jwks"
    - "Session cookies are set with proper security settings"
    - "Middleware protects /cases/* routes from unauthenticated access"
    - "API client includes JWT token in Authorization header for backend calls"
  artifacts:
    - path: "frontend/src/lib/auth.ts"
      provides: "Better Auth server configuration with JWT plugin"
      contains: "jwt()"
    - path: "frontend/src/lib/auth-client.ts"
      provides: "Client-side auth hooks with JWT client plugin"
      exports: ["signIn", "signUp", "signOut", "useSession", "getToken"]
    - path: "frontend/src/lib/api-client.ts"
      provides: "API client that includes JWT in Authorization header"
      contains: "Authorization"
    - path: "frontend/src/app/api/auth/[...all]/route.ts"
      provides: "API route handler for Better Auth"
      exports: ["GET", "POST"]
    - path: "frontend/src/middleware.ts"
      provides: "Route protection middleware"
      contains: "getSessionCookie"
  key_links:
    - from: "frontend/src/app/api/auth/[...all]/route.ts"
      to: "frontend/src/lib/auth.ts"
      via: "toNextJsHandler import"
      pattern: "import.*auth.*from"
    - from: "frontend/src/lib/api-client.ts"
      to: "frontend/src/lib/auth-client.ts"
      via: "getToken for Authorization header"
      pattern: "authClient.*token"
---

<objective>
Set up Better Auth in Next.js with JWT plugin for cross-origin backend authentication.

Purpose: Enable user authentication with session persistence in PostgreSQL. The JWT plugin exposes a JWKS endpoint that FastAPI uses to verify tokens. API client utility automatically includes JWT in Authorization header for all backend requests.
Output: Better Auth configuration with JWT plugin, API routes, client hooks, route protection middleware, and API client with auth header injection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication-case-shell/02-CONTEXT.md
@.planning/phases/02-authentication-case-shell/02-RESEARCH.md
@frontend/package.json
@frontend/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Better Auth dependencies</name>
  <files>
    frontend/package.json
  </files>
  <action>
Install Better Auth and required dependencies:

```bash
cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun add better-auth pg sonner lucide-react
```

These packages provide:
- better-auth: Core auth library
- pg: PostgreSQL driver for Better Auth database adapter
- sonner: Toast notifications for auth feedback
- lucide-react: Icons for UI components

Note: react-hook-form, @hookform/resolvers, and zod are needed for forms. Install them too:

```bash
cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun add react-hook-form @hookform/resolvers zod
```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && grep "better-auth" package.json && grep "sonner" package.json && grep "react-hook-form" package.json
  </verify>
  <done>Better Auth and form dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create Better Auth server and client configuration with JWT plugin</name>
  <files>
    frontend/src/lib/auth.ts
    frontend/src/lib/auth-client.ts
    frontend/src/lib/api-client.ts
    frontend/src/app/api/auth/[...all]/route.ts
  </files>
  <action>
1. Create `frontend/src/lib/auth.ts` (server-side config with JWT plugin):

```typescript
// ABOUTME: Better Auth server configuration for Next.js with JWT plugin.
// ABOUTME: Handles email/password, Google OAuth, session management, and exposes JWKS endpoint.

import { betterAuth } from "better-auth";
import { nextCookies } from "better-auth/next-js";
import { jwt } from "better-auth/plugins";
import { Pool } from "pg";

export const auth = betterAuth({
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:3000",
  secret: process.env.BETTER_AUTH_SECRET!,

  database: new Pool({
    connectionString: process.env.DATABASE_URL,
  }),

  emailAndPassword: {
    enabled: true,
    minPasswordLength: 8,
    maxPasswordLength: 128,
  },

  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
  },

  account: {
    accountLinking: {
      enabled: true,
      trustedProviders: ["google", "credential"],
    },
  },

  session: {
    expiresIn: 60 * 60 * 24 * 30, // 30 days (no timeout per CONTEXT.md)
    updateAge: 60 * 60 * 24, // Refresh daily
    cookieCache: {
      enabled: true,
      maxAge: 5 * 60, // 5 min cache to reduce DB hits
    },
  },

  plugins: [
    jwt(), // Enables JWKS endpoint at /api/auth/jwks for FastAPI verification
    nextCookies(), // Must be last - enables cookie setting in server actions
  ],
});

export type Session = typeof auth.$Infer.Session;
```

2. Create `frontend/src/lib/auth-client.ts` (client-side hooks with JWT client plugin):

```typescript
// ABOUTME: Better Auth client for React components with JWT support.
// ABOUTME: Provides hooks and functions for auth operations and token retrieval.

import { createAuthClient } from "better-auth/react";
import { jwtClient } from "better-auth/client/plugins";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000",
  plugins: [jwtClient()],
});

export const { signIn, signUp, signOut, useSession } = authClient;

/**
 * Get the current JWT token for API calls.
 * Returns null if not authenticated.
 */
export async function getToken(): Promise<string | null> {
  try {
    const response = await authClient.$fetch("/token", {
      method: "GET",
    });
    return response.data?.token ?? null;
  } catch {
    return null;
  }
}
```

3. Create `frontend/src/lib/api-client.ts` (API client with JWT Authorization header):

```typescript
// ABOUTME: API client for backend requests with JWT Authorization header.
// ABOUTME: Automatically includes Bearer token from Better Auth for all requests.

import { authClient } from "./auth-client";

const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

interface RequestOptions extends Omit<RequestInit, "body"> {
  json?: unknown;
}

export class ApiError extends Error {
  constructor(
    public status: number,
    public statusText: string,
    public data?: unknown
  ) {
    super(`${status} ${statusText}`);
    this.name = "ApiError";
  }
}

async function getAuthToken(): Promise<string | null> {
  try {
    // Use Better Auth's JWT client plugin to get token
    const response = await authClient.$fetch("/token", {
      method: "GET",
    });
    return response.data?.token ?? null;
  } catch {
    return null;
  }
}

async function request<T>(
  endpoint: string,
  options: RequestOptions = {}
): Promise<T> {
  const { json, ...init } = options;

  const headers: HeadersInit = {
    ...init.headers,
  };

  // Get JWT token and add to Authorization header
  const token = await getAuthToken();
  if (token) {
    (headers as Record<string, string>)["Authorization"] = `Bearer ${token}`;
  }

  if (json) {
    (headers as Record<string, string>)["Content-Type"] = "application/json";
  }

  const response = await fetch(`${API_URL}${endpoint}`, {
    ...init,
    headers,
    body: json ? JSON.stringify(json) : undefined,
  });

  if (!response.ok) {
    const data = await response.json().catch(() => null);
    throw new ApiError(response.status, response.statusText, data);
  }

  // Handle 204 No Content
  if (response.status === 204) {
    return undefined as T;
  }

  return response.json();
}

export const api = {
  get: <T>(endpoint: string, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "GET" }),

  post: <T>(endpoint: string, json?: unknown, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "POST", json }),

  patch: <T>(endpoint: string, json?: unknown, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "PATCH", json }),

  delete: <T>(endpoint: string, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "DELETE" }),
};
```

4. Create `frontend/src/app/api/auth/[...all]/route.ts`:

```typescript
// ABOUTME: Better Auth API route handler
// ABOUTME: Catches all /api/auth/* requests including /api/auth/jwks

import { auth } from "@/lib/auth";
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "(error|Error)" | head -20 || echo "TypeScript check passed"
  </verify>
  <done>Better Auth configured with JWT plugin, client with token retrieval, and API client with Authorization header</done>
</task>

<task type="auto">
  <name>Task 3: Create middleware for route protection</name>
  <files>
    frontend/src/middleware.ts
    frontend/.env.local.example
  </files>
  <action>
1. Create `frontend/src/middleware.ts`:

```typescript
// ABOUTME: Edge middleware for route protection
// ABOUTME: Checks session cookie existence before allowing access to protected routes

import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { getSessionCookie } from "better-auth/cookies";

export function middleware(request: NextRequest) {
  const sessionCookie = getSessionCookie(request);
  const { pathname } = request.nextUrl;

  // Protected app routes - redirect to landing if not authenticated
  if (pathname.startsWith("/cases")) {
    if (!sessionCookie) {
      return NextResponse.redirect(new URL("/", request.url));
    }
  }

  // Redirect authenticated users away from auth pages
  if (pathname === "/login") {
    if (sessionCookie) {
      return NextResponse.redirect(new URL("/cases", request.url));
    }
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/cases/:path*", "/login"],
};
```

2. Create `frontend/.env.local.example` with required env vars:

```env
# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/holmes

# Better Auth
BETTER_AUTH_SECRET=generate-a-secure-random-string-here
BETTER_AUTH_URL=http://localhost:3000

# Public URL (accessible in browser)
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:8000

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

Note: Users must copy this to .env.local and fill in real values.
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && test -f src/middleware.ts && echo "Middleware created" && test -f .env.local.example && echo "Env example created"
  </verify>
  <done>Middleware protects /cases/* routes, env example documented</done>
</task>

</tasks>

<verification>
1. Dependencies installed: `grep better-auth package.json`
2. Auth files exist and compile: `npx tsc --noEmit --skipLibCheck`
3. API route exists at src/app/api/auth/[...all]/route.ts
4. Middleware exists at src/middleware.ts
5. API client includes Authorization header with JWT token
6. Env example documents all required variables
</verification>

<success_criteria>
- Better Auth handles /api/auth/* endpoints (signup, signin, signout, jwks, token, etc.)
- JWT plugin enabled - JWKS endpoint available at /api/auth/jwks
- JWT client plugin enabled - token retrieval available via authClient.$fetch("/token")
- Email/password provider enabled with 8+ char password requirement
- Google OAuth configured (needs env vars to actually work)
- Session expires in 30 days, refreshes daily
- Middleware redirects unauthenticated users from /cases/* to /
- Middleware redirects authenticated users from /login to /cases
- API client automatically includes JWT in Authorization header for backend calls
- Client hooks (signIn, signUp, signOut, useSession, getToken) exported
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-case-shell/02-03-SUMMARY.md`
</output>
