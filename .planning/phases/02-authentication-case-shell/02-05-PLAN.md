---
phase: 02-authentication-case-shell
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - frontend/src/app/(app)/layout.tsx
  - frontend/src/components/app/sidebar.tsx
  - frontend/src/components/app/user-menu.tsx
  - frontend/src/hooks/use-logout.ts
  - frontend/src/lib/api-client.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated user sees app shell with sidebar"
    - "Sidebar is collapsed by default, expands on hover"
    - "User menu shows avatar and name"
    - "Logout works and clears session across tabs"
    - "Unauthorized access redirects to landing page"
  artifacts:
    - path: "frontend/src/app/(app)/layout.tsx"
      provides: "App layout with sidebar for authenticated users"
      contains: "Sidebar"
    - path: "frontend/src/components/app/sidebar.tsx"
      provides: "Collapsible sidebar navigation"
      contains: "hover"
    - path: "frontend/src/components/app/user-menu.tsx"
      provides: "User profile dropdown with logout"
      contains: "signOut"
  key_links:
    - from: "frontend/src/app/(app)/layout.tsx"
      to: "frontend/src/lib/auth.ts"
      via: "Server-side session validation"
      pattern: "auth.api.getSession"
    - from: "frontend/src/components/app/user-menu.tsx"
      to: "frontend/src/lib/auth-client.ts"
      via: "signOut for logout"
      pattern: "import.*signOut"
---

<objective>
Create the app shell with collapsible sidebar navigation and user menu.

Purpose: Provide the authenticated app experience with navigation and user controls. Sidebar minimized by default, expands on hover (like Linear, Notion).
Output: App layout with sidebar, user menu, and logout functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication-case-shell/02-CONTEXT.md
@.planning/phases/02-authentication-case-shell/02-RESEARCH.md
@DOCS/UI/DESIGN-SYSTEM.md
@frontend/src/lib/auth.ts
@frontend/src/lib/auth-client.ts
@frontend/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client for backend requests</name>
  <files>
    frontend/src/lib/api-client.ts
  </files>
  <action>
Create `frontend/src/lib/api-client.ts` for making authenticated requests to the FastAPI backend:

```typescript
// ABOUTME: API client for backend requests with auth cookie handling
// ABOUTME: All requests include credentials for session cookie

const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

interface RequestOptions extends RequestInit {
  json?: unknown;
}

class ApiError extends Error {
  constructor(
    public status: number,
    public statusText: string,
    public data?: unknown
  ) {
    super(`${status} ${statusText}`);
    this.name = "ApiError";
  }
}

async function request<T>(
  endpoint: string,
  options: RequestOptions = {}
): Promise<T> {
  const { json, ...init } = options;

  const headers: HeadersInit = {
    ...init.headers,
  };

  if (json) {
    headers["Content-Type"] = "application/json";
  }

  const response = await fetch(`${API_URL}${endpoint}`, {
    ...init,
    headers,
    credentials: "include", // Important: sends session cookie
    body: json ? JSON.stringify(json) : init.body,
  });

  if (!response.ok) {
    const data = await response.json().catch(() => null);
    throw new ApiError(response.status, response.statusText, data);
  }

  // Handle 204 No Content
  if (response.status === 204) {
    return undefined as T;
  }

  return response.json();
}

export const api = {
  get: <T>(endpoint: string, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "GET" }),

  post: <T>(endpoint: string, json?: unknown, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "POST", json }),

  patch: <T>(endpoint: string, json?: unknown, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "PATCH", json }),

  delete: <T>(endpoint: string, options?: RequestOptions) =>
    request<T>(endpoint, { ...options, method: "DELETE" }),
};

export { ApiError };
```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && npx tsc --noEmit --skipLibCheck src/lib/api-client.ts
  </verify>
  <done>API client with credentials handling created</done>
</task>

<task type="auto">
  <name>Task 2: Create sidebar and user menu components</name>
  <files>
    frontend/src/components/app/sidebar.tsx
    frontend/src/components/app/user-menu.tsx
    frontend/src/hooks/use-logout.ts
  </files>
  <action>
1. Create `frontend/src/hooks/use-logout.ts`:
   - signOut with callback for toast and redirect
   - BroadcastChannel for multi-tab sync
   - Redirect to landing page after logout

```typescript
// ABOUTME: Logout hook with multi-tab sync and feedback
// ABOUTME: Uses BroadcastChannel for cross-tab logout

import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { signOut } from "@/lib/auth-client";

export function useLogout() {
  const router = useRouter();

  const logout = async () => {
    await signOut({
      fetchOptions: {
        onSuccess: () => {
          toast.success("Logged out successfully");

          // Multi-tab sync
          if (typeof window !== "undefined" && "BroadcastChannel" in window) {
            const bc = new BroadcastChannel("auth");
            bc.postMessage({ type: "logout" });
            bc.close();
          }

          router.push("/");
        },
      },
    });
  };

  return { logout };
}
```

2. Create `frontend/src/components/app/user-menu.tsx`:
   - Avatar (user.image or initials fallback)
   - Name display
   - Dropdown with Logout option (Settings page deferred)
   - Use useLogout hook
   - Style: minimal dropdown, bg-jet, border-smoke/10

3. Create `frontend/src/components/app/sidebar.tsx`:
   - Collapsible sidebar: narrow by default (~16px icons + padding), expands on hover (~240px)
   - Logo at top (Holmes "H" or magnifying glass icon)
   - Navigation items with icons:
     - Cases (Briefcase icon) - links to /cases
     - (Future items placeholder)
   - Active indicator for current route
   - UserMenu at bottom
   - Transition: smooth expand/collapse (0.2s ease)

   Minimized state:
   - Just icons visible
   - Tooltip shows label on icon hover (optional enhancement)

   Expanded state:
   - Icons + labels visible
   - Full user menu visible

   Styling (per DESIGN-SYSTEM.md):
   - bg-jet or bg-charcoal for sidebar
   - text-stone for inactive items
   - text-smoke for active items
   - Subtle border on right edge
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && test -f src/components/app/sidebar.tsx && test -f src/components/app/user-menu.tsx && test -f src/hooks/use-logout.ts && echo "App components created"
  </verify>
  <done>Sidebar with hover-expand and user menu with logout created</done>
</task>

<task type="auto">
  <name>Task 3: Create app layout with server-side auth</name>
  <files>
    frontend/src/app/(app)/layout.tsx
  </files>
  <action>
Create `frontend/src/app/(app)/layout.tsx`:

```typescript
// ABOUTME: App layout for authenticated users
// ABOUTME: Validates session server-side and renders sidebar shell

import { headers } from "next/headers";
import { redirect } from "next/navigation";
import { Toaster } from "sonner";

import { auth } from "@/lib/auth";
import { Sidebar } from "@/components/app/sidebar";

export default async function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  // Double-check auth (middleware is first line, this is defense-in-depth)
  if (!session) {
    redirect("/");
  }

  return (
    <div className="flex min-h-screen bg-charcoal">
      <Sidebar user={session.user} />
      <main className="flex-1 overflow-auto">
        <Toaster
          position="top-right"
          toastOptions={{
            style: {
              background: "var(--color-jet)",
              color: "var(--color-smoke)",
              border: "1px solid rgba(248, 247, 244, 0.1)",
            },
          }}
        />
        {children}
      </main>
    </div>
  );
}
```

Also add a multi-tab listener in the layout (or create a client component wrapper):

Create `frontend/src/components/app/auth-listener.tsx`:
```typescript
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

export function AuthListener() {
  const router = useRouter();

  useEffect(() => {
    if (typeof window === "undefined" || !("BroadcastChannel" in window)) return;

    const bc = new BroadcastChannel("auth");
    bc.onmessage = (event) => {
      if (event.data?.type === "logout") {
        router.push("/");
        router.refresh();
      }
    };

    return () => bc.close();
  }, [router]);

  return null;
}
```

Include AuthListener in the app layout.
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && test -f "src/app/(app)/layout.tsx" && echo "App layout created"
  </verify>
  <done>App layout with sidebar, auth validation, and multi-tab sync created</done>
</task>

</tasks>

<verification>
1. All components created in src/components/app/
2. App layout validates session server-side
3. TypeScript compiles: npx tsc --noEmit --skipLibCheck
4. Dev server: authenticated user sees sidebar, unauthenticated redirects
</verification>

<success_criteria>
- Authenticated users see app shell with sidebar
- Sidebar collapsed by default (~64px), expands on hover (~240px)
- Navigation shows Cases link with active indicator
- User menu shows avatar + name at sidebar bottom
- Logout clears session, shows toast, redirects to /
- Multi-tab logout sync works (logout in one tab affects all)
- API client sends credentials with all requests
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-case-shell/02-05-SUMMARY.md`
</output>
