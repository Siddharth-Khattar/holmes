---
phase: 02-authentication-case-shell
plan: 07
type: execute
wave: 0
depends_on: []
files_modified:
  - terraform/cloud-run.tf
  - terraform/secrets.tf
  - .github/workflows/deploy.yml
autonomous: true
user_setup:
  - service: google-secret-manager
    why: "Store auth secrets for production"
    env_vars:
      - name: BETTER_AUTH_SECRET
        source: "Generate with: openssl rand -base64 32"
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
    dashboard_config:
      - task: "Create secrets in Secret Manager"
        location: "GCP Console -> Secret Manager -> Create Secret"
      - task: "Add production OAuth redirect URI"
        location: "Google Cloud Console -> OAuth 2.0 Client ID settings"

must_haves:
  truths:
    - "Frontend Cloud Run service has database access via Cloud SQL socket"
    - "Frontend has BETTER_AUTH_SECRET, GOOGLE credentials from Secret Manager"
    - "Frontend has BETTER_AUTH_URL pointing to its own Cloud Run URL"
    - "Backend has FRONTEND_URL env var for JWKS endpoint"
    - "CI/CD runs Alembic migrations after backend deploy"
  artifacts:
    - path: "terraform/cloud-run.tf"
      provides: "Updated frontend service with Cloud SQL and secrets"
      contains: "volume_mounts"
    - path: "terraform/secrets.tf"
      provides: "Secret Manager resources for auth secrets"
      contains: "google_secret_manager_secret"
    - path: ".github/workflows/deploy.yml"
      provides: "Updated CI/CD with migrations and frontend auth env vars"
      contains: "alembic upgrade"
  key_links:
    - from: "terraform/cloud-run.tf"
      to: "terraform/secrets.tf"
      via: "Secret references in env vars"
      pattern: "secret_key_ref"
    - from: ".github/workflows/deploy.yml"
      to: "terraform/cloud-run.tf"
      via: "Deployed services match terraform"
      pattern: "deploy-cloudrun"
---

<objective>
Add deployment infrastructure for Better Auth on Cloud Run.

Purpose: Enable frontend to access PostgreSQL for session storage and retrieve auth secrets from Secret Manager. Enable backend to know frontend URL for JWKS verification. Add Alembic migrations to CI/CD pipeline.
Output: Updated terraform for frontend Cloud SQL access and secrets, CI/CD with migrations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication-case-shell/02-CONTEXT.md
@.planning/phases/02-authentication-case-shell/02-RESEARCH.md
@terraform/cloud-run.tf
@terraform/iam.tf
@terraform/main.tf
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Secret Manager resources for auth secrets</name>
  <files>
    terraform/secrets.tf
  </files>
  <action>
Create `terraform/secrets.tf` with Secret Manager resources:

```hcl
# ABOUTME: Secret Manager resources for authentication secrets.
# ABOUTME: Stores Better Auth secret and Google OAuth credentials.

# Enable Secret Manager API
resource "google_project_service" "secretmanager" {
  project            = var.project_id
  service            = "secretmanager.googleapis.com"
  disable_on_destroy = false
}

# -----------------------------------------------------------------------------
# Secret Definitions
# -----------------------------------------------------------------------------

resource "google_secret_manager_secret" "better_auth_secret" {
  project   = var.project_id
  secret_id = "better-auth-secret"

  replication {
    auto {}
  }

  depends_on = [google_project_service.secretmanager]
}

resource "google_secret_manager_secret" "google_client_id" {
  project   = var.project_id
  secret_id = "google-client-id"

  replication {
    auto {}
  }

  depends_on = [google_project_service.secretmanager]
}

resource "google_secret_manager_secret" "google_client_secret" {
  project   = var.project_id
  secret_id = "google-client-secret"

  replication {
    auto {}
  }

  depends_on = [google_project_service.secretmanager]
}

# -----------------------------------------------------------------------------
# IAM: Allow frontend service account to access secrets
# -----------------------------------------------------------------------------

resource "google_secret_manager_secret_iam_member" "frontend_better_auth" {
  project   = var.project_id
  secret_id = google_secret_manager_secret.better_auth_secret.secret_id
  role      = "roles/secretmanager.secretAccessor"
  member    = "serviceAccount:${google_service_account.frontend.email}"
}

resource "google_secret_manager_secret_iam_member" "frontend_google_client_id" {
  project   = var.project_id
  secret_id = google_secret_manager_secret.google_client_id.secret_id
  role      = "roles/secretmanager.secretAccessor"
  member    = "serviceAccount:${google_service_account.frontend.email}"
}

resource "google_secret_manager_secret_iam_member" "frontend_google_client_secret" {
  project   = var.project_id
  secret_id = google_secret_manager_secret.google_client_secret.secret_id
  role      = "roles/secretmanager.secretAccessor"
  member    = "serviceAccount:${google_service_account.frontend.email}"
}
```

Note: Secret VALUES must be added manually via GCP Console or gcloud CLI. Terraform creates the secret containers only.
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes && test -f terraform/secrets.tf && grep "google_secret_manager_secret" terraform/secrets.tf && echo "Secrets terraform created"
  </verify>
  <done>Secret Manager resources created for auth secrets</done>
</task>

<task type="auto">
  <name>Task 2: Update Cloud Run frontend with database and secrets</name>
  <files>
    terraform/cloud-run.tf
  </files>
  <action>
Update `terraform/cloud-run.tf` frontend service to add:

1. Cloud SQL volume mount (same pattern as backend)
2. DATABASE_URL env var (socket-based for Cloud Run)
3. BETTER_AUTH_SECRET from Secret Manager
4. BETTER_AUTH_URL using frontend Cloud Run URL
5. GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET from Secret Manager
6. Add FRONTEND_URL to backend service for JWKS endpoint

Changes to frontend service:

```hcl
resource "google_cloud_run_v2_service" "frontend" {
  name                = "holmes-frontend"
  location            = var.region
  project             = var.project_id
  deletion_protection = false # Hackathon mode

  template {
    service_account = google_service_account.frontend.email

    scaling {
      min_instance_count = 0
      max_instance_count = 10
    }

    containers {
      image = "${var.region}-docker.pkg.dev/${var.project_id}/${google_artifact_registry_repository.holmes.repository_id}/frontend:latest"

      ports {
        container_port = 3000
      }

      env {
        name  = "NEXT_PUBLIC_API_URL"
        value = "" # Will be updated after backend deploys
      }

      env {
        name  = "NEXT_PUBLIC_VIDEO_URL"
        value = "https://storage.googleapis.com/${google_storage_bucket.media.name}/video.mp4"
      }

      # Database URL for Better Auth (socket-based for Cloud Run)
      env {
        name  = "DATABASE_URL"
        value = "postgresql://${google_sql_user.backend.name}:${random_password.db_password.result}@/${google_sql_database.holmes.name}?host=/cloudsql/${google_sql_database_instance.main.connection_name}"
      }

      # Better Auth URL (set via CI/CD after frontend URL known)
      env {
        name  = "BETTER_AUTH_URL"
        value = "" # Updated by CI/CD
      }

      # Better Auth Secret from Secret Manager
      env {
        name = "BETTER_AUTH_SECRET"
        value_source {
          secret_key_ref {
            secret  = google_secret_manager_secret.better_auth_secret.secret_id
            version = "latest"
          }
        }
      }

      # Google OAuth from Secret Manager
      env {
        name = "GOOGLE_CLIENT_ID"
        value_source {
          secret_key_ref {
            secret  = google_secret_manager_secret.google_client_id.secret_id
            version = "latest"
          }
        }
      }

      env {
        name = "GOOGLE_CLIENT_SECRET"
        value_source {
          secret_key_ref {
            secret  = google_secret_manager_secret.google_client_secret.secret_id
            version = "latest"
          }
        }
      }

      # Cloud SQL volume mount
      volume_mounts {
        name       = "cloudsql"
        mount_path = "/cloudsql"
      }

      resources {
        limits = {
          cpu    = "1"
          memory = "512Mi"
        }
      }
    }

    # Cloud SQL volume
    volumes {
      name = "cloudsql"
      cloud_sql_instance {
        instances = [google_sql_database_instance.main.connection_name]
      }
    }

    timeout = "60s"
  }

  traffic {
    type    = "TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST"
    percent = 100
  }

  depends_on = [
    google_project_service.run,
    google_artifact_registry_repository.holmes,
    google_secret_manager_secret.better_auth_secret,
    google_secret_manager_secret.google_client_id,
    google_secret_manager_secret.google_client_secret,
  ]
}
```

Also add FRONTEND_URL to backend service for JWKS endpoint:

```hcl
# Add this env block to the backend service containers section:
env {
  name  = "FRONTEND_URL"
  value = "" # Updated by CI/CD after frontend deploys
}
```

Also add Cloud SQL client role for frontend service account in iam.tf:

```hcl
resource "google_project_iam_member" "frontend_cloudsql_client" {
  project = var.project_id
  role    = "roles/cloudsql.client"
  member  = "serviceAccount:${google_service_account.frontend.email}"
}
```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes && grep -A5 "BETTER_AUTH_SECRET" terraform/cloud-run.tf && grep "volume_mounts" terraform/cloud-run.tf | head -2 && echo "Frontend Cloud Run updated"
  </verify>
  <done>Frontend Cloud Run service updated with Cloud SQL access and secrets</done>
</task>

<task type="auto">
  <name>Task 3: Update CI/CD with migrations and auth env vars</name>
  <files>
    .github/workflows/deploy.yml
  </files>
  <action>
Update `.github/workflows/deploy.yml` to:

1. Run Alembic migrations after backend deploy (using Cloud SQL proxy)
2. Pass additional build args to frontend Dockerfile for auth URLs
3. Update BETTER_AUTH_URL and FRONTEND_URL after services deploy

Key changes:

1. Update the `migrate` job to actually run migrations (currently just tries to execute a Cloud Run job):

```yaml
  # Job 4: Run database migrations
  migrate:
    runs-on: ubuntu-latest
    needs: backend
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "backend/uv.lock"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions
          service_account: github-actions@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Cloud SQL Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.14.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy

      - name: Get database connection info
        id: db-info
        run: |
          INSTANCE=$(gcloud sql instances list --format='value(connectionName)' --filter='name:holmes*' | head -1)
          echo "instance=$INSTANCE" >> $GITHUB_OUTPUT

      - name: Run migrations
        env:
          DATABASE_URL: postgresql+asyncpg://holmes:${{ secrets.DB_PASSWORD }}@localhost:5432/holmes
        run: |
          # Start Cloud SQL Proxy in background
          ./cloud-sql-proxy --port 5432 ${{ steps.db-info.outputs.instance }} &
          sleep 5

          # Run migrations
          cd backend
          uv sync
          uv run alembic upgrade head

          # Stop proxy
          pkill -f cloud-sql-proxy || true
```

2. Update frontend build to pass BETTER_AUTH_URL:

```yaml
      - name: Get frontend URL
        id: frontend-url
        run: |
          # For initial deploy, use the expected URL pattern
          URL="https://holmes-frontend-${RANDOM_SUFFIX}.${REGION}.run.app"
          # After first deploy, get actual URL
          ACTUAL_URL=$(gcloud run services describe holmes-frontend --region=${{ env.REGION }} --format='value(status.url)' 2>/dev/null || echo "")
          if [ -n "$ACTUAL_URL" ]; then
            URL=$ACTUAL_URL
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/holmes/frontend
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ steps.backend-url.outputs.url }} \
            --build-arg NEXT_PUBLIC_VIDEO_URL=https://storage.googleapis.com/${{ vars.GCP_PROJECT_ID }}-media/video.mp4 \
            --build-arg NEXT_PUBLIC_APP_URL=${{ steps.frontend-url.outputs.url }} \
            --build-arg BETTER_AUTH_URL=${{ steps.frontend-url.outputs.url }} \
            -f frontend/Dockerfile \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:latest \
            .
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest
```

3. Add a job to update Cloud Run env vars after deploy:

```yaml
  # Job 6: Update service env vars
  update-env:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/github-actions
          service_account: github-actions@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get service URLs
        id: urls
        run: |
          BACKEND_URL=$(gcloud run services describe holmes-backend --region=${{ env.REGION }} --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe holmes-frontend --region=${{ env.REGION }} --format='value(status.url)')
          echo "backend=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Update backend FRONTEND_URL
        run: |
          gcloud run services update holmes-backend \
            --region=${{ env.REGION }} \
            --update-env-vars="FRONTEND_URL=${{ steps.urls.outputs.frontend }}"

      - name: Update frontend env vars
        run: |
          gcloud run services update holmes-frontend \
            --region=${{ env.REGION }} \
            --update-env-vars="NEXT_PUBLIC_API_URL=${{ steps.urls.outputs.backend }},BETTER_AUTH_URL=${{ steps.urls.outputs.frontend }}"
```
  </action>
  <verify>
    cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes && grep -q "alembic" .github/workflows/deploy.yml && grep -q "BETTER_AUTH_URL" .github/workflows/deploy.yml && echo "CI/CD updated"
  </verify>
  <done>CI/CD updated with migrations and auth env vars</done>
</task>

</tasks>

<verification>
1. terraform/secrets.tf exists with Secret Manager resources
2. terraform/cloud-run.tf has frontend with Cloud SQL mount and secrets
3. terraform/iam.tf has frontend Cloud SQL client role
4. .github/workflows/deploy.yml runs migrations and sets auth env vars
5. terraform fmt passes: `cd terraform && terraform fmt -check`
</verification>

<success_criteria>
- terraform/secrets.tf creates Secret Manager secrets for BETTER_AUTH_SECRET, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
- Frontend Cloud Run has Cloud SQL volume mount (same as backend)
- Frontend Cloud Run has DATABASE_URL env var pointing to socket
- Frontend Cloud Run has secret references for auth env vars
- Backend Cloud Run has FRONTEND_URL env var
- CI/CD runs Alembic migrations after backend deploy
- CI/CD updates BETTER_AUTH_URL and FRONTEND_URL after services deploy
- All terraform resources have proper depends_on relationships
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-case-shell/02-07-SUMMARY.md`
</output>
