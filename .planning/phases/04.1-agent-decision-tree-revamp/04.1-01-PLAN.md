---
phase: 04.1-agent-decision-tree-revamp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/app/globals.css
  - frontend/src/lib/command-center-config.ts
  - frontend/src/components/CommandCenter/DecisionNode.tsx
autonomous: true

must_haves:
  truths:
    - "Chosen/active nodes display teal glow, pulsing border, floating animation"
    - "Unchosen nodes are muted dark gray with hover brightening"
    - "Each agent type has a subtle hue tint on chosen nodes"
    - "Portal tooltip appears above nodes on hover"
  artifacts:
    - path: "frontend/src/components/CommandCenter/DecisionNode.tsx"
      provides: "Custom ReactFlow node with motion animations and portal tooltip"
      min_lines: 120
    - path: "frontend/src/lib/command-center-config.ts"
      provides: "Updated config without manual positions, with teal color system"
      contains: "cc-accent"
    - path: "frontend/src/app/globals.css"
      provides: "Scoped Command Center CSS variables"
      contains: "command-center-scope"
  key_links:
    - from: "frontend/src/components/CommandCenter/DecisionNode.tsx"
      to: "frontend/src/lib/command-center-config.ts"
      via: "imports AGENT_CONFIGS for node metadata"
      pattern: "AGENT_CONFIGS"
    - from: "frontend/src/app/globals.css"
      to: "frontend/src/components/CommandCenter/DecisionNode.tsx"
      via: "CSS variables consumed in node styles"
      pattern: "cc-accent"
---

<objective>
Install @xyflow/react + dagre dependencies, add scoped teal CSS variables, update command-center-config to remove manual positions and add color system, and build the custom DecisionNode component with all motion animations and portal tooltip.

Purpose: Establish the visual foundation (deps, colors, config) and the core visual element (the node) that Plan 03 will compose into the full ReactFlow canvas.

Output: Working DecisionNode component, updated config, scoped CSS variables, all dependencies installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-agent-decision-tree-revamp/04.1-CONTEXT.md
@.planning/phases/04.1-agent-decision-tree-revamp/04.1-RESEARCH.md
@DOCS/UI/agent-decision-tree-guide.md
@frontend/src/types/command-center.ts
@frontend/src/lib/command-center-config.ts
@frontend/src/app/globals.css
@frontend/src/components/CommandCenter/AgentNode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add scoped CSS variables</name>
  <files>
    frontend/package.json
    frontend/src/app/globals.css
  </files>
  <action>
  **Step 1: Install dependencies.**
  Run in the `frontend/` directory:
  ```bash
  cd frontend && bun add @xyflow/react @dagrejs/dagre && bun add -D @types/dagre
  ```

  **Step 2: Add scoped Command Center CSS variables to `globals.css`.**
  Add the following block AFTER the existing `:root, .dark` block (before the `.light` block). This scoped selector ensures the teal accent does NOT affect the rest of Holmes' warm neutral palette:

  ```css
  /* Command Center scoped accent -- does not affect global Holmes palette */
  .command-center-scope {
    --cc-accent: 180 60% 45%;
    --cc-accent-glow: 180 60% 50%;
    --cc-financial-tint: 140 40% 20%;
    --cc-legal-tint: 220 40% 25%;
    --cc-strategy-tint: 30 40% 22%;
    --cc-evidence-tint: 50 35% 22%;
    --cc-kg-tint: 270 30% 22%;
    --cc-triage-tint: 200 35% 22%;
    --cc-orchestrator-tint: 260 30% 22%;
  }
  ```

  Fine-tune the exact teal hue for best contrast against `--color-jet` (#111111) canvas background. The approximate target is `hsl(180 60% 45%)` but use discretion per CONTEXT.md.

  Do NOT modify any existing CSS variables or rules. Only ADD the new `.command-center-scope` block.
  </action>
  <verify>
  - `bun install` completes without errors in `frontend/`
  - `@xyflow/react`, `@dagrejs/dagre`, and `@types/dagre` appear in `package.json`
  - `globals.css` contains `.command-center-scope` block with `--cc-accent` variable
  - Existing CSS variables are unchanged
  - Run `cd frontend && bun run build` -- no build errors from CSS changes
  </verify>
  <done>
  Dependencies installed. Scoped CSS variables for Command Center teal accent defined in globals.css without affecting existing design system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update command-center-config and create DecisionNode component</name>
  <files>
    frontend/src/lib/command-center-config.ts
    frontend/src/components/CommandCenter/DecisionNode.tsx
  </files>
  <action>
  **Step 1: Update `command-center-config.ts`.**

  The config needs these changes:
  - Remove `AGENT_COLORS` (the warm brown hex values). They are replaced by the scoped CSS variables.
  - Remove `position` from each `AGENT_CONFIGS` entry (dagre computes positions now).
  - Remove `color` from each `AGENT_CONFIGS` entry (CSS variables handle this now).
  - Keep `AGENT_CONFIGS` with `type`, `name`, `description`, `model` fields.
  - Keep `DEFAULT_CONNECTIONS` exactly as-is.
  - Remove `STATUS_COLORS` (replaced by CSS variable-based styling in DecisionNode).
  - Add a `AGENT_TYPE_TINTS` map that maps each `AgentType` to its CSS variable name for the hue tint:
    ```typescript
    export const AGENT_TYPE_TINTS: Record<AgentType, string> = {
      triage: 'var(--cc-triage-tint)',
      orchestrator: 'var(--cc-orchestrator-tint)',
      financial: 'var(--cc-financial-tint)',
      legal: 'var(--cc-legal-tint)',
      strategy: 'var(--cc-strategy-tint)',
      'knowledge-graph': 'var(--cc-kg-tint)',
    };
    ```
  - Add node dimension constants for dagre:
    ```typescript
    export const NODE_WIDTH = 300;
    export const NODE_HEIGHT = 100;
    ```

  **IMPORTANT:** The `AgentConfig` type in `command-center.ts` has `color` and `position` fields. Do NOT modify the types file (it's in the preserved list). Instead, keep `color` and `position` in the config as empty/dummy values to satisfy the type, OR update `AGENT_CONFIGS` to use a local override type. The cleanest approach: keep `color: ''` and `position: { x: 0, y: 0 }` as placeholders since dagre will compute positions and CSS variables will provide colors.

  **Step 2: Create `DecisionNode.tsx`.**

  This is a custom ReactFlow node component. Create a NEW file (the old `AgentNode.tsx` SVG component will be removed in Plan 03).

  The DecisionNode must:

  1. **Accept ReactFlow node props** via `NodeProps` from `@xyflow/react`. The `data` field carries:
     - `agentType: AgentType` -- the agent type
     - `agentState: AgentState` -- the full agent state
     - `isChosen: boolean` -- whether this node is on the active/chosen path
     - `isSelected: boolean` -- whether the user clicked this node
     - `onNodeClick: (agentType: AgentType) => void` -- click handler

  2. **Render ReactFlow Handles:**
     - `<Handle type="target" position={Position.Top}>` -- styled teal if chosen, muted if not
     - `<Handle type="source" position={Position.Bottom}>` -- same styling

  3. **Use motion animations from `motion/react`** (NOT `framer-motion`):
     - **Entrance:** `scale: 0.9 -> 1, opacity: 0 -> 1` over 0.5s easeOut
     - **Floating** (when chosen): `y: [0, -2, 0]` infinite, 2s easeInOut
     - **Hover:** `scale: 1.05, y: -8`
     - **Tap:** `scale: 0.98`
     - **Pulsing border** (when processing): An absolutely-positioned inner div that scales `[1, 1.05, 1]` with opacity `[0.5, 0.8, 0.5]` infinite 2s
     - **Text glow** (when chosen): `textShadow` cycling between `0 0 5px` and `0 0 10px` of the teal accent

  4. **Node face content (minimal, scannable):**
     - Agent name (bold, `text-lg`)
     - Status indicator: small dot (idle=gray, processing=pulsing teal, complete=solid teal, error=red)
     - Badge: file count for domain agents, entity count for triage, etc. (pull from `agentState.lastResult` or `agentState.currentTask`)
     - Spinner icon (from lucide-react `Loader2`) when processing

  5. **Styling rules per CONTEXT.md:**
     - **Chosen/active/complete nodes:** Background gradient using agent-type hue tint + teal accent. Border `2px solid hsl(var(--cc-accent))`. Box shadow `0 0 20px hsl(var(--cc-accent) / 0.3)`.
     - **Unchosen/idle nodes:** Background `hsl(0 0% 14% / 0.7)` (charcoal variant). Border `1px solid hsl(0 0% 50% / 0.3)`. Muted gray text.
     - **Processing nodes:** Same as chosen but with pulsing border overlay and spinner.
     - **Error nodes:** Red border, red status dot.
     - **Hover on unchosen:** Background brightens to `hsl(0 0% 14% / 0.9)`, border to `hsl(0 0% 50% / 0.6)`, text to brighter gray.

  6. **Fixed dimensions:** `w-[300px] h-[100px]` to match dagre NODE_WIDTH/NODE_HEIGHT constants. Use `rounded-lg` (~8px radius). The inner motion.div animates WITHIN these fixed bounds (no width/height animation to avoid React Flow layout jumps per RESEARCH pitfall #7).

  7. **Portal tooltip:**
     - On `onMouseEnter`, compute tooltip position via `getBoundingClientRect()` of the node ref.
     - Render via `ReactDOM.createPortal` to `document.body`.
     - Tooltip says "Click for more details".
     - Style: dark background with blur, `text-sm`, `rounded-lg`, `shadow-2xl`, small CSS triangle arrow pointing down.
     - `pointerEvents: none` on the tooltip.
     - On `onMouseLeave`, remove tooltip.

  8. **Warning badge on orchestrator node:** If `agentType === 'orchestrator'` and there are warnings in `agentState.lastResult?.metadata?.warnings`, show a small warning icon + count badge (use lucide `AlertTriangle`).

  **Anti-patterns to avoid:**
  - Do NOT import from `framer-motion`. Use `motion/react`.
  - Do NOT animate `width` or `height`. Only animate `scale`, `opacity`, `y`, `textShadow`.
  - Do NOT use `any` types. Properly type the node data interface.
  </action>
  <verify>
  - `frontend/src/components/CommandCenter/DecisionNode.tsx` exists with 120+ lines
  - `frontend/src/lib/command-center-config.ts` has `AGENT_TYPE_TINTS`, `NODE_WIDTH`, `NODE_HEIGHT`
  - `command-center-config.ts` still has `AGENT_CONFIGS` and `DEFAULT_CONNECTIONS`
  - No imports from `framer-motion` -- only `motion/react`
  - `cd frontend && bun run build` passes (TypeScript compiles, no errors)
  </verify>
  <done>
  DecisionNode component created with all motion animations (entrance, floating, hover, tap, pulsing border, text glow), portal tooltip, ReactFlow handles, and proper styling for chosen/unchosen/processing/error states. Config updated with teal color system and dagre constants.
  </done>
</task>

</tasks>

<verification>
- All 3 new npm packages installed: `@xyflow/react`, `@dagrejs/dagre`, `@types/dagre`
- Scoped CSS variables in globals.css under `.command-center-scope`
- DecisionNode component compiles and exports correctly
- Config has been updated to remove manual positions and add teal color system
- `bun run build` passes in the frontend directory
</verification>

<success_criteria>
- Dependencies installed and lockfile updated
- CSS variables scoped to `.command-center-scope` (no global palette impact)
- DecisionNode renders with motion entrance animation, handles, and tooltip
- Chosen nodes have teal glow with agent-type hue tinting
- Unchosen nodes are muted dark gray
- Processing nodes pulse with teal border
- Config exports NODE_WIDTH, NODE_HEIGHT, AGENT_TYPE_TINTS
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-agent-decision-tree-revamp/04.1-01-SUMMARY.md`
</output>
