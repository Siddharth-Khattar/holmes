---
phase: 04.1-agent-decision-tree-revamp
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a node opens a spring-animated sidebar sliding from the right"
    - "Sidebar shows color-coded collapsible sections (Reasoning/Thinking, Description, Findings, Metadata)"
    - "Thinking traces display in a dedicated monospace section"
    - "Triage sidebar shows domain scores as colored pills and extracted entities"
    - "Orchestrator sidebar shows routing summary, file routing table, and warnings"
  artifacts:
    - path: "frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx"
      provides: "Spring-animated detail sidebar with agent-type-specific sections"
      min_lines: 150
  key_links:
    - from: "frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx"
      to: "frontend/src/types/command-center.ts"
      via: "imports AgentState, AgentType for typed data display"
      pattern: "AgentState"
    - from: "frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx"
      to: "frontend/src/lib/command-center-config.ts"
      via: "imports AGENT_CONFIGS for agent metadata and AGENT_TYPE_TINTS for header tinting"
      pattern: "AGENT_CONFIGS|AGENT_TYPE_TINTS"
---

<objective>
Build the NodeDetailsSidebar component -- a spring-animated right-sliding panel that displays detailed agent information with color-coded collapsible sections, agent-type-specific content, and a dedicated thinking traces section.

Purpose: Replace the current inline `AgentDetailsPanel.tsx` with a richer, animated sidebar that matches the reference design's visual spec. This component is consumed by Plan 03 when it integrates the full canvas.

Output: A standalone NodeDetailsSidebar component ready to be mounted by CommandCenter.tsx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-agent-decision-tree-revamp/04.1-CONTEXT.md
@.planning/phases/04.1-agent-decision-tree-revamp/04.1-RESEARCH.md
@DOCS/UI/agent-decision-tree-guide.md
@frontend/src/types/command-center.ts
@frontend/src/components/CommandCenter/AgentDetailsPanel.tsx
@frontend/src/lib/command-center-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NodeDetailsSidebar shell with spring animation and shared sections</name>
  <files>
    frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
  </files>
  <action>
  Create a NEW file `NodeDetailsSidebar.tsx` in the CommandCenter directory. Do NOT modify `AgentDetailsPanel.tsx` (it will be removed/replaced in Plan 03).

  This task builds the sidebar shell (animation, header, shared sections). Task 2 adds agent-type-specific content sections.

  **Props interface:**
  ```typescript
  interface NodeDetailsSidebarProps {
    isOpen: boolean;
    agentType: AgentType | null;
    agentState: AgentState | null;
    onClose: () => void;
  }
  ```

  **Spring animation (motion/react):**
  - Use `AnimatePresence` wrapping a `motion.div`
  - `initial={{ x: '100%' }}`
  - `animate={{ x: 0 }}`
  - `exit={{ x: '100%' }}`
  - `transition={{ type: 'spring', damping: 20, stiffness: 300 }}`
  - Position: `absolute right-0 top-0 h-full w-96 z-50` within the Command Center container (NOT `fixed` -- per RESEARCH open question #3, use absolute within the CC container to avoid overlapping case layout chrome)
  - Background: `var(--color-jet)` with `border-l border-stone/15`
  - Add a semi-transparent backdrop/overlay on the left side that closes the sidebar when clicked

  **Header section:**
  - Agent name (from `AGENT_CONFIGS[agentType].name`) -- import `AGENT_CONFIGS` from `command-center-config.ts`
  - Agent description
  - Status badge with colored dot (idle/processing/complete/error)
  - Model name badge (from `AGENT_CONFIGS[agentType].model`)
  - Close button (X icon from lucide-react)
  - "Selected Path" badge when agent is chosen (status is processing or complete)
  - Background: subtle gradient using the agent-type hue tint -- import `AGENT_TYPE_TINTS` from `command-center-config.ts`

  **Collapsible section helper component:**
  Build a reusable `CollapsibleSection` local component within the file that accepts `title`, `color` (for left border + header tint), `defaultOpen`, and `children`. Uses the existing collapsible pattern from `AgentDetailsPanel.tsx` (ChevronDown/ChevronUp toggle with state). All sections collapsed by default.

  **Shared sections (all agent types):**

  1. **Thinking Traces** (always shown if data exists)
     - Color: teal accent (`hsl(var(--cc-accent))`)
     - Background: `hsl(var(--cc-accent) / 0.05)`, border-left: `3px solid hsl(var(--cc-accent) / 0.3)`
     - Content: monospace/differentiated typography (`font-mono text-sm`) displaying thinking trace text
     - Data source: `agentState.lastResult?.metadata?.thinkingTraces` (string, up to 2000 chars)
     - If no thinking traces available, show "No thinking traces available" in muted text

  2. **Input Context** (from existing AgentDetailsPanel pattern)
     - Color: blue-ish (`hsl(220 50% 35%)`)
     - Shows: from-agent info, input metadata
     - Reuse the existing pattern from `AgentDetailsPanel.tsx`

  3. **Output Findings** (from existing AgentDetailsPanel pattern)
     - Color: teal accent
     - Shows: output items with type, data, confidence
     - Routing decisions if available (orchestrator)
     - Reuse the existing pattern from `AgentDetailsPanel.tsx`

  4. **Tools Called** (if any exist)
     - Color: muted gray
     - Shows: list of tool names

  5. **Processing History** (if any exist)
     - Color: muted gray
     - Shows: recent tasks with status dots and timestamps

  **Current Task section** (always visible at top when processing):
  - Blue pulsing dot indicator
  - Current file name being processed
  - Started time

  **Empty/idle state:**
  - Show "Waiting for tasks..." with spinner animation (reuse existing pattern)

  **Scrollable content area:** `overflow-y-auto` with hidden scrollbar styling

  **Styling guidelines:**
  - Use Holmes design tokens: `--color-jet`, `--color-smoke`, `--color-stone`, `--color-charcoal`
  - Use teal accent from scoped variables: `hsl(var(--cc-accent))` where appropriate
  - All text sizes: section headers `text-xs uppercase tracking-wide`, content `text-sm`, metadata `text-xs`
  - Import `motion, AnimatePresence` from `motion/react` (NOT framer-motion)
  - Import icons from `lucide-react`: `X`, `ChevronDown`, `ChevronUp`, `AlertTriangle`, `Brain`, `FileText`, `Network`

  **Anti-patterns to avoid:**
  - Do NOT use `fixed` positioning (use `absolute` within CC container)
  - Do NOT import from `framer-motion`
  - Do NOT use `any` types
  - Do NOT remove or modify `AgentDetailsPanel.tsx` in this plan
  </action>
  <verify>
  - `frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx` exists
  - Component uses `motion/react` for AnimatePresence + spring transition
  - Component has CollapsibleSection helper with color-coded borders
  - Header imports and uses `AGENT_CONFIGS` and `AGENT_TYPE_TINTS` from `command-center-config.ts`
  - Thinking traces section uses monospace typography
  - No `any` types used
  - `cd frontend && bun run build` passes
  </verify>
  <done>
  NodeDetailsSidebar shell created with spring animation, header using AGENT_CONFIGS + AGENT_TYPE_TINTS, CollapsibleSection helper, and shared sections (thinking traces, input context, output findings, tools called, processing history).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add agent-type-specific sidebar sections</name>
  <files>
    frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
  </files>
  <action>
  Extend the NodeDetailsSidebar with agent-type-specific content sections. These sections render BETWEEN the "Thinking Traces" section and the shared "Input Context" section.

  Add a **Reasoning / Summary** section that varies by agent type:
  - Color: warm amber (`hsl(37 90% 68%)` -- `alt_color_a` from guide)

  Then add **agent-type-specific detail sections** below it:

  **Triage sidebar specifics:**
  - "Analysis Summary" reasoning section: shows file summary (short + detailed) from triage output
  - "Domain Scores" subsection: For each domain score, render a color-coded pill/badge. Color intensity reflects score (0-100). Use small horizontal bars or pill badges: `evidence: 100` (bright), `legal: 85` (medium), etc.
  - "Extracted Entities" subsection: List of entities with type badges (person, org, date, location, amount, legal_term)
  - "Complexity" subsection: Complexity tier badge (Low/Medium/High)
  - Data source: `agentState.lastResult?.outputs` array -- triage outputs have domain scores, entities, complexity

  **Orchestrator sidebar specifics:**
  - "Routing Summary" reasoning section: shows overall routing reasoning
  - "File Routing Table" subsection: Table showing files x target agents x priority (from `agentState.lastResult?.routingDecisions`)
  - "Warnings" subsection: List of warnings with warning icons (from `agentState.lastResult?.metadata?.warnings`)
  - "File Groups" subsection: If `agentState.lastResult?.metadata?.file_groups` or `agentState.lastResult?.outputs` contains file group data, show group name, file count, shared context, and target agents for each group

  **Domain agent sidebar specifics (financial, legal, strategy):**
  - "Findings Summary" reasoning section: key findings from domain analysis
  - "Files Processed" subsection: Count and list of processed files
  - "Key Extractions" subsection: Structured findings from analysis

  **Knowledge Graph agent sidebar specifics:**
  - "Graph Summary" reasoning section
  - "Entities Created" subsection: Count of entities
  - "Relationships Created" subsection: Count and sample

  Use a switch/map on `agentType` to render the appropriate sections. Each agent-type section should be a separate local component or render function for readability:
  - `TriageSections`
  - `OrchestratorSections`
  - `DomainAgentSections`
  - `KnowledgeGraphSections`

  **Anti-patterns to avoid:**
  - Do NOT use `any` types -- use proper typing for the outputs/metadata accessed
  - Do NOT duplicate the CollapsibleSection component -- reuse the one from Task 1
  </action>
  <verify>
  - NodeDetailsSidebar handles all agent types (triage, orchestrator, financial, legal, strategy, knowledge-graph) with type-specific content
  - Triage sections include domain scores, entities, complexity
  - Orchestrator sections include routing table, warnings, file groups
  - Domain agent sections include files processed, key extractions
  - No `any` types used
  - `cd frontend && bun run build` passes
  </verify>
  <done>
  NodeDetailsSidebar complete with all agent-type-specific sections: triage domain scores/entities, orchestrator routing table/warnings/file groups, domain agent findings, and knowledge graph entity/relationship counts. All sections use CollapsibleSection with color coding.
  </done>
</task>

</tasks>

<verification>
- NodeDetailsSidebar.tsx compiles without errors
- Spring animation configuration matches reference guide (damping: 20, stiffness: 300)
- Collapsible sections use consistent color-coding
- Triage-specific sections (domain scores, entities, complexity) are implemented
- Orchestrator-specific sections (routing table, warnings, file groups) are implemented
- Header uses AGENT_CONFIGS and AGENT_TYPE_TINTS from command-center-config.ts
- `bun run build` passes
</verification>

<success_criteria>
- Sidebar slides in from right with spring animation on open
- Sidebar slides out with exit animation on close
- All sections are collapsible with expand/collapse icons
- Thinking traces display in monospace with teal accent color
- Domain scores render as colored pills for triage agent
- Routing decisions render as a table for orchestrator agent
- Current processing task shows at top with pulsing indicator
- Empty state shows waiting spinner
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-agent-decision-tree-revamp/04.1-02-SUMMARY.md`
</output>
