# Phase 4.1: Agent Decision Tree Revamp - Context

**Gathered:** 2026-02-03
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace the current D3-based Command Center visualization with a @xyflow/react + dagre-powered decision tree. The tree renders the agent pipeline (triage → orchestrator → file groups → domain agents → KG) with rich animations, chosen-path highlighting, and a spring-animated details sidebar. Preserve all existing SSE integration and agent state management. No backend changes — this is a frontend-only visual revamp.

</domain>

<decisions>
## Implementation Decisions

### Data Mapping — Pipeline to Tree Structure
- **Dynamic tree from backend:** Tree structure is driven by backend SSE data, not hardcoded. The tree shape reflects actual orchestrator routing decisions. Future-proofs for when routing becomes more dynamic.
- **Show all domain agents, mute unchosen:** All 4 domain agents (financial, legal, strategy, evidence) always appear in the tree. Agents the orchestrator didn't route files to are rendered muted/gray. Communicates "this was considered but not needed."
- **Pipeline tree with file badges:** One tree per analysis run. Domain agent nodes show which/how many files were routed to them (e.g., "Evidence Agent • 5 files"). File-level routing details in the sidebar.
- **Research agent as sibling to domain agents:** When research is triggered in the future, the research agent appears at the same level as domain agents (not a separate branch). When not triggered, it appears muted like any skipped domain agent.
- **File group nodes between orchestrator and domains:** Orchestrator's `file_groups` output renders as intermediate nodes between orchestrator and domain agents. These show how files were clustered before routing. Node face shows group name + file count; sidebar shows shared context, file list, and target agents.
- **Warning badge on orchestrator node:** Orchestrator warnings (e.g., "complex multi-format document") displayed as a small warning icon/count badge on the orchestrator node. Full warning text in the sidebar.

### Color & Theming
- **New scoped accent for Command Center:** Introduce a **teal/cyan accent** (approximately `hsl(180 60% 45%)`) specifically for the Command Center, defined as scoped CSS variables. Does not affect the rest of Holmes' warm neutral palette.
- **Canvas background: Holmes jet (#111111):** Uses `--color-jet` for the canvas, matching Holmes' card/secondary background. Slightly lifted from the surrounding app chrome.
- **Chosen nodes: teal glow + subtle agent-type hue shift:** Chosen (active/complete) nodes get the teal accent glow, border, and edge highlighting. Additionally, each chosen agent type gets a very subtle hue tint on its node background to visually distinguish roles at a glance (e.g., legal slightly blue-tinted, financial slightly green-tinted, evidence slightly warm). Unchosen nodes are uniform muted gray with no type tinting.
- **Existing Holmes tokens for non-accent elements:** Muted text uses `--color-stone`, node backgrounds use `--color-charcoal`/`--color-jet` variants, borders use Holmes' existing border tokens.

### Node Content — Face vs Sidebar
- **Node face: Name + status + count:** Each node shows agent name, a status indicator (idle/processing/complete), and a small badge with the key metric (file count for domain agents, entity count for triage, etc.). Minimal and scannable at any zoom level.
- **Sidebar: All sections, collapsible:** When a node is clicked, the spring-animated sidebar shows all available data sections collapsed by default. User expands what they care about. Sections vary by agent type:
  - **Triage sidebar:** Reasoning/summary, per-file cards (domain scores as color-coded pills, complexity tier, confidence), extracted entities list.
  - **Orchestrator sidebar:** Overall routing summary, file routing table (files × target agents × priority), warnings section.
  - **Domain agent sidebar:** Files processed, findings summary, key extractions.
  - **File group sidebar:** Shared context, file list, target agent mapping.
- **Dedicated 'Thinking' section in sidebar:** Agent thinking traces (up to 2000 chars) get their own collapsible section, styled distinctly (monospace or differentiated typography). Full transparency into reasoning process.
- **Group node face: Group name + file count:** File group nodes show the group name (e.g., "Lumberski Homicide") and file count on the face. Sidebar expands to show shared context, files, and routing.

### Real-time Behavior — SSE-driven Animation
- **Progressive tree build:** Tree starts with only the triage node. As SSE events fire (AGENT_SPAWNED), new nodes animate into existence. Domain agents appear when orchestrator routes to them. Unchosen domain agents appear muted after orchestrator completes (showing what was considered but skipped). More dramatic reveal — user discovers the pipeline as it unfolds.
- **Processing state: pulsing border + animated edge flow:** When an agent is running, the node gets a pulsing teal border (breathing effect) with a spinner, AND the incoming edge gets animated dash flow (moving dots). Both effects active simultaneously during processing.
- **Completion transition: settle into chosen style:** When agent completes, pulsing stops, border becomes solid teal, glow reduces to steady soft glow. Floating animation (subtle y-bounce from the guide) continues. Clean, non-dramatic transition from active to resolved.
- **Viewport: stay zoomed to fit all:** Viewport always shows the full tree after initial fit. No automatic panning/zooming as agents activate. User sees the big picture — which agents are running, idle, or done. Manual pan/zoom available.

### Claude's Discretion
- Exact teal hue value (approximately `hsl(180 60% 45%)`, fine-tune for best contrast on jet background)
- Per-agent-type hue tint values (subtle enough to not clash with teal accent)
- Dagre layout spacing (ranksep, nodesep) — may need adjustment from the guide's values to accommodate file group intermediate nodes
- Tooltip styling and positioning details
- Sidebar section ordering and default expand/collapse state
- How unchosen domain agents animate in after orchestrator completes (fade-in timing)
- Spinner icon and progress indicator design on processing nodes
- Edge animation speed and dash pattern

</decisions>

<specifics>
## Specific Ideas

- The reference guide (`DOCS/UI/agent-decision-tree-guide.md`) is the pixel-level spec for node animations (entrance, floating, hover, pulse border, text glow), edge styling (smoothstep, animated dashes, glowing trail), sidebar spring animation, tooltip portal, and dagre layout config. Follow it closely, adapting colors to teal accent.
- Holmes' existing SSE events map to tree state: `AGENT_SPAWNED` → add node with processing state, `THINKING_UPDATE` → update thinking trace in sidebar data, `AGENT_COMPLETED` → transition to complete state.
- Backend output structure (triage_result, orchestrator_result) is the data source. The frontend transforms this into the tree — no backend changes needed.
- Domain scores from triage output should render as small colored pills/badges in the sidebar (e.g., `evidence: 100`, `legal: 85`, `strategy: 75`) with color intensity reflecting the score.

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope.

</deferred>

---

*Phase: 04.1-agent-decision-tree-revamp*
*Context gathered: 2026-02-03*
