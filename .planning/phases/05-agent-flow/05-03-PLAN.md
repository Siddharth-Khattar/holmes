---
phase: 05-agent-flow
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/types/command-center.ts
  - frontend/src/lib/command-center-validation.ts
  - frontend/src/hooks/useCommandCenterSSE.ts
  - frontend/src/hooks/useAgentStates.ts
autonomous: true

must_haves:
  truths:
    - "Frontend SSE connects to the correct backend URL (not relative /api/ path)"
    - "Thinking traces appear in real-time in the sidebar as agents process"
    - "State snapshot on reconnect restores all agent statuses without data loss"
    - "Processing-complete event shows total token usage and duration"
  artifacts:
    - path: "frontend/src/types/command-center.ts"
      provides: "New event types: ThinkingUpdateEvent, StateSnapshotEvent, ConfirmationRequiredEvent, ConfirmationResolvedEvent, enriched ProcessingCompleteEvent"
      contains: "ThinkingUpdateEvent"
    - path: "frontend/src/lib/command-center-validation.ts"
      provides: "Validators for all new event types"
      contains: "validateThinkingUpdateEvent"
    - path: "frontend/src/hooks/useCommandCenterSSE.ts"
      provides: "Correct SSE URL using NEXT_PUBLIC_API_URL, event listeners for all new event types"
      contains: "NEXT_PUBLIC_API_URL"
    - path: "frontend/src/hooks/useAgentStates.ts"
      provides: "Handlers for thinking-update (append to buffer), state-snapshot (restore all states), enriched processing-complete"
      contains: "handleThinkingUpdate"
  key_links:
    - from: "frontend/src/hooks/useCommandCenterSSE.ts"
      to: "backend SSE endpoint"
      via: "EventSource with full URL from NEXT_PUBLIC_API_URL"
      pattern: "NEXT_PUBLIC_API_URL.*sse/cases"
    - from: "frontend/src/hooks/useAgentStates.ts"
      to: "frontend/src/hooks/useCommandCenterSSE.ts"
      via: "Callback handlers passed as options"
      pattern: "onThinkingUpdate.*handleThinkingUpdate"
    - from: "frontend/src/types/command-center.ts"
      to: "frontend/src/lib/command-center-validation.ts"
      via: "Type imports for validation functions"
      pattern: "ThinkingUpdateEvent"
---

<objective>
Wire frontend SSE hook to correct backend URL, add new event type support (thinking-update, state-snapshot, confirmation-required), and handle real-time thinking trace accumulation in agent state.

Purpose: The frontend has the UI components ready (sidebar shows thinking traces, nodes show status) but the SSE hook connects to the wrong URL and doesn't handle new event types. This plan fixes the URL, adds type definitions, validators, event listeners, and state handlers for all new backend SSE events.

Output: Frontend SSE correctly connected to backend, real-time thinking traces accumulate in agent state, state snapshot restores on reconnect.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-flow/05-CONTEXT.md
@.planning/phases/05-agent-flow/05-RESEARCH.md
@.planning/phases/05-agent-flow/05-01-SUMMARY.md

@frontend/src/types/command-center.ts
@frontend/src/lib/command-center-validation.ts
@frontend/src/hooks/useCommandCenterSSE.ts
@frontend/src/hooks/useAgentStates.ts
@frontend/src/lib/command-center-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new SSE event types and validators</name>
  <files>
    frontend/src/types/command-center.ts
    frontend/src/lib/command-center-validation.ts
  </files>
  <action>
  **In `frontend/src/types/command-center.ts`:**

  1. Add new event interfaces:

     ```typescript
     export interface ThinkingUpdateEvent {
       type: "thinking-update";
       agentType: AgentType;
       thought: string;
       timestamp: string;
       tokenDelta?: {
         inputTokens: number;
         outputTokens: number;
         thoughtsTokens: number;
       };
     }

     export interface StateSnapshotEvent {
       type: "state-snapshot";
       agents: Record<string, {
         status: string;
         metadata?: {
           inputTokens?: number;
           outputTokens?: number;
           durationMs?: number;
           startedAt?: string;
           completedAt?: string;
           model?: string;
           thinkingTraces?: string;
         };
         lastResult?: AgentResult;
       }>;
     }

     export interface ConfirmationRequiredEvent {
       type: "confirmation-required";
       requestId: string;
       agentType: AgentType;
       actionDescription: string;
       affectedItems: string[];
       context: Record<string, unknown>;
     }

     export interface ConfirmationResolvedEvent {
       type: "confirmation-resolved";
       requestId: string;
       approved: boolean;
       reason?: string;
     }

     export interface PipelineCompleteEvent {
       type: "processing-complete";
       caseId: string;
       filesProcessed: number;
       entitiesCreated: number;
       relationshipsCreated: number;
       totalDurationMs?: number;
       totalInputTokens?: number;
       totalOutputTokens?: number;
     }
     ```

  2. Update the `CommandCenterSSEEvent` union type to include the new event types:
     ```typescript
     export type CommandCenterSSEEvent =
       | AgentStartedEvent
       | AgentCompleteEvent
       | AgentErrorEvent
       | ProcessingCompleteEvent
       | ThinkingUpdateEvent
       | StateSnapshotEvent
       | ConfirmationRequiredEvent
       | ConfirmationResolvedEvent;
     ```

  3. Update the `ProcessingSummary` interface to include new fields:
     ```typescript
     export interface ProcessingSummary {
       filesProcessed: number;
       entitiesCreated: number;
       relationshipsCreated: number;
       completedAt: Date;
       totalDurationMs?: number;
       totalInputTokens?: number;
       totalOutputTokens?: number;
     }
     ```

  4. IMPORTANT: Keep the existing `ProcessingCompleteEvent` interface but add the optional fields (`totalDurationMs`, `totalInputTokens`, `totalOutputTokens`) to it. Do NOT create a separate `PipelineCompleteEvent` -- just extend the existing one. The above `PipelineCompleteEvent` was shown for clarity of fields; merge them into the existing `ProcessingCompleteEvent`.

  **In `frontend/src/lib/command-center-validation.ts`:**

  1. Add validator functions for each new event type:
     - `validateThinkingUpdateEvent(data: unknown): data is ThinkingUpdateEvent`
       - Check: type === "thinking-update", valid agentType, typeof thought === "string", typeof timestamp === "string"
     - `validateStateSnapshotEvent(data: unknown): data is StateSnapshotEvent`
       - Check: type === "state-snapshot", typeof agents === "object"
     - `validateConfirmationRequiredEvent(data: unknown): data is ConfirmationRequiredEvent`
       - Check: type === "confirmation-required", typeof requestId === "string", valid agentType, typeof actionDescription === "string", Array.isArray(affectedItems)
     - `validateConfirmationResolvedEvent(data: unknown): data is ConfirmationResolvedEvent`
       - Check: type === "confirmation-resolved", typeof requestId === "string", typeof approved === "boolean"

  2. Update the `validateCommandCenterEvent()` switch statement to handle the new event types. Add cases for "thinking-update", "state-snapshot", "confirmation-required", "confirmation-resolved".

  3. Import the new type interfaces from `@/types/command-center`.
  </action>
  <verify>
  - `cd frontend && npx tsc --noEmit --pretty` succeeds (no type errors)
  - Grep for new types: `grep "ThinkingUpdateEvent\|StateSnapshotEvent\|ConfirmationRequiredEvent" frontend/src/types/command-center.ts` shows all new interfaces
  - Grep for new validators: `grep "validateThinkingUpdate\|validateStateSnapshot\|validateConfirmation" frontend/src/lib/command-center-validation.ts` shows new functions
  </verify>
  <done>
  - All new SSE event types have TypeScript interfaces
  - CommandCenterSSEEvent union includes all new types
  - ProcessingSummary extended with aggregate statistics fields
  - Validators exist for every new event type
  - Existing validators unchanged (backward compatible)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix SSE URL and add new event handlers in hooks</name>
  <files>
    frontend/src/hooks/useCommandCenterSSE.ts
    frontend/src/hooks/useAgentStates.ts
  </files>
  <action>
  **In `frontend/src/hooks/useCommandCenterSSE.ts`:**

  1. **FIX SSE URL:** Replace the relative URL `/api/cases/${caseId}/command-center/stream` with the full backend URL. Construct from `process.env.NEXT_PUBLIC_API_URL` (defaults to `http://localhost:8080`) plus `/sse/cases/${caseId}/command-center/stream`:
     ```typescript
     const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8080";
     const sseUrl = `${API_URL}/sse/cases/${caseId}/command-center/stream`;
     const eventSource = new EventSource(sseUrl);
     ```
     This matches the pattern used by REST API calls in `files.ts` and `api-client.ts`.

  2. Add new callback options to `UseCommandCenterSSEOptions`:
     ```typescript
     onThinkingUpdate?: (event: CommandCenterSSEEvent) => void;
     onStateSnapshot?: (event: CommandCenterSSEEvent) => void;
     onConfirmationRequired?: (event: CommandCenterSSEEvent) => void;
     onConfirmationResolved?: (event: CommandCenterSSEEvent) => void;
     ```

  3. Add new `addEventListener` calls for each new event type inside `setupConnection()`:
     - `eventSource.addEventListener("thinking-update", ...)` -- parse and call `onThinkingUpdate`
     - `eventSource.addEventListener("state-snapshot", ...)` -- parse and call `onStateSnapshot`
     - `eventSource.addEventListener("confirmation-required", ...)` -- parse and call `onConfirmationRequired`
     - `eventSource.addEventListener("confirmation-resolved", ...)` -- parse and call `onConfirmationResolved`

  4. Add the new callbacks to the `useCallback` dependency array.

  **In `frontend/src/hooks/useAgentStates.ts`:**

  1. Add a `handleThinkingUpdate` callback:
     - Cast event to `ThinkingUpdateEvent`
     - Get the agent type from the event
     - Update the agent state by APPENDING the new thought to `lastResult.metadata.thinkingTraces`
     - If `lastResult` doesn't exist yet (agent is still processing), create a minimal lastResult with just the metadata
     - Pattern:
       ```typescript
       const handleThinkingUpdate = useCallback((event: CommandCenterSSEEvent) => {
         const e = event as ThinkingUpdateEvent;
         const agentType = e.agentType;
         setAgentStates((prev) => {
           const next = new Map(prev);
           const state = next.get(agentType);
           if (state) {
             const existingTraces = (state.lastResult?.metadata?.thinkingTraces as string) || "";
             const updatedTraces = existingTraces ? existingTraces + "\n" + e.thought : e.thought;
             next.set(agentType, {
               ...state,
               lastResult: {
                 ...(state.lastResult || { taskId: "", agentType, outputs: [] }),
                 metadata: {
                   ...(state.lastResult?.metadata || {}),
                   thinkingTraces: updatedTraces,
                 },
               },
             });
           }
           return next;
         });
       }, []);
       ```

  2. Add a `handleStateSnapshot` callback:
     - Cast event to `StateSnapshotEvent`
     - For each agent in the snapshot, update the corresponding agent state:
       - Set status based on snapshot agent status (map "completed" -> "idle" with lastResult, "running" -> "processing", "failed" -> "error")
       - Set lastResult from snapshot metadata if present
     - This fully restores state on reconnection

  3. Update `handleProcessingComplete` to include the new aggregate fields:
     ```typescript
     setLastProcessingSummary({
       filesProcessed: e.filesProcessed,
       entitiesCreated: e.entitiesCreated,
       relationshipsCreated: e.relationshipsCreated,
       completedAt: new Date(),
       totalDurationMs: e.totalDurationMs,
       totalInputTokens: e.totalInputTokens,
       totalOutputTokens: e.totalOutputTokens,
     });
     ```

  4. Pass the new handlers to `useCommandCenterSSE`:
     ```typescript
     const { isConnected, isReconnecting } = useCommandCenterSSE(caseId, {
       enabled: true,
       onAgentStarted: handleAgentStarted,
       onAgentComplete: handleAgentComplete,
       onAgentError: handleAgentError,
       onProcessingComplete: handleProcessingComplete,
       onThinkingUpdate: handleThinkingUpdate,
       onStateSnapshot: handleStateSnapshot,
     });
     ```

  5. Export the confirmation event data so Plan 04 can consume it. Add state for pending confirmations:
     ```typescript
     const [pendingConfirmations, setPendingConfirmations] = useState<ConfirmationRequiredEvent[]>([]);
     ```
     Add a `handleConfirmationRequired` callback that adds to this array, and a `handleConfirmationResolved` callback that removes by requestId. Include `pendingConfirmations` in the return value of the hook.

  6. Import the new types: `ThinkingUpdateEvent`, `StateSnapshotEvent`, `ConfirmationRequiredEvent`, `ConfirmationResolvedEvent` from `@/types/command-center`.
  </action>
  <verify>
  - `cd frontend && npx tsc --noEmit --pretty` succeeds (no type errors)
  - Grep for URL fix: `grep "NEXT_PUBLIC_API_URL" frontend/src/hooks/useCommandCenterSSE.ts` shows the env var usage
  - Grep for new handlers: `grep "handleThinkingUpdate\|handleStateSnapshot\|handleConfirmation" frontend/src/hooks/useAgentStates.ts` shows all new handlers
  - Grep for new event listeners: `grep "thinking-update\|state-snapshot\|confirmation" frontend/src/hooks/useCommandCenterSSE.ts` shows all new addEventListener calls
  </verify>
  <done>
  - SSE connects to correct backend URL via NEXT_PUBLIC_API_URL + /sse/cases/.../stream
  - thinking-update events handled: thoughts appended to agent state in real-time
  - state-snapshot events handled: all agent states restored on reconnect
  - confirmation-required/resolved events handled: pending confirmations tracked in state
  - Processing-complete handler captures aggregate statistics
  - All new event types properly validated via parseSSEEventData
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit --pretty` succeeds with zero errors
2. `cd frontend && npx next build` succeeds (ensures no runtime import issues)
3. SSE URL construction: The EventSource should use `${NEXT_PUBLIC_API_URL}/sse/cases/${caseId}/command-center/stream`
4. When backend sends thinking-update events, the sidebar's thinking traces section should accumulate text in real-time
5. When backend sends state-snapshot on connect, all agent states should be restored
</verification>

<success_criteria>
- SSE connection established to correct backend URL (no more silent failures / demo mode fallback when backend is running)
- Real-time thinking traces accumulate in agent state and display in sidebar
- State snapshot on reconnect restores all agent statuses
- Pending confirmations tracked in state for Plan 04 to consume
- Type safety maintained across all new event types
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-flow/05-03-SUMMARY.md`
</output>
