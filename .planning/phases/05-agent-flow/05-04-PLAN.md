---
phase: 05-agent-flow
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - frontend/src/components/CommandCenter/ConfirmationModal.tsx
  - frontend/src/components/CommandCenter/ExecutionTimeline.tsx
  - frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
  - frontend/src/components/CommandCenter/DecisionNode.tsx
  - frontend/src/components/CommandCenter/CommandCenter.tsx
  - frontend/src/app/(app)/cases/[id]/command-center/page.tsx
  - frontend/src/lib/api/confirmations.ts
autonomous: false

must_haves:
  truths:
    - "Clicking Approve/Reject in the confirmation modal sends POST to backend and unblocks the pipeline"
    - "Token usage (input/output tokens) displayed per-agent in the sidebar"
    - "Duration badge visible on each agent node showing execution time"
    - "Execution timeline in sidebar shows agents as horizontal bars to visualize sequential/parallel execution"
    - "Notification badge appears on Command Center tab when a confirmation is pending"
  artifacts:
    - path: "frontend/src/components/CommandCenter/ConfirmationModal.tsx"
      provides: "HITL confirmation dialog with action description, affected items, approve/reject buttons, optional reason"
      contains: "ConfirmationModal"
    - path: "frontend/src/components/CommandCenter/ExecutionTimeline.tsx"
      provides: "Gantt-style timeline bars showing agent execution overlap"
      contains: "ExecutionTimeline"
    - path: "frontend/src/lib/api/confirmations.ts"
      provides: "API client for sending confirmation responses"
      contains: "respondToConfirmation"
    - path: "frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx"
      provides: "Token usage section and execution timeline integrated into sidebar"
      contains: "inputTokens"
    - path: "frontend/src/components/CommandCenter/DecisionNode.tsx"
      provides: "Duration badge on agent nodes"
      contains: "durationMs"
  key_links:
    - from: "frontend/src/components/CommandCenter/ConfirmationModal.tsx"
      to: "frontend/src/lib/api/confirmations.ts"
      via: "respondToConfirmation called on approve/reject"
      pattern: "respondToConfirmation"
    - from: "frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx"
      to: "frontend/src/types/command-center.ts"
      via: "metadata.inputTokens, metadata.outputTokens, metadata.durationMs"
      pattern: "inputTokens.*outputTokens"
    - from: "frontend/src/components/CommandCenter/DecisionNode.tsx"
      to: "frontend/src/types/command-center.ts"
      via: "DecisionNodeData.agentState.lastResult.metadata.durationMs"
      pattern: "durationMs"
---

<objective>
Build frontend HITL confirmation modal, token usage display, duration badges, and execution timeline Gantt chart.

Purpose: The backend HITL system (Plan 02) and enriched SSE events (Plans 01, 03) provide all the data. This plan builds the UI to display it: a confirmation modal for sensitive agent actions, per-agent token usage in the sidebar, duration badges on decision tree nodes, and a Gantt-style execution timeline showing parallel agent execution.

Output: Complete Phase 5 frontend with full transparency: thinking traces streaming, token metrics, timing visualization, and HITL confirmation flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-flow/05-CONTEXT.md
@.planning/phases/05-agent-flow/05-RESEARCH.md
@.planning/phases/05-agent-flow/05-01-SUMMARY.md
@.planning/phases/05-agent-flow/05-02-SUMMARY.md
@.planning/phases/05-agent-flow/05-03-SUMMARY.md

@frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
@frontend/src/components/CommandCenter/DecisionNode.tsx
@frontend/src/components/CommandCenter/CommandCenter.tsx
@frontend/src/app/(app)/cases/[id]/command-center/page.tsx
@frontend/src/hooks/useAgentStates.ts
@frontend/src/types/command-center.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: HITL confirmation modal and API client</name>
  <files>
    frontend/src/components/CommandCenter/ConfirmationModal.tsx
    frontend/src/lib/api/confirmations.ts
    frontend/src/components/CommandCenter/CommandCenter.tsx
    frontend/src/app/(app)/cases/[id]/command-center/page.tsx
  </files>
  <action>
  **Create `frontend/src/lib/api/confirmations.ts`:**

  API client for confirmation responses:
  ```typescript
  const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8080";

  export async function respondToConfirmation(
    caseId: string,
    requestId: string,
    approved: boolean,
    reason?: string,
  ): Promise<{ status: string; approved: boolean }> {
    const res = await fetch(
      `${API_URL}/api/cases/${caseId}/confirmations/${requestId}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ approved, reason }),
      },
    );
    if (!res.ok) throw new Error(`Confirmation failed: ${res.status}`);
    return res.json();
  }
  ```

  Add ABOUTME comment.

  **Create `frontend/src/components/CommandCenter/ConfirmationModal.tsx`:**

  Per CONTEXT.md: "Modal dialog: centered overlay with context about what the agent wants to do, Approve/Reject buttons, optional reason field."

  Props:
  - `confirmation: ConfirmationRequiredEvent` -- the pending confirmation data
  - `caseId: string` -- for the API call
  - `onResolved: (requestId: string) => void` -- callback to remove from pending list

  Component:
  1. Centered modal overlay with dark semi-transparent backdrop (no clicking outside to dismiss -- important agent decision)
  2. Header: agent type name + icon (use AGENT_CONFIGS for name/color lookup)
  3. Body:
     - "Action requested" label with the `actionDescription` text
     - "Affected items" list showing each item in `affectedItems`
     - Additional context displayed as key-value pairs from `context`
  4. Optional reason textarea: label "Reason (optional)", placeholder "Provide context for your decision..."
  5. Footer: two buttons:
     - "Reject" (outline style, stone/gray) -- calls `respondToConfirmation(caseId, requestId, false, reason)` and then `onResolved(requestId)`
     - "Approve" (solid, teal/accent colored) -- calls `respondToConfirmation(caseId, requestId, true, reason)` and then `onResolved(requestId)`
  6. Loading state on buttons during API call (disable both while submitting)
  7. Style: dark glass background matching Command Center aesthetic. Use the scoped CC variables where appropriate.
  8. Use `motion` for entrance animation (fade in + scale up, 200ms)

  Add ABOUTME comment.

  **In `frontend/src/app/(app)/cases/[id]/command-center/page.tsx`:**

  1. The `pendingConfirmations` state comes from `useAgentStates` (added in Plan 03). If the first pending confirmation exists, render `<ConfirmationModal>` with it.
  2. Pattern: `{pendingConfirmations.length > 0 && <ConfirmationModal confirmation={pendingConfirmations[0]} caseId={caseId} onResolved={handleConfirmationResolved} />}`
  3. Add `handleConfirmationResolved` that removes the confirmation from the pending list (this might already be handled by the SSE confirmation-resolved event in useAgentStates, but provide a local handler as fallback).

  **Notification badge on Command Center tab:**

  Per CONTEXT.md: "Visual notification badge/pulse on Command Center tab/nav item when confirmation is pending and user is on another page."

  Look at the case layout file (`frontend/src/app/(app)/cases/[id]/layout.tsx`) and the tab bar component (`frontend/src/components/ui/expandable-tabs.tsx`). The Command Center tab needs a badge count.

  Approach: Use a lightweight approach -- either:
  - a) Store pending confirmation count in a React context at the layout level, or
  - b) Expose `get_pending_confirmation_count()` via a simple API endpoint and poll it

  For hackathon simplicity, use approach (b): poll `GET /api/cases/{caseId}/confirmations/pending` every 10 seconds from the layout level when NOT on the command center page, and show a badge on the tab. OR, even simpler: the pending confirmations SSE events are only received when on the Command Center page (since the EventSource is in the CC component). For cross-page notification, add a simple fetch in the layout that polls every 10s.

  If adding polling is too complex for this task, just add the badge rendering support to the tab component and note it as wired when user is on the CC page (the full cross-page notification can be a follow-up).
  </action>
  <verify>
  - `cd frontend && npx tsc --noEmit --pretty` succeeds
  - Grep for modal: `grep -n "ConfirmationModal" frontend/src/components/CommandCenter/ConfirmationModal.tsx` shows the component
  - Grep for API client: `grep -n "respondToConfirmation" frontend/src/lib/api/confirmations.ts` shows the function
  - Grep for modal usage: `grep -n "ConfirmationModal" frontend/src/app/\(app\)/cases/\[id\]/command-center/page.tsx` shows it rendered
  </verify>
  <done>
  - Confirmation modal renders centered overlay with action context, affected items, reason field, approve/reject buttons
  - API client sends POST to backend confirmation endpoint
  - Modal shown on command-center page when pending confirmation exists
  - Motion entrance animation on modal
  </done>
</task>

<task type="auto">
  <name>Task 2: Token usage display, duration badges, and execution timeline</name>
  <files>
    frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
    frontend/src/components/CommandCenter/DecisionNode.tsx
    frontend/src/components/CommandCenter/ExecutionTimeline.tsx
  </files>
  <action>
  **Create `frontend/src/components/CommandCenter/ExecutionTimeline.tsx`:**

  Per CONTEXT.md: "Gantt-style execution timeline in sidebar showing agent execution overlap to visualize parallelism."

  Props:
  - `agentStates: Map<AgentType, AgentState>` -- all agent states with timing data

  Component:
  1. Extract timing data from each agent's `lastResult.metadata` (startedAt, completedAt, durationMs)
  2. Only render agents that have timing data (status completed or processing)
  3. Compute timeline scale: earliest start to latest end across all agents
  4. For each agent, render a horizontal bar:
     - Left offset = (agent startedAt - earliest start) / total duration * 100%
     - Width = agent durationMs / total duration * 100%
     - Color = agent's tint color from `getAgentColors(agentType)`
     - Label = agent config name + duration text (e.g., "3.2s")
  5. Simple CSS implementation -- no chart library needed (RESEARCH.md: "Simple CSS/HTML Gantt bars, small dataset 5-8 agents, no library needed")
  6. Stack bars vertically, one row per agent
  7. Time axis labels at top: "0s", midpoint, total duration
  8. If only 1-2 agents (current state: triage + orchestrator), still render as sequential bars. The component will become visually useful when domain agents (Phase 6) add parallelism.

  Add ABOUTME comment.

  **In `frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx`:**

  1. Add a "Token Usage" `CollapsibleSection` that displays per-agent token metrics. Place it after the Thinking Traces section. Show:
     - Input tokens (from `result.metadata?.inputTokens as number`)
     - Output tokens (from `result.metadata?.outputTokens as number`)
     - Model name (from `result.metadata?.model as string`)
     - Display as a compact 2-column grid:
       - "Input Tokens" | formatted number
       - "Output Tokens" | formatted number
       - "Model" | model string
     - Use the `BarChart3` icon (already imported) for the section

  2. Add a "Timing" `CollapsibleSection` after Token Usage. Show:
     - Duration (from `result.metadata?.durationMs as number`, format as "X.Xs" or "Xm Xs")
     - Started at (from `result.metadata?.startedAt as string`, format as time)
     - Completed at (from `result.metadata?.completedAt as string`, format as time)
     - Use the `Clock` icon (already imported) for the section

  3. Add `ExecutionTimeline` component at the bottom of the sidebar (after Processing History), only when there are 2+ agents with timing data. Pass `agentStates` as a prop (this means the sidebar needs to receive `allAgentStates` as a prop, not just the selected agent's state).

  **IMPORTANT:** The sidebar currently only receives the selected agent's `agentState`. To render the ExecutionTimeline, it needs ALL agent states. Add an optional `allAgentStates?: Map<AgentType, AgentState>` prop. If provided, render the ExecutionTimeline. Update the page.tsx to pass this prop.

  **In `frontend/src/components/CommandCenter/DecisionNode.tsx`:**

  1. Add a duration badge to the node display. When the agent has completed (`agentState.lastResult?.metadata?.durationMs`), show a small badge at the bottom-right of the node:
     - Text: formatted duration (e.g., "3.2s" or "1m 12s")
     - Style: small pill badge, semi-transparent background matching the node's tint color
     - Use `Clock` icon (3px) next to the text
     - Only show when durationMs is present and > 0

  2. Access duration from `data.agentState.lastResult?.metadata?.durationMs` in the DecisionNode component.
  </action>
  <verify>
  - `cd frontend && npx tsc --noEmit --pretty` succeeds
  - Grep for token display: `grep -n "inputTokens\|outputTokens" frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx` shows token usage section
  - Grep for duration badge: `grep -n "durationMs" frontend/src/components/CommandCenter/DecisionNode.tsx` shows badge rendering
  - Grep for ExecutionTimeline: `grep -n "ExecutionTimeline" frontend/src/components/CommandCenter/ExecutionTimeline.tsx` shows the component
  </verify>
  <done>
  - Token usage (input/output tokens, model) displayed in sidebar CollapsibleSection
  - Timing data (duration, start/end times) displayed in sidebar CollapsibleSection
  - Duration badge visible on completed agent nodes in the decision tree
  - Gantt-style ExecutionTimeline component shows agent execution bars with timing overlap visualization
  - ExecutionTimeline renders in sidebar when multiple agents have timing data
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete Phase 5 Agent Flow implementation:
  - Backend: Enriched SSE events with real-time thinking traces, token usage, timing data, state snapshots, HITL confirmation system
  - Frontend: Fixed SSE URL connection, real-time thinking trace display, token usage in sidebar, duration badges on nodes, execution timeline Gantt chart, HITL confirmation modal
  </what-built>
  <how-to-verify>
  1. Start backend server (`cd backend && uvicorn app.main:app --reload`)
  2. Start frontend (`cd frontend && bun dev`)
  3. Navigate to a case with uploaded files
  4. Open Command Center page
  5. Verify SSE connection indicator shows "Connected" (not "Demo Mode")
  6. Start analysis (if files uploaded)
  7. Verify in the command center:
     a. Agent nodes appear and animate as agents process
     b. Click a completed agent node -- sidebar should show:
        - Thinking traces section with text
        - Token Usage section with input/output token counts
        - Timing section with duration and start/end times
        - Execution Timeline at bottom showing Gantt bars
     c. Duration badge visible on completed agent nodes (e.g., "3.2s")
     d. Processing-complete summary includes total tokens and duration
  8. Test SSE reconnect: disconnect network briefly, reconnect -- agents should restore state from snapshot
  9. If no files to analyze, verify the SSE connection still works (heartbeat) and the UI doesn't crash
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit --pretty` succeeds
2. `cd frontend && npx next build` succeeds
3. `cd backend && python -m py_compile app/services/confirmation.py app/api/confirmations.py` succeeds
4. Visual verification: Command Center shows enriched data when agents complete
5. SSE connection established to correct backend URL
6. Confirmation modal renders correctly when triggered
</verification>

<success_criteria>
- HITL confirmation modal functional with approve/reject flow
- Per-agent token usage visible in sidebar
- Duration badge on completed agent nodes
- Execution timeline Gantt chart shows agent timing overlap
- Notification badge support for pending confirmations
- All frontend TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-flow/05-04-SUMMARY.md`
</output>
