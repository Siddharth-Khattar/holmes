---
phase: 06-domain-agents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/agent.py
  - backend/app/agents/factory.py
  - backend/app/agents/base.py
  - backend/app/services/adk_service.py
autonomous: true

must_haves:
  truths:
    - "Domain agents can define structured output schemas with domain-specific finding categories"
    - "Factory can create domain agent LlmAgent instances with generate_content_config for media_resolution"
    - "Video files are always routed through File API regardless of size for VideoMetadata compatibility"
  artifacts:
    - path: "backend/app/schemas/agent.py"
      provides: "Citation, Finding, DomainEntity, HypothesisEvaluation, FinancialOutput, LegalOutput, EvidenceOutput, StrategyOutput schemas"
      contains: "class Citation"
    - path: "backend/app/agents/factory.py"
      provides: "create_financial_agent, create_legal_agent, create_evidence_agent, create_strategy_agent factory methods"
      contains: "create_financial_agent"
    - path: "backend/app/agents/base.py"
      provides: "CONFIDENCE_THRESHOLD constant for HITL triggers"
      contains: "CONFIDENCE_THRESHOLD"
  key_links:
    - from: "backend/app/agents/factory.py"
      to: "backend/app/schemas/agent.py"
      via: "import output schema types"
      pattern: "from app.schemas.agent import.*FinancialOutput"
    - from: "backend/app/agents/factory.py"
      to: "backend/app/agents/base.py"
      via: "import create_thinking_planner, MODEL_PRO, MODEL_FLASH"
      pattern: "from app.agents.base import"
---

<objective>
Define all domain agent output schemas, entity taxonomies, and extend the agent factory with domain agent creation methods. This is the shared foundation that all domain agent execution functions depend on.

Purpose: Establish the type-safe contracts (Pydantic schemas) and LlmAgent instantiation patterns that Plans 02-05 consume. Without these, no domain agent can be created or produce structured output.

Output: Extended `schemas/agent.py` with 4 domain output types + shared types; extended `factory.py` with 4 factory methods; updated `_create_llm_agent` to support `generate_content_config`; updated `adk_service.py` with video-aware file preparation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-domain-agents/06-CONTEXT.md
@.planning/phases/06-domain-agents/06-RESEARCH.md

@backend/app/schemas/agent.py
@backend/app/agents/factory.py
@backend/app/agents/base.py
@backend/app/services/adk_service.py
@backend/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain output schemas and shared types in schemas/agent.py</name>
  <files>backend/app/schemas/agent.py</files>
  <action>
Add the following Pydantic models to `backend/app/schemas/agent.py`, BELOW the existing OrchestratorOutput and ABOVE the CRUD schemas section:

**Shared types (used by all domain agents):**

1. `Citation` -- Span-level citation for a finding:
   - `file_id: str` (ID of the source file)
   - `locator: str` (Exact location: "page:3", "ts:01:23:45", "region:x,y,w,h")
   - `excerpt: str | None` (Relevant text excerpt, max 500 chars)

2. `DomainEntity` -- Entity extracted by a domain agent:
   - `type: str` (Domain-specific entity type -- NOT a fixed Literal because each domain has its own taxonomy + "other" overflow per CONTEXT.md)
   - `value: str` (Extracted entity value)
   - `context: str | None` (Surrounding text for disambiguation)
   - `confidence: float` (0-100, agent self-assessed)
   - `metadata: dict[str, object]` (Domain-dependent metadata depth, default_factory=dict)

3. `Finding` -- A single domain-specific finding with citations:
   - `category: str` (Domain-specific category name, e.g. "Transactions", "Contract Obligations")
   - `title: str` (max 200 chars)
   - `description: str` (max 2000 chars)
   - `confidence: float` (0-100, ge=0, le=100)
   - `citations: list[Citation]` (default_factory=list)
   - `entities: list[DomainEntity]` (default_factory=list)

4. `HypothesisEvaluation` -- Agent's evaluation of an existing hypothesis:
   - `hypothesis_id: str`
   - `stance: Literal["supports", "contradicts", "neutral"]`
   - `confidence: float` (0-100)
   - `reasoning: str` (max 2000 chars)
   - `citations: list[Citation]` (default_factory=list)

**Per-domain output models (all follow same pattern):**

5. `FinancialOutput`:
   - `findings: list[Finding]` (default_factory=list)
   - `hypothesis_evaluations: list[HypothesisEvaluation]` (default_factory=list)
   - `entities: list[DomainEntity]` (default_factory=list, top-level extracted entities)
   - `no_findings_explanation: str | None` (default=None, explanation when agent finds nothing relevant)
   - `extraction_mode: Literal["dense", "curated"]` (default="curated")
   Financial entity taxonomy types (document in docstring): monetary_amount, account, transaction, asset, financial_instrument, tax_record + "other"
   Financial finding categories (document in docstring): Transactions, Account Relationships, Anomalies, Valuations, Cash Flow Patterns

6. `LegalOutput` -- Same structure as FinancialOutput.
   Legal entity taxonomy: statute, case_citation, contract, legal_term, court, obligation, party, clause + "other"
   Legal finding categories: Contract Obligations, Regulatory Compliance, Legal Risks, Precedents, Violations

7. `EvidenceOutput` -- Same structure as FinancialOutput PLUS:
   - `quality_assessment: EvidenceQualityAssessment | None` (default=None)
   Where `EvidenceQualityAssessment` is a nested model with:
   - `overall_score: float` (0-100, single composite quality score per CONTEXT.md)
   - `authenticity_concerns: list[str]`
   - `custody_chain_complete: bool`
   - `custody_gaps: list[str]`
   - `corroboration_status: Literal["strong", "moderate", "weak", "uncorroborated"]`
   - `recommendation: Literal["ADMIT", "VERIFY", "CHALLENGE", "EXCLUDE"]`
   Evidence entity taxonomy: communication, alias, vehicle, property, timestamp, physical_evidence, digital_artifact, witness + "other"
   Evidence finding categories: Authenticity Analysis, Chain of Custody, Corroboration, Digital Forensics, Physical Evidence

8. `StrategyOutput` -- Same base structure as FinancialOutput PLUS:
   - `domain_agent_summaries_received: list[str]` (default_factory=list, names of domain agents whose summaries were incorporated)
   Strategy entity taxonomy: strategic_decision, organizational_unit, stakeholder, objective, risk_factor + "other"
   Strategy finding categories: Case Strengths, Case Weaknesses, Investigation Priorities, Strategic Recommendations, Risk Assessment

All field descriptions should use Field(..., description="...") for self-documenting schemas.

**IMPORTANT:** Do NOT modify existing TriageOutput, OrchestratorOutput, or CRUD schemas. Only ADD new models below the existing orchestrator section.
  </action>
  <verify>
Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && python -c "from app.schemas.agent import Citation, Finding, DomainEntity, HypothesisEvaluation, FinancialOutput, LegalOutput, EvidenceOutput, StrategyOutput, EvidenceQualityAssessment; print('All schemas imported successfully')"` and verify no import errors.
  </verify>
  <done>
All 4 domain output schemas + shared types (Citation, DomainEntity, Finding, HypothesisEvaluation, EvidenceQualityAssessment) defined with proper Field descriptions and domain-specific documentation. Existing schemas untouched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Factory extension and infrastructure updates</name>
  <files>
    backend/app/agents/factory.py
    backend/app/agents/base.py
    backend/app/services/adk_service.py
  </files>
  <action>
**2a. Update `_create_llm_agent` in `factory.py`:**

Add an optional `generate_content_config` parameter to `_create_llm_agent`:
```python
def _create_llm_agent(
    *,
    name: str,
    model: str,
    instruction: str,
    planner: BuiltInPlanner,
    output_schema: type[BaseModel],
    output_key: str,
    callbacks: AgentCallbacks | None,
    generate_content_config: types.GenerateContentConfig | None = None,
) -> LlmAgent:
```
If `generate_content_config` is not None, include it in `base_kwargs`. Import `types` from `google.genai`.

**2b. Add 4 domain agent factory methods to `AgentFactory` in `factory.py`:**

Add imports at top: the 4 domain prompt constants (from prompts modules that Plan 02 creates -- use placeholder string if prompt module doesn't exist yet; this plan may run in parallel with Plan 02), the 4 domain output schemas.

For the imports of prompts: use a conditional import pattern. If the prompt module exists, import from it. Otherwise define a placeholder constant. This handles parallel plan execution.

Actually, since Wave 1 plans may execute in parallel, and the prompt modules are created in Plan 02, use lazy imports inside each factory method to avoid import-time failures:

```python
@staticmethod
def create_financial_agent(
    case_id: str,
    *,
    model: str = MODEL_PRO,
    publish_fn: PublishFn | None = None,
) -> LlmAgent:
    from app.agents.prompts.financial import FINANCIAL_SYSTEM_PROMPT
    from app.schemas.agent import FinancialOutput

    callbacks = create_agent_callbacks(case_id, publish_fn) if publish_fn else None
    return _create_llm_agent(
        name=_safe_name("financial", case_id),
        model=model,
        instruction=FINANCIAL_SYSTEM_PROMPT,
        planner=create_thinking_planner("high"),
        output_schema=FinancialOutput,
        output_key="financial_result",
        callbacks=callbacks,
        generate_content_config=types.GenerateContentConfig(
            media_resolution=types.MediaResolution.MEDIA_RESOLUTION_HIGH,
        ),
    )
```

Repeat for legal (HIGH media_resolution), evidence (HIGH media_resolution), and strategy (MEDIUM media_resolution -- strategy processes playbooks/docs, not dense scanned content).

Strategy agent gets `model=MODEL_PRO` as default. All agents use `thinking_level="high"`.

**2c. Add `CONFIDENCE_THRESHOLD` constant to `base.py`:**

Add near the model constants section:
```python
# Low-confidence finding threshold for HITL confirmation triggers.
# Findings with confidence below this value (0-100) require user review.
# Configurable per deployment; not surfaced in UI.
CONFIDENCE_THRESHOLD: int = 40
```

**2d. Update `adk_service.py` for video-aware file preparation:**

Add a new function `build_domain_agent_content` that forces video/audio files through the File API regardless of size (to avoid the VideoMetadata + inline data 500 error, per RESEARCH.md Pitfall 6):

```python
async def build_domain_agent_content(
    files: list[CaseFile],
    gcs_bucket: str,
    prompt: str,
) -> types.Content:
    """Build multimodal content for domain agents.

    Unlike build_agent_content (used by triage), this function forces
    video and audio files through the File API regardless of size.
    VideoMetadata is more reliable with File API URI references than
    with inline data (known Gemini API issue).
    """
    parts: list[types.Part] = [types.Part(text=prompt)]

    for f in files:
        parts.append(
            types.Part(text=f"\n\n--- File: {f.original_filename} (ID: {f.id}) ---")
        )
        # Force File API for video/audio regardless of size
        if f.mime_type.startswith(("video/", "audio/")):
            file_part = await prepare_file_via_api(
                gcs_bucket, f.storage_path, f.mime_type, f.original_filename
            )
        else:
            file_part = await prepare_file_for_agent(f, gcs_bucket)
        parts.append(file_part)

    return types.Content(role="user", parts=parts)
```

This does NOT modify the existing `build_agent_content` function -- it is a new function alongside it.
  </action>
  <verify>
Run from the backend directory:
1. `python -c "from app.agents.factory import AgentFactory; print(dir(AgentFactory))"` -- verify create_financial_agent, create_legal_agent, create_evidence_agent, create_strategy_agent methods appear.
2. `python -c "from app.agents.base import CONFIDENCE_THRESHOLD; print(f'Threshold: {CONFIDENCE_THRESHOLD}')"` -- verify constant exists.
3. `python -c "from app.services.adk_service import build_domain_agent_content; print('domain content builder imported')"` -- verify function exists.
4. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` (frontend should still pass since we only touched backend).
  </verify>
  <done>
- `_create_llm_agent` accepts optional `generate_content_config` parameter
- 4 domain agent factory methods exist with correct model/thinking/media_resolution settings
- `CONFIDENCE_THRESHOLD` constant defined in base.py
- `build_domain_agent_content` function in adk_service.py forces video/audio through File API
- All existing factory methods (triage, orchestrator) remain unchanged
  </done>
</task>

</tasks>

<verification>
- All new Pydantic models importable without errors
- Factory methods exist and are callable (will fail at runtime without prompts, but importable)
- No existing schemas or factory methods modified (backward compatible)
- Type checks pass for all modified files
</verification>

<success_criteria>
- 4 domain output schemas defined with domain-specific entity taxonomies and finding categories
- Shared types (Citation, Finding, DomainEntity, HypothesisEvaluation) used by all domain outputs
- EvidenceQualityAssessment nested model for Evidence agent's quality scoring
- Factory has 4 new static methods with correct generate_content_config for media_resolution
- CONFIDENCE_THRESHOLD = 40 available for HITL integration
- Video/audio files always routed through File API in domain agent content builder
</success_criteria>

<output>
After completion, create `.planning/phases/06-domain-agents/06-01-SUMMARY.md`
</output>
