---
phase: 06-domain-agents
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/agents/prompts/financial.py
  - backend/app/agents/prompts/legal.py
  - backend/app/agents/prompts/evidence.py
  - backend/app/agents/prompts/strategy.py
autonomous: true

must_haves:
  truths:
    - "Each domain agent has a detailed system prompt guiding analysis, entity extraction, and hypothesis evaluation"
    - "Prompts instruct agents to output structured JSON matching their Pydantic schema"
    - "Evidence agent prompt covers authenticity, custody, and corroboration analysis"
    - "Strategy agent prompt operates on domain agent findings summaries, not raw files"
    - "All prompts include hypothesis evaluation instructions"
  artifacts:
    - path: "backend/app/agents/prompts/financial.py"
      provides: "FINANCIAL_SYSTEM_PROMPT constant"
      contains: "FINANCIAL_SYSTEM_PROMPT"
    - path: "backend/app/agents/prompts/legal.py"
      provides: "LEGAL_SYSTEM_PROMPT constant"
      contains: "LEGAL_SYSTEM_PROMPT"
    - path: "backend/app/agents/prompts/evidence.py"
      provides: "EVIDENCE_SYSTEM_PROMPT constant"
      contains: "EVIDENCE_SYSTEM_PROMPT"
    - path: "backend/app/agents/prompts/strategy.py"
      provides: "STRATEGY_SYSTEM_PROMPT constant"
      contains: "STRATEGY_SYSTEM_PROMPT"
  key_links:
    - from: "backend/app/agents/prompts/financial.py"
      to: "backend/app/schemas/agent.py"
      via: "prompt describes expected JSON output matching FinancialOutput schema"
      pattern: "findings.*category.*title.*confidence"
---

<objective>
Create domain-specific system prompts for all four agents: Financial, Legal, Evidence, and Legal Strategy. Each prompt defines the agent's analysis scope, entity taxonomy, finding categories, hypothesis evaluation instructions, and output JSON schema.

Purpose: Prompts are the core intelligence of each agent. They determine extraction quality, entity coverage, and finding structure. Prompt modules are separate from agent logic per the established pattern (see triage.py, orchestrator.py prompts).

Output: 4 new Python files in `backend/app/agents/prompts/`, each exporting a single constant string.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-domain-agents/06-CONTEXT.md
@.planning/phases/06-domain-agents/06-RESEARCH.md

@backend/app/agents/prompts/triage.py
@backend/app/agents/prompts/orchestrator.py
@backend/app/schemas/agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Financial and Legal agent prompts</name>
  <files>
    backend/app/agents/prompts/financial.py
    backend/app/agents/prompts/legal.py
  </files>
  <action>
Create `backend/app/agents/prompts/financial.py` with `FINANCIAL_SYSTEM_PROMPT` following the same pattern as triage.py and orchestrator.py prompts (ABOUTME header, single string constant, triple-quoted).

**Financial Agent prompt must instruct the model to:**

1. **Role**: Financial Analysis Agent for Holmes investigative intelligence platform. Receives evidence files and produces deep financial analysis with structured findings and entity extraction.

2. **Analysis Responsibilities:**
   - Transaction analysis (identify flows, patterns, anomalies)
   - Account relationship mapping (linked accounts, hidden connections)
   - Valuation assessment (asset values, discrepancies)
   - Cash flow pattern detection (irregular patterns, structuring)
   - Financial anomaly identification (round-tripping, layering, timing patterns)

3. **Entity Taxonomy (domain-specific types):**
   | Type | Description |
   | monetary_amount | Specific dollar values, sums, totals |
   | account | Bank accounts, investment accounts, crypto wallets |
   | transaction | Transfers, payments, deposits, withdrawals |
   | asset | Properties, vehicles, investments, holdings |
   | financial_instrument | Stocks, bonds, derivatives, insurance policies |
   | tax_record | Tax filings, deductions, declared income |
   | other | Entities outside the financial taxonomy |

4. **Finding Categories:**
   Transactions, Account Relationships, Anomalies, Valuations, Cash Flow Patterns

5. **Hypothesis Evaluation:**
   - "You will receive a list of existing hypotheses. For each hypothesis, evaluate whether your financial findings SUPPORT, CONTRADICT, or are NEUTRAL toward it."
   - "Provide reasoning and citations for each evaluation."
   - "If no hypotheses are provided, skip the hypothesis_evaluations section."

6. **Confidence Scoring:**
   - Each finding must have a confidence score (0-100)
   - Based on evidence strength, source reliability, and corroboration
   - Findings below 40 confidence will be flagged for human review

7. **Citation Requirements:**
   - Every finding MUST have at least one citation
   - Locator format: "page:N", "ts:HH:MM:SS", "region:x,y,w,h"
   - Include excerpt when helpful

8. **"No Findings" Handling:**
   - If a file has no financially relevant content, set `no_findings_explanation` explaining why
   - Still produce an output record -- do NOT return empty

9. **Extraction Mode:**
   - extraction_mode will be set to "dense" or "curated" in the prompt context
   - "dense": Extract ALL financial data points, maximize graph richness
   - "curated": Extract only high-confidence, high-signal findings (default)

10. **Constraints:**
    - Do NOT perform legal or strategic analysis
    - Do NOT detect contradictions across files (that's Synthesis Agent's job)
    - Focus exclusively on financial domain expertise
    - Handle ALL file types (PDFs, images of statements, video depositions about finances)
    - Request speaker diarization for audio/video content (best-effort)

11. **Output format:** Raw JSON matching FinancialOutput schema. Same "no code fences, no commentary" instruction as triage/orchestrator prompts.

---

Create `backend/app/agents/prompts/legal.py` with `LEGAL_SYSTEM_PROMPT` following the same structure.

**Legal Agent prompt specific instructions:**

1. **Role**: Legal Analysis Agent. Deep analysis of legal documents, contracts, regulatory compliance.

2. **Analysis Responsibilities:**
   - Contract obligation identification (terms, conditions, deadlines)
   - Regulatory compliance assessment (which regulations apply, compliance status)
   - Legal risk identification (exposure, liability, precedent)
   - Precedent analysis (relevant cases, citations)
   - Violation detection (breaches, non-compliance, fraud indicators)

3. **Entity Taxonomy:**
   | Type | Description |
   | statute | Laws, regulations, codes |
   | case_citation | Court cases, legal precedents |
   | contract | Agreements, MOUs, NDAs |
   | legal_term | Specific legal concepts, doctrines |
   | court | Courts, jurisdictions, tribunals |
   | obligation | Duties, requirements, deadlines |
   | party | Named parties to legal matters |
   | clause | Specific contract clauses, sections |
   | other | Entities outside the legal taxonomy |

4. **Finding Categories:**
   Contract Obligations, Regulatory Compliance, Legal Risks, Precedents, Violations

5. Same hypothesis evaluation, confidence scoring, citation requirements, no-findings handling, extraction mode, and constraints pattern as Financial prompt. Legal-specific constraint: "Do NOT perform financial analysis or strategic assessment."

6. **Additional legal-specific instructions:**
   - Pay special attention to dates/deadlines in legal documents (statute of limitations, filing deadlines)
   - Flag ambiguous or conflicting contractual language
   - Note jurisdiction-specific considerations
   - For audio/video: identify testimony relevant to legal issues, request speaker identification
  </action>
  <verify>
Run from the backend directory:
1. `python -c "from app.agents.prompts.financial import FINANCIAL_SYSTEM_PROMPT; print(f'Financial prompt length: {len(FINANCIAL_SYSTEM_PROMPT)} chars')"` -- should be substantial (2000+ chars).
2. `python -c "from app.agents.prompts.legal import LEGAL_SYSTEM_PROMPT; print(f'Legal prompt length: {len(LEGAL_SYSTEM_PROMPT)} chars')"` -- should be substantial.
3. Verify both contain "hypothesis_evaluations" in the text.
  </verify>
  <done>
Financial and Legal system prompts created with domain-specific entity taxonomies, finding categories, hypothesis evaluation instructions, confidence scoring guidance, and structured JSON output format matching their respective Pydantic schemas.
  </done>
</task>

<task type="auto">
  <name>Task 2: Evidence and Strategy agent prompts</name>
  <files>
    backend/app/agents/prompts/evidence.py
    backend/app/agents/prompts/strategy.py
  </files>
  <action>
Create `backend/app/agents/prompts/evidence.py` with `EVIDENCE_SYSTEM_PROMPT`.

**Evidence Agent prompt specific instructions:**

1. **Role**: Evidence Analysis Agent. Critical evidence evaluation, authenticity verification, chain of custody, and forensic analysis. This is the most forensically rigorous agent.

2. **Analysis Responsibilities:**
   - **Authenticity Analysis**: Image manipulation detection (splicing, cloning, retouching), document alteration signs (font inconsistencies, alignment issues), video editing artifacts (jump cuts, frame manipulation)
   - **Metadata Consistency**: Creation/modification timestamps vs claimed dates, device/software fingerprints, GPS/location data validation, author/creator information
   - **Chain of Custody**: Evidence provenance trail documentation, gaps in custody, unclear origin flags, handling/storage condition assessment
   - **Corroboration Analysis**: Cross-reference against other case materials, identify supporting evidence for key claims, detect contradicting evidence, calculate corroboration scores
   - **Quality Assessment**: Produce a single composite quality score (0-100) per file, with authenticity concerns, custody completeness, corroboration status, and recommendation (ADMIT/VERIFY/CHALLENGE/EXCLUDE)

3. **Entity Taxonomy:**
   | Type | Description |
   | communication | Emails, messages, phone calls, letters |
   | alias | Alternative names, pseudonyms, screen names |
   | vehicle | Cars, boats, aircraft (registrations, plates) |
   | property | Real estate, physical locations, addresses |
   | timestamp | Specific dates/times with evidentiary significance |
   | physical_evidence | Tangible items (documents, devices, objects) |
   | digital_artifact | Digital files, metadata, logs, traces |
   | witness | Identified witnesses or testimony sources |
   | other | Entities outside the evidence taxonomy |

4. **Finding Categories:**
   Authenticity Analysis, Chain of Custody, Corroboration, Digital Forensics, Physical Evidence

5. Same hypothesis evaluation, confidence scoring, citation requirements, no-findings handling, and extraction mode pattern.

6. **Evidence-specific constraints:**
   - "You are the most forensically rigorous agent. Apply maximum scrutiny."
   - "For audio/video: request speaker diarization (identify who is speaking). Mark diarization-based findings with lower confidence since quality varies."
   - "For images: look for manipulation artifacts, metadata inconsistencies, EXIF data clues."
   - "Do NOT perform financial, legal, or strategic analysis."

7. **Quality Assessment output:** Instruct the model to always produce the `quality_assessment` object with `overall_score`, `authenticity_concerns`, `custody_chain_complete`, `custody_gaps`, `corroboration_status`, and `recommendation`.

---

Create `backend/app/agents/prompts/strategy.py` with `STRATEGY_SYSTEM_PROMPT`.

**Strategy (Legal Strategy) Agent -- CRITICAL DIFFERENCES from other agents:**

1. **Role**: Legal Strategy Agent. NOT an evidence analysis agent. Handles legal strategy for the case: case approach planning, strengths/weaknesses assessment, investigation priorities.

2. **Input Context**: Unlike other domain agents, the Strategy agent receives:
   - Its own routed files (firm playbooks, internal strategy docs, communications)
   - TEXT SUMMARIES of findings from Financial, Legal, and Evidence agents (NOT the raw files those agents processed)
   - The prompt must explain this: "You will receive strategy-relevant files AND text summaries from other domain agents. Use the summaries to inform your strategic assessment."

3. **Analysis Responsibilities:**
   - Case strengths and weaknesses assessment
   - Investigation priority recommendations
   - Strategic risk evaluation
   - Recommendation synthesis (what to pursue, what to deprioritize)
   - Integration of financial, legal, and evidence insights into coherent strategy

4. **Entity Taxonomy:**
   | Type | Description |
   | strategic_decision | Key decisions, rulings, choices |
   | organizational_unit | Departments, teams, divisions |
   | stakeholder | Interested parties, decision-makers |
   | objective | Goals, targets, milestones |
   | risk_factor | Identified risks, vulnerabilities |
   | other | Entities outside the strategy taxonomy |

5. **Finding Categories:**
   Case Strengths, Case Weaknesses, Investigation Priorities, Strategic Recommendations, Risk Assessment

6. **Strategy-specific constraints:**
   - "You are a LEGAL STRATEGY agent, not an evidence analyst."
   - "Your output informs investigation direction, not forensic conclusions."
   - "Inter-agent communication (querying other agents directly) is NOT available yet. Use the summaries provided."
   - "Do NOT re-analyze raw evidence -- rely on domain agent summaries for those insights."

7. **Additional field**: `domain_agent_summaries_received` -- list of agent names whose summaries were included in the context. The prompt should instruct: "List which domain agent summaries you received in the domain_agent_summaries_received field."

8. Same hypothesis evaluation, confidence scoring, citation requirements, no-findings handling pattern. Strategy agent citations point to its own files (playbooks, strategy docs), not to files other agents processed.
  </action>
  <verify>
Run from the backend directory:
1. `python -c "from app.agents.prompts.evidence import EVIDENCE_SYSTEM_PROMPT; print(f'Evidence prompt length: {len(EVIDENCE_SYSTEM_PROMPT)} chars')"` -- should be substantial.
2. `python -c "from app.agents.prompts.strategy import STRATEGY_SYSTEM_PROMPT; print(f'Strategy prompt length: {len(STRATEGY_SYSTEM_PROMPT)} chars')"` -- should be substantial.
3. `python -c "from app.agents.prompts.evidence import EVIDENCE_SYSTEM_PROMPT; assert 'quality_assessment' in EVIDENCE_SYSTEM_PROMPT; print('quality_assessment found')"` -- evidence prompt mentions quality assessment.
4. `python -c "from app.agents.prompts.strategy import STRATEGY_SYSTEM_PROMPT; assert 'domain_agent_summaries' in STRATEGY_SYSTEM_PROMPT; print('domain summaries found')"` -- strategy prompt mentions domain agent summaries.
  </verify>
  <done>
Evidence and Strategy system prompts created. Evidence prompt covers authenticity analysis, chain of custody, corroboration, digital forensics with quality assessment output. Strategy prompt designed for legal strategy (NOT evidence analysis), receives domain agent summaries as text input, and focuses on case strengths/weaknesses/priorities.
  </done>
</task>

</tasks>

<verification>
- All 4 prompt modules importable without errors
- Each prompt contains domain-specific entity taxonomy documentation
- Each prompt includes hypothesis evaluation instructions
- Each prompt specifies raw JSON output format matching its Pydantic schema
- Evidence prompt covers authenticity, custody, corroboration
- Strategy prompt references domain agent summaries as input
</verification>

<success_criteria>
- 4 prompt files exist in backend/app/agents/prompts/ (financial.py, legal.py, evidence.py, strategy.py)
- Each exports a single constant (FINANCIAL_SYSTEM_PROMPT, LEGAL_SYSTEM_PROMPT, etc.)
- Prompts are comprehensive enough to guide Gemini Pro toward high-quality domain analysis
- Entity taxonomies match what the schemas define
- Finding categories match what the schemas document
- All prompts include hypothesis evaluation section
- All prompts include confidence scoring guidance with HITL threshold mention
</success_criteria>

<output>
After completion, create `.planning/phases/06-domain-agents/06-02-SUMMARY.md`
</output>
