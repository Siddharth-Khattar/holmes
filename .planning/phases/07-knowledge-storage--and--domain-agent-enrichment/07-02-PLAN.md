---
phase: 07-knowledge-storage-and-domain-agent-enrichment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/knowledge_graph.py
  - backend/app/schemas/findings.py
  - backend/app/schemas/agent.py
  - backend/app/schemas/__init__.py
autonomous: true

must_haves:
  truths:
    - "KG API schemas define request/response models for entity CRUD, relationship CRUD, and graph data"
    - "Findings API schemas define response models for finding list/detail with citations"
    - "Domain agent output models have a new optional findings_text field"
    - "Citation model excerpt field is documented as required-in-practice (prompt enforcement) while remaining optional for backward compatibility"
    - "All new schemas are exported from schemas/__init__.py for type generation"
  artifacts:
    - path: "backend/app/schemas/knowledge_graph.py"
      provides: "KG API request/response Pydantic schemas"
      contains: "class EntityResponse"
    - path: "backend/app/schemas/findings.py"
      provides: "Findings API response schemas with search support"
      contains: "class FindingResponse"
    - path: "backend/app/schemas/agent.py"
      provides: "Enhanced domain agent schemas with findings_text"
      contains: "findings_text"
    - path: "backend/app/schemas/__init__.py"
      provides: "All new schemas exported"
      contains: "EntityResponse"
  key_links:
    - from: "backend/app/schemas/knowledge_graph.py"
      to: "backend/app/models/knowledge_graph.py"
      via: "ConfigDict(from_attributes=True) for ORM serialization"
      pattern: "from_attributes=True"
    - from: "backend/app/schemas/__init__.py"
      to: "backend/app/schemas/knowledge_graph.py"
      via: "import for type generation"
      pattern: "from app.schemas.knowledge_graph import"
---

<objective>
Create Pydantic schemas for KG and findings APIs, and enhance domain agent output schemas with `findings_text` field.

Purpose: These schemas define the API contracts that the frontend will consume and that the pipeline will produce. The `findings_text` field enriches domain agent output for downstream KG building and synthesis. All schemas must be exported for the `make generate-types` pipeline.

Output: 2 new schema files, updated agent.py, updated __init__.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-knowledge-storage--and--domain-agent-enrichment/07-RESEARCH.md
@backend/app/schemas/agent.py
@backend/app/schemas/__init__.py
@backend/app/schemas/case.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KG and findings API schemas</name>
  <files>
    backend/app/schemas/knowledge_graph.py
    backend/app/schemas/findings.py
  </files>
  <action>
    Follow the EXACT pattern from `schemas/case.py` -- BaseModel with ConfigDict(from_attributes=True) for response models, Field validators on request models.

    **backend/app/schemas/knowledge_graph.py**:

    Add 2-line ABOUTME comment.

    EntityResponse: id (UUID), case_id (UUID), name (str), name_normalized (str), entity_type (str), domain (str), confidence (float), metadata (dict | None), context (str | None), source_execution_id (UUID | None), source_finding_index (int | None), merged_into_id (UUID | None), merge_count (int), degree (int), created_at (datetime). ConfigDict(from_attributes=True).

    EntityCreateRequest: name (str, Field min_length=1, max_length=500), entity_type (str, Field min_length=1, max_length=100), domain (str, Field min_length=1, max_length=50), confidence (float, Field ge=0, le=100, default=50.0), metadata (dict | None = None), context (str | None = None).

    EntityUpdateRequest: name (str | None = None), entity_type (str | None = None), metadata (dict | None = None), context (str | None = None).

    RelationshipResponse: id (UUID), case_id (UUID), source_entity_id (UUID), target_entity_id (UUID), relationship_type (str), label (str), strength (int), source_execution_id (UUID | None), metadata (dict | None), created_at (datetime). ConfigDict(from_attributes=True).

    RelationshipCreateRequest: source_entity_id (UUID), target_entity_id (UUID), relationship_type (str, Field min_length=1, max_length=100), label (str, Field min_length=1, max_length=200), strength (int, Field ge=0, le=100, default=50), metadata (dict | None = None).

    GraphResponse: entities (list[EntityResponse]), relationships (list[RelationshipResponse]), entity_count (int), relationship_count (int).

    EntityListResponse: entities (list[EntityResponse]), total (int).

    RelationshipListResponse: relationships (list[RelationshipResponse]), total (int).

    **backend/app/schemas/findings.py**:

    Add 2-line ABOUTME comment.

    FindingCitation: file_id (str), locator (str), excerpt (str | None = None). This mirrors the agent Citation but is the DB-stored format.

    FindingResponse: id (UUID), case_id (UUID), workflow_id (UUID), agent_type (str), agent_execution_id (UUID | None), file_group_label (str | None), category (str), title (str), finding_text (str), confidence (float), citations (list[FindingCitation] | None), entity_ids (list[str] | None), created_at (datetime). ConfigDict(from_attributes=True).

    FindingListResponse: findings (list[FindingResponse]), total (int).

    FindingSearchRequest: query (str, Field min_length=1, max_length=500), limit (int, Field ge=1, le=100, default=20).

    FindingSearchResult: finding (FindingResponse), relevance_score (float).

    FindingSearchResponse: results (list[FindingSearchResult]), query (str), total (int).
  </action>
  <verify>
    Run `cd backend && python -c "from app.schemas.knowledge_graph import GraphResponse, EntityCreateRequest; from app.schemas.findings import FindingResponse, FindingSearchResponse; print('All new schemas importable')"` to confirm imports work.
  </verify>
  <done>KG and findings API schemas created with proper Pydantic models, Field validators, and ConfigDict for ORM compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Enhance domain agent schemas and update exports</name>
  <files>
    backend/app/schemas/agent.py
    backend/app/schemas/__init__.py
  </files>
  <action>
    **backend/app/schemas/agent.py changes:**

    1. Add `findings_text` field to ALL four domain output models (FinancialOutput, LegalOutput, EvidenceOutput, StrategyOutput). Place it after `findings` field in each model. Make it OPTIONAL with default=None for backward compatibility with existing agent_executions.output_data records (see RESEARCH.md Pitfall 4):

    ```python
    findings_text: str | None = Field(
        default=None,
        description="Rich markdown analysis text with inline source references. "
        "Contains the agent's full narrative analysis organized by category, "
        "with every factual claim citing the exact source excerpt. "
        "Populated by enriched domain agent prompts (Phase 7+).",
    )
    ```

    2. Update the Citation model's excerpt field docstring to emphasize the character-for-character preservation requirement (per CONTEXT.md decision). Keep the field type as `str | None` with `default=None` for backward compatibility, but update the description:

    ```python
    excerpt: str | None = Field(
        default=None,
        max_length=500,
        description="Exact character-for-character excerpt from the source material. "
        "Must be preserved in original format for PDF.js search highlighting. "
        "Required for all new findings (enforced via agent prompts).",
    )
    ```

    Do NOT change any existing field types, names, or defaults. Only ADD the new `findings_text` field and update the `excerpt` description.

    **backend/app/schemas/__init__.py changes:**

    Add imports for all new schema classes from knowledge_graph.py and findings.py. Add them to `__all__` if the file uses `__all__`. Follow the existing import/export pattern exactly.
  </action>
  <verify>
    Run `cd backend && python -c "from app.schemas.agent import FinancialOutput; f = FinancialOutput(findings=[], entities=[]); assert f.findings_text is None; print('findings_text field works with backward compat')"` to confirm backward compatibility.

    Run `cd backend && python -c "from app.schemas import EntityResponse, FindingResponse; print('All schemas exported from package')"` to confirm exports.
  </verify>
  <done>All four domain output models have findings_text field (optional, backward compatible). Citation excerpt description updated. New schemas exported from __init__.py.</done>
</task>

</tasks>

<verification>
1. All new Pydantic schemas importable from their modules
2. All new schemas exported from `app.schemas.__init__`
3. findings_text field is optional with default=None on all 4 domain outputs
4. Existing agent_executions with old output_data still parse correctly (no breaking changes)
5. KG response schemas use ConfigDict(from_attributes=True)
</verification>

<success_criteria>
- 2 new schema files (knowledge_graph.py, findings.py) with full API contract models
- 4 domain output models enhanced with findings_text field
- Citation model excerpt description updated for exactness requirement
- All schemas exported for type generation pipeline
- Zero breaking changes to existing schemas
</success_criteria>

<output>
After completion, create `.planning/phases/07-knowledge-storage--and--domain-agent-enrichment/07-02-SUMMARY.md`
</output>
