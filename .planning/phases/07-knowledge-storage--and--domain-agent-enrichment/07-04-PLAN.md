---
phase: 07-knowledge-storage-and-domain-agent-enrichment
plan: 04
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - backend/app/agents/prompts/financial.py
  - backend/app/agents/prompts/legal.py
  - backend/app/agents/prompts/evidence.py
  - backend/app/agents/prompts/strategy.py
autonomous: true

must_haves:
  truths:
    - "All 4 domain agent prompts instruct exhaustive citation with exact excerpts for every factual statement"
    - "Prompts instruct agents to produce a findings_text field with rich markdown analysis"
    - "Citation excerpts must be character-for-character exact matches from source material"
    - "Prompts specify second-level timestamps (MM:SS) for video/audio citations"
    - "No existing prompt structure is broken -- only additive instructions"
  artifacts:
    - path: "backend/app/agents/prompts/financial.py"
      provides: "Enhanced financial agent prompt with citation enrichment"
      contains: "findings_text"
    - path: "backend/app/agents/prompts/legal.py"
      provides: "Enhanced legal agent prompt with citation enrichment"
      contains: "findings_text"
    - path: "backend/app/agents/prompts/evidence.py"
      provides: "Enhanced evidence agent prompt with citation enrichment"
      contains: "findings_text"
    - path: "backend/app/agents/prompts/strategy.py"
      provides: "Enhanced strategy agent prompt with citation enrichment"
      contains: "findings_text"
  key_links:
    - from: "backend/app/agents/prompts/financial.py"
      to: "backend/app/schemas/agent.py"
      via: "Prompt references output schema fields including findings_text"
      pattern: "findings_text"
---

<objective>
Enrich all 4 domain agent prompts to produce exhaustive exact-source citations and a `findings_text` rich markdown field.

Purpose: Domain agents currently produce structured findings with optional citations. Phase 7 requires EVERY factual statement to reference exact source excerpts for downstream KG building, synthesis, and citation navigation. The `findings_text` field provides a rich narrative analysis that feeds into full-text search and the Synthesis Agent.

Output: 4 modified prompt files with citation enrichment instructions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-knowledge-storage--and--domain-agent-enrichment/07-CONTEXT.md
@.planning/phases/07-knowledge-storage--and--domain-agent-enrichment/07-RESEARCH.md
@backend/app/agents/prompts/financial.py
@backend/app/agents/prompts/legal.py
@backend/app/agents/prompts/evidence.py
@backend/app/agents/prompts/strategy.py
@backend/app/schemas/agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add citation enrichment instructions to all 4 domain agent prompts</name>
  <files>
    backend/app/agents/prompts/financial.py
    backend/app/agents/prompts/legal.py
    backend/app/agents/prompts/evidence.py
    backend/app/agents/prompts/strategy.py
  </files>
  <action>
    Read each prompt file first to understand the existing 12-section structure. Then ADD (not replace) the following enrichment instructions. The goal is to inject citation enrichment into the existing prompt without breaking the established structure.

    **For ALL 4 prompts, add a new section (insert BEFORE the output format section, typically section 11 or 12) titled "CITATION AND FINDINGS TEXT REQUIREMENTS":**

    ```
    ## CITATION AND FINDINGS TEXT REQUIREMENTS

    ### Exhaustive Citation Rules
    Every factual statement in your findings MUST have a citation. No exceptions.

    For EACH citation:
    - `file_id`: The exact file ID provided in the input
    - `locator`: Use the format:
      - PDF/documents: "page:N" (e.g., "page:3", "page:17")
      - Video: "ts:MM:SS" (e.g., "ts:01:23", "ts:00:45:12")
      - Audio: "ts:MM:SS" (e.g., "ts:05:30")
      - Images: "region:description" (e.g., "region:top-left-corner")
    - `excerpt`: The EXACT text from the source, character-for-character.
      Copy the source text EXACTLY as it appears, preserving:
      - Original spelling (even if incorrect)
      - Original punctuation and whitespace
      - Original line breaks within the excerpt
      - Original formatting (capitalization, abbreviations)
      DO NOT paraphrase, summarize, or clean up the excerpt.
      The excerpt will be used for exact-match highlighting in a PDF viewer.

    If a finding spans multiple pages or time segments, create SEPARATE citations
    for each page/segment. Do not combine into ranges.

    ### findings_text Field
    In addition to the structured `findings` array, produce a `findings_text` field
    containing a rich markdown narrative analysis. This text:
    - Organizes analysis by category (use ## headers for each category)
    - Contains detailed paragraphs explaining each finding in context
    - References specific evidence using inline notation: [Source: file_id, page:N, "exact excerpt"]
    - Connects findings to broader case implications
    - Must be comprehensive -- this is the primary text used for search indexing
      and downstream synthesis
    - Minimum 500 words for cases with substantive findings
    - Every factual claim in the narrative must reference its source

    Example findings_text format:
    ```markdown
    ## Financial Transactions

    Analysis of the bank statements (file_id: abc123, page:2) reveals a series of
    wire transfers totaling $2.3M between January and March 2025. The first transfer
    of $450,000 [Source: abc123, page:2, "Wire Transfer - $450,000.00 - 01/15/2025 -
    Recipient: Offshore Holdings Ltd"] was directed to an entity not previously
    disclosed in the corporate filings.

    ## Anomalies Detected

    A significant discrepancy exists between the reported revenue...
    ```
    ```

    **Prompt-specific adjustments:**

    For financial.py: Emphasize exact dollar amounts, account numbers, and transaction dates in excerpts. Note that financial tables should have cell-level precision in citations.

    For legal.py: Emphasize exact statute numbers, clause text, and legal terminology in excerpts. Note that legal language must be preserved character-for-character for citation accuracy.

    For evidence.py: Emphasize metadata timestamps, custody chain details, and authenticity indicators in excerpts. For video/audio evidence, use second-level timestamps.

    For strategy.py: Emphasize that strategy findings should cite both the strategic source AND the domain agent findings they reference. Strategy agent receives domain summaries, so citations should reference the original source files (not the summaries themselves).

    **Integration approach:**
    - Read each prompt file fully
    - Find the output format section (usually the last numbered section)
    - Insert the new "CITATION AND FINDINGS TEXT REQUIREMENTS" section BEFORE the output format section
    - In the output format section, add `findings_text` to the expected output fields
    - Do NOT change any existing sections -- only ADD the new section and update the output field list
    - Preserve all existing whitespace and formatting
  </action>
  <verify>
    For each prompt file, verify by reading the file and confirming:
    1. The "CITATION AND FINDINGS TEXT REQUIREMENTS" section exists
    2. The findings_text field is mentioned in the output format section
    3. All existing sections are preserved (count sections before and after -- should be exactly 1 more)
    4. No Python syntax errors: `cd backend && python -c "from app.agents.prompts.financial import FINANCIAL_AGENT_PROMPT; from app.agents.prompts.legal import LEGAL_AGENT_PROMPT; from app.agents.prompts.evidence import EVIDENCE_AGENT_PROMPT; from app.agents.prompts.strategy import STRATEGY_AGENT_PROMPT; print('All prompts importable')"` (adjust variable names if different)
  </verify>
  <done>All 4 domain agent prompts enriched with citation requirements, excerpt exactness rules, and findings_text field instructions. No existing prompt structure broken.</done>
</task>

</tasks>

<verification>
1. All 4 prompt files contain "CITATION AND FINDINGS TEXT REQUIREMENTS" section
2. Prompts specify character-for-character excerpt preservation
3. Prompts specify second-level timestamps for video/audio
4. Prompts instruct findings_text with rich markdown and inline source references
5. All existing prompt sections preserved
6. Prompts still importable without errors
</verification>

<success_criteria>
- All 4 domain agent prompts instruct exhaustive citation with exact excerpts
- findings_text field instructions present in all prompts
- Citation format specified: page:N for documents, ts:MM:SS for video/audio
- Excerpt preservation rule: character-for-character, no paraphrasing
- Backward compatible: agents with old prompts still produce valid output (findings_text will be None)
</success_criteria>

<output>
After completion, create `.planning/phases/07-knowledge-storage--and--domain-agent-enrichment/07-04-SUMMARY.md`
</output>
