---
phase: 07.1-llm-kg-builder-agent
plan: 01
subsystem: database
tags: [alembic, sqlalchemy, pydantic, gemini-structured-output, knowledge-graph]

# Dependency graph
requires:
  - phase: 07
    provides: "KgEntity, KgRelationship ORM models and initial Alembic migration"
provides:
  - "Alembic migration adding 10 new nullable columns (5 entity, 5 relationship) for LLM KG Builder"
  - "Updated ORM models with Mapped fields for aliases, descriptions, domains, evidence, temporal context"
  - "KgBuilderOutput Pydantic schema for Gemini structured output (integer ID cross-referencing)"
  - "Updated EntityResponse and RelationshipResponse with optional fields for new columns"
affects: [07.1-02, 07.2, 08]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Integer ID cross-referencing in LLM output schemas (avoids name-matching issues)"
    - "Gemini-compatible Pydantic schemas (no dict types, no additionalProperties)"

key-files:
  created:
    - "backend/alembic/versions/e4b2c1a37f90_evolve_kg_schema_for_llm_builder.py"
    - "backend/app/schemas/kg_builder.py"
  modified:
    - "backend/app/models/knowledge_graph.py"
    - "backend/app/schemas/knowledge_graph.py"
    - "packages/types/src/generated/api.ts"

key-decisions:
  - "Integer IDs for LLM entity cross-referencing instead of name matching (per RESEARCH.md Open Question 1)"
  - "All new DB columns nullable with defaults -- zero risk of breaking existing data"
  - "Existing domain (singular) and context columns kept for backward compatibility"

patterns-established:
  - "LLM output schemas use sequential integer IDs for internal cross-referencing, mapped to DB UUIDs during write"

# Metrics
duration: 4min
completed: 2026-02-08
---

# Phase 7.1 Plan 01: Schema Evolution Summary

**Alembic migration + ORM updates for 10 new KG columns, plus KgBuilderOutput Pydantic schema with integer-ID cross-referencing for Gemini structured output**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-08T11:05:52Z
- **Completed:** 2026-02-08T11:09:59Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Alembic migration adding 5 nullable columns to kg_entities (aliases, description_brief, description_detailed, domains, source_finding_ids) and 5 to kg_relationships (evidence_excerpt, source_finding_ids, temporal_context, corroboration_count, confidence)
- KgBuilderOutput/KgBuilderEntity/KgBuilderRelationship Pydantic schemas for Gemini constrained decoding with integer ID cross-referencing
- EntityResponse and RelationshipResponse updated with optional fields exposing new columns
- Frontend API types regenerated

## Task Commits

Each task was committed atomically:

1. **Task 1: DB Schema Evolution** - `a0fbfd1` (feat)
2. **Task 2: Pydantic Schemas** - `87afcd4` (feat)

## Files Created/Modified
- `backend/alembic/versions/e4b2c1a37f90_evolve_kg_schema_for_llm_builder.py` - Alembic migration adding 10 nullable columns
- `backend/app/models/knowledge_graph.py` - Updated ORM models with new Mapped fields and docstrings
- `backend/app/schemas/kg_builder.py` - KgBuilderOutput schema for LLM structured output
- `backend/app/schemas/knowledge_graph.py` - EntityResponse and RelationshipResponse with new optional fields
- `packages/types/src/generated/api.ts` - Regenerated frontend API types

## Decisions Made
- Used integer IDs (1, 2, 3...) in KgBuilderEntity for LLM cross-referencing instead of name matching, per RESEARCH.md recommendation. During DB write, these map to UUIDs.
- All new columns nullable with sensible defaults (corroboration_count defaults to 1, confidence defaults to 0.0) so existing data is unaffected.
- Kept existing `domain` (singular String) and `context` (Text) columns on KgEntity for backward compatibility alongside new `domains` (JSONB list) and `description_detailed` (Text).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Schema evolution complete; ORM models and Pydantic schemas ready for 07.1-02 (KG Builder agent runner, prompt, pipeline wiring)
- No blockers

---
*Phase: 07.1-llm-kg-builder-agent*
*Completed: 2026-02-08*
