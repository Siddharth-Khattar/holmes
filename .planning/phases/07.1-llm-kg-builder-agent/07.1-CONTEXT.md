# Phase 7.1: LLM-Based KG Builder Agent - Context

**Gathered:** 2026-02-08
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace the programmatic KG Builder with an LLM-based agent (Gemini Pro) that reads ALL domain agent outputs holistically and produces a curated knowledge graph with deduplicated entities and semantic relationships. The existing KG API endpoints (Phase 7) remain unchanged — curated data replaces noisy data in the same tables.

</domain>

<decisions>
## Implementation Decisions

### Entity Taxonomy
- 8 core types: PERSON, ORGANIZATION, LOCATION, EVENT, ASSET, FINANCIAL_ENTITY, COMMUNICATION, DOCUMENT
- Plus overflow type 'OTHER' for entities that don't fit — LLM must explain why it doesn't fit existing types
- LLM judgment call on promoting normally-metadata items (timestamps, amounts, objects) to standalone entities when investigation-critical (e.g., a central $2M wire transfer can become its own entity)

### Entity Deduplication
- Conservative merge strategy: only merge when highly confident (same full name, same role)
- Keep separate if ambiguous — more nodes but fewer mistakes
- LLM should resolve coreference when possible (e.g., 'the CEO' in doc A + 'John Smith, CEO' in doc B → merged) but only with clear textual evidence

### Entity Domain Tagging
- Multi-domain tagging: each entity gets a list of all domains it appears in (e.g., `['financial', 'legal']`)
- Not a single primary domain — entities can span multiple domains

### Entity Descriptions
- Two-tier: a brief one-liner summary AND a detailed 2-4 sentence paragraph
- One-liner for graph tooltips/cards, detailed paragraph for entity detail views
- Both synthesized from all findings mentioning the entity

### Entity Scoring
- Confidence score (0-100): LLM-assigned, how sure we are the entity exists and is correctly identified
- Significance score: NOT LLM-assigned — computed from graph topology (degree/connection count) after graph is built
- No target entity count — LLM includes whatever is investigation-relevant (could be 10 for simple cases, 60 for complex)

### Relationship Types
- Free-form labels: LLM writes whatever best describes the relationship (e.g., 'allegedly bribed', 'co-signed lease', 'transferred $50K to')
- No fixed vocabulary or category system — expressiveness over filterability

### Relationship Temporal Context
- Required when available: LLM must include `temporal_context` whenever source material mentions dates/times
- Leave null only when truly unknown — no inference of approximate dates

### Relationship Deduplication
- Merge duplicate relationships into one edge with combined evidence from both agents
- Include corroboration count showing how many agents independently found this relationship
- `source_finding_ids` lists all sources across agents

### Suspicion Flagging
- KG Builder does NOT flag suspicious/anomalous relationships
- KG Builder is purely factual extraction — suspicion analysis is Synthesis Agent's job (Phase 8)

### Agent Input
- Receives BOTH rich markdown `findings_text` from case_findings AND raw `DomainEntity` structured lists from agent_executions.output_data
- Also receives case description and file metadata for context

### Context Overflow Handling
- If findings exceed Gemini's context window: chunk and merge strategy
- Split findings into chunks, run KG Builder on each chunk, then run a merge pass to deduplicate across chunks

### Output Validation
- Lenient: parse what's valid, log/skip malformed items
- Partial results are better than none — resilient to LLM output quirks

### Graph Summary
- No graph summary output — entities and relationships are enough
- Graph summary is Synthesis Agent's job (Phase 8)

### Pipeline Rebuild Strategy
- Clear and rebuild: delete all kg_entities and kg_relationships for the case, then write fresh curated data
- Clean slate every run — no incremental merging with previous runs

### Pipeline Trigger Timing
- Wait for ALL domain agents to complete + findings saved before invoking KG Builder
- Single LLM call with holistic view of all findings — no incremental builds

### Failure Handling
- Fail gracefully, continue pipeline: log error, emit SSE failure event, let Synthesis Agent proceed without KG data
- KG page shows empty state if KG Builder fails
- Do NOT block the pipeline or fall back to programmatic builder

### SSE Events
- Three-tier: KG_BUILDER_STARTED, periodic progress updates (e.g., 'extracting entities...', 'building relationships...'), KG_BUILDER_COMPLETE
- Frontend fetches full graph via existing API after completion
- Progress events give user visibility without per-item noise

### Claude's Discretion
- Exact prompt engineering and instruction ordering
- Gemini model configuration (thinking_level, temperature)
- Chunk size and merge strategy details for context overflow
- Pro-to-Flash fallback behavior
- SSE progress message frequency and wording
- Exact Pydantic schema field names and types (within the spirit of decisions above)

</decisions>

<specifics>
## Specific Ideas

- Entity significance determined by graph topology (degree centrality), not LLM scoring — connection count drives visual sizing in Phase 7.2
- Entity descriptions serve dual purpose: one-liner for quick reference (tooltips) + detailed paragraph for deep inspection (entity detail panel)
- Corroboration count on merged relationships is a visual weight indicator — relationships found by multiple agents are stronger evidence
- KG Builder is a "factual extractor" not an "analyst" — all suspicion/pattern analysis belongs to Synthesis (Phase 8)

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 07.1-llm-kg-builder-agent*
*Context gathered: 2026-02-08*
