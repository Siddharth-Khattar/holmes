---
phase: 07.2-kg-frontend-d3-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/types/knowledge-graph.ts
  - frontend/src/lib/knowledge-graph-config.ts
  - frontend/src/lib/api/graph.ts
  - frontend/src/hooks/use-case-graph.ts
autonomous: true

must_haves:
  truths:
    - "Frontend types exactly mirror the backend GraphResponse, EntityResponse, and RelationshipResponse schemas"
    - "Entity type color map covers all 9 types (person, organization, location, event, asset, financial_entity, communication, document, other) with a fallback"
    - "API hook fetches real graph data from GET /api/cases/:caseId/graph with auth token"
    - "Force simulation parameters are centralized in a config module, not scattered"
  artifacts:
    - path: "frontend/src/types/knowledge-graph.ts"
      provides: "TypeScript interfaces matching backend schemas for graph visualization"
      contains: "EntityResponse"
    - path: "frontend/src/lib/knowledge-graph-config.ts"
      provides: "Entity color palette, force parameters, SVG constants"
      exports: ["ENTITY_TYPE_COLORS", "getEntityColor", "FORCE_CONFIG"]
    - path: "frontend/src/lib/api/graph.ts"
      provides: "API client for KG graph endpoint"
      exports: ["fetchGraph"]
    - path: "frontend/src/hooks/use-case-graph.ts"
      provides: "React hook returning real graph data from API with loading/error states"
      exports: ["useCaseGraph"]
  key_links:
    - from: "frontend/src/hooks/use-case-graph.ts"
      to: "frontend/src/lib/api/graph.ts"
      via: "fetchGraph function call"
      pattern: "fetchGraph"
    - from: "frontend/src/lib/api/graph.ts"
      to: "/api/cases/:caseId/graph"
      via: "fetch with auth token"
      pattern: "api/cases.*graph"
    - from: "frontend/src/types/knowledge-graph.ts"
      to: "backend/app/schemas/knowledge_graph.py"
      via: "1:1 field mapping"
      pattern: "EntityResponse"
---

<objective>
Establish the type system, configuration, and data layer foundation for the KG frontend enhancement.

Purpose: All subsequent plans (GraphSvg, FilterPanel, EntityTimeline, SourceViewer, Page integration) depend on correct types, a centralized color/physics config, and a working API hook that fetches real curated KG data. Without this foundation, nothing else can be built correctly.

Output: Rewritten `knowledge-graph.ts` types matching backend schema, new `knowledge-graph-config.ts` with entity colors and force simulation parameters, new `api/graph.ts` API client, and refactored `use-case-graph.ts` hook connected to the real API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-CONTEXT.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-RESEARCH.md
@frontend/src/types/knowledge-graph.ts
@frontend/src/hooks/use-case-graph.ts
@frontend/src/lib/api/files.ts
@frontend/src/lib/command-center-config.ts
@backend/app/schemas/knowledge_graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install d3-scale and rewrite knowledge-graph types</name>
  <files>
    frontend/src/types/knowledge-graph.ts
  </files>
  <action>
    1. Install `d3-scale` dependency:
       ```
       cd frontend && bun add d3-scale && bun add -d @types/d3-scale
       ```

    2. Rewrite `frontend/src/types/knowledge-graph.ts` to match the backend `GraphResponse`, `EntityResponse`, and `RelationshipResponse` schemas exactly (from `backend/app/schemas/knowledge_graph.py`). Use snake_case field names to match API JSON response directly (no camelCase transformation needed — Next.js fetch returns raw JSON).

    Key types to define:
    - `EntityResponse` — All fields from backend schema: id, case_id, name, name_normalized, entity_type (string, NOT a union type — backend returns free-form strings), domain, confidence (0-100), properties, context, aliases, description_brief, description_detailed, domains, source_finding_ids, source_execution_id, source_finding_index, merged_into_id, merge_count, degree, created_at
    - `RelationshipResponse` — All fields: id, case_id, source_entity_id, target_entity_id, relationship_type, label, strength (number 0-100 integer, NOT 0-1 float), source_execution_id, properties, evidence_excerpt, source_finding_ids, temporal_context, corroboration_count, confidence, created_at
    - `GraphResponse` — { entities, relationships, entity_count, relationship_count }
    - `ForceNode` — extends `SimulationNodeDatum` from d3-force. Fields: id, entity (EntityResponse), radius (number, computed from degree), color (string, computed from entity_type). Plus standard d3 fields: x?, y?, vx?, vy?, fx? (number | null), fy? (number | null).
    - `ForceLink` — extends `SimulationLinkDatum<ForceNode>`. Fields: id (string, the canonical dedup key), source, target (ForceNode | string), relationships (RelationshipResponse[] — all relationships between this entity pair), count (number of relationships). This is the DEDUPLICATED edge.
    - `GraphFilters` — { activeDomains: Set<string>, activeEntityTypes: Set<string>, searchQuery: string, keywordFilter: string }

    REMOVE old types: Entity, Evidence, EvidenceType, GraphNode (old), GraphConnection, RedStringBoardOptions, GraphEvent. These are all mock-data-shaped and do not match the real API.

    KEEP: Position and Transform interfaces (still useful for zoom state).

    IMPORTANT: Do NOT use `any` type anywhere. Use `Record<string, unknown>` for metadata/properties fields.
  </action>
  <verify>
    Run `cd frontend && bun run typecheck` — should pass with no errors (existing consumers of old types will break; that's expected and will be fixed in later plans that rewrite those consumers).

    Actually, the existing `knowledge-graph.tsx`, `evidence-source-panel.tsx`, `mock-graph-data.ts`, `use-case-graph.ts`, and `knowledge-graph/page.tsx` all import old types and WILL have type errors. That is acceptable for this plan — those files are rewritten in Plans 03-05. To verify THIS plan's types are correct, check that the new types file has no internal errors:
    ```
    cd frontend && npx tsc --noEmit frontend/src/types/knowledge-graph.ts 2>&1 | head -20
    ```
    If npx tsc on that single file is not practical, just visually verify the types match the backend schema fields.
  </verify>
  <done>
    `knowledge-graph.ts` contains EntityResponse, RelationshipResponse, GraphResponse, ForceNode, ForceLink, GraphFilters types matching backend schema. d3-scale is installed. No `any` types. All backend fields present with correct types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create knowledge-graph-config and API client, refactor use-case-graph hook</name>
  <files>
    frontend/src/lib/knowledge-graph-config.ts
    frontend/src/lib/api/graph.ts
    frontend/src/hooks/use-case-graph.ts
  </files>
  <action>
    **A) Create `frontend/src/lib/knowledge-graph-config.ts`:**

    Start with ABOUTME comment. This is the centralized config for the KG visualization. Contents:

    1. **Entity type color palette** — A `Record<string, string>` (NOT a union type key — entity_type is free-form from backend). Use muted warm colors inspired by Command Center tints (see RESEARCH.md section "9 Entity Type Color Palette"):
       ```
       person:           '#5B8DEF'  // Soft blue
       organization:     '#8B7BEF'  // Muted purple
       location:         '#4DAF7C'  // Sage green
       event:            '#E87461'  // Warm coral
       asset:            '#D4A843'  // Amber gold
       financial_entity: '#45B5AA'  // Teal
       communication:    '#C27ADB'  // Lavender
       document:         '#E09D5C'  // Warm orange
       other:            '#8A8A82'  // Stone
       ```

    2. **`getEntityColor(entityType: string): string`** — Returns color from map, falls back to `other` color for unknown types. Normalizes to lowercase.

    3. **Force simulation config (`FORCE_CONFIG`):**
       ```typescript
       export const FORCE_CONFIG = {
         charge: { strength: -400 },
         link: { distance: 100, strength: 0.3 },
         center: { strength: 0.05 },
         collision: { padding: 8 },
         radial: { minRadius: 50, strengthBase: 0.05, strengthScale: 0.1 },
       } as const;
       ```

    4. **Node sizing config:**
       ```typescript
       export const NODE_SIZE = {
         minRadius: 10,
         maxRadius: 60,
       } as const;
       ```

    5. **Edge styling:**
       ```typescript
       export const EDGE_STYLE = {
         defaultColor: '#4b5563',
         selectedColor: '#ffffff',
         minWidth: 1,
         maxWidth: 6,
         defaultOpacity: 0.6,
         dimmedOpacity: 0.15,
         selectedOpacity: 1,
       } as const;
       ```

    6. **SVG constants:**
       ```typescript
       export const SVG_CONFIG = {
         zoomExtent: [0.05, 8] as [number, number],
         labelFontSize: 11,
         labelOffset: 8,  // px below node circle
       } as const;
       ```

    **B) Create `frontend/src/lib/api/graph.ts`:**

    Start with ABOUTME comment. API client for KG graph endpoint. Follow the same pattern as `api/files.ts`:
    - Import `getToken` from `@/lib/auth-client`
    - Define `API_URL` from `NEXT_PUBLIC_API_URL` env var (same pattern as files.ts)
    - Export `fetchGraph(caseId: string): Promise<GraphResponse>` that:
      1. Calls `GET ${API_URL}/api/cases/${caseId}/graph` with auth Bearer token
      2. Throws on non-OK response with descriptive error message
      3. Returns parsed JSON as `GraphResponse`

    **C) Refactor `frontend/src/hooks/use-case-graph.ts`:**

    Rewrite to use the real API client. Keep the same hook signature pattern (returns data, loading, error, refetch) but change the data type:

    ```typescript
    interface UseCaseGraphReturn {
      data: GraphResponse | null;
      loading: boolean;
      error: Error | null;
      refetch: () => void;
    }
    ```

    Implementation:
    1. Import `fetchGraph` from `@/lib/api/graph`
    2. Import `GraphResponse` from `@/types/knowledge-graph`
    3. On mount and when `caseId` changes, call `fetchGraph(caseId)`
    4. Store result in state, handle loading/error
    5. If the API call fails (e.g., no backend running), fall back gracefully — set error state, don't crash
    6. Remove all mock data imports and the `generateMockGraphData` call

    Do NOT delete `mock-graph-data.ts` yet — it will be updated or removed in Plan 05 when the page is integrated. For now just disconnect the hook from it.

    IMPORTANT: The `use-case-graph.ts` hook should NOT transform the API response. Return the raw `GraphResponse` as-is. Transformation to ForceNode/ForceLink happens in the simulation hook (Plan 03).
  </action>
  <verify>
    1. `cd frontend && bun run typecheck` — The config file and API client should have zero type errors themselves. The hook will import from the new types file and should type-check correctly. Other consumers of the old hook signature (the page.tsx) will break — that's expected and fixed in Plan 05.

    2. Verify the config file exports are correct:
       ```
       grep -c "export" frontend/src/lib/knowledge-graph-config.ts
       ```
       Should show multiple exports (ENTITY_TYPE_COLORS, getEntityColor, FORCE_CONFIG, NODE_SIZE, EDGE_STYLE, SVG_CONFIG).

    3. Verify the API client follows the same auth pattern as files.ts:
       ```
       grep "getToken" frontend/src/lib/api/graph.ts
       ```
       Should find the token retrieval.
  </verify>
  <done>
    `knowledge-graph-config.ts` exists with entity color palette (9 types + fallback), force simulation parameters, node sizing, edge styling, and SVG constants. `api/graph.ts` exists with `fetchGraph` function calling real KG API with auth. `use-case-graph.ts` returns `GraphResponse` from real API, no mock data dependency.
  </done>
</task>

</tasks>

<verification>
- `knowledge-graph.ts` types match backend `EntityResponse`, `RelationshipResponse`, `GraphResponse` field-for-field
- No `any` types in any created/modified file
- `d3-scale` package installed in frontend
- `knowledge-graph-config.ts` has all 9 entity type colors plus fallback function
- `api/graph.ts` follows same auth pattern as `api/files.ts`
- `use-case-graph.ts` calls real API, not mock data
- Run `make generate-types` then `make format` before commit (per CLAUDE.md)
</verification>

<success_criteria>
The foundation layer is complete: types match the real API, config is centralized, API client works with auth, and the data hook fetches real curated KG data. All subsequent plans can import from these files and build on them.
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-01-SUMMARY.md`
</output>
