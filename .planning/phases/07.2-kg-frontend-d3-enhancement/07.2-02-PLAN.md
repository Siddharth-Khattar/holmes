---
phase: 07.2-kg-frontend-d3-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/source-viewer/SourceViewerModal.tsx
  - frontend/src/components/source-viewer/PdfViewer.tsx
  - frontend/src/components/source-viewer/AudioViewer.tsx
  - frontend/src/components/source-viewer/VideoViewer.tsx
  - frontend/src/components/source-viewer/ImageViewer.tsx
  - frontend/src/components/app/evidence-source-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Source viewer modal renders the correct viewer sub-component based on content type (PDF, audio, video, image)"
    - "Each media viewer is a standalone modular component that can be improved independently"
    - "Modal overlays the graph area but leaves the right sidebar interactive and visible"
    - "Closing the modal returns to the graph without affecting sidebar state"
  artifacts:
    - path: "frontend/src/components/source-viewer/SourceViewerModal.tsx"
      provides: "Modal shell that dynamically renders correct media sub-component"
      min_lines: 60
    - path: "frontend/src/components/source-viewer/PdfViewer.tsx"
      provides: "PDF rendering with page navigation and text search/highlight"
      min_lines: 40
    - path: "frontend/src/components/source-viewer/AudioViewer.tsx"
      provides: "Audio waveform player with play/pause/seek and transcript cards"
      min_lines: 40
    - path: "frontend/src/components/source-viewer/VideoViewer.tsx"
      provides: "HTML5 video player with timestamp marker support"
      min_lines: 30
    - path: "frontend/src/components/source-viewer/ImageViewer.tsx"
      provides: "Zoomable image viewer with metadata display"
      min_lines: 30
  key_links:
    - from: "frontend/src/components/source-viewer/SourceViewerModal.tsx"
      to: "frontend/src/components/source-viewer/PdfViewer.tsx"
      via: "dynamic render based on contentType"
      pattern: "contentType.*pdf|PdfViewer"
    - from: "frontend/src/components/source-viewer/SourceViewerModal.tsx"
      to: "frontend/src/components/source-viewer/AudioViewer.tsx"
      via: "dynamic render based on contentType"
      pattern: "contentType.*audio|AudioViewer"
---

<objective>
Build the shared, modular source viewer system: a modal shell with pluggable media sub-components (PDF, audio, video, image).

Purpose: The source viewer is used by the KG entity timeline (click citation to view source document/media), and will later be reused by Evidence Library and Timeline views. The old `evidence-source-panel.tsx` uses mock data and is tightly coupled to the old Evidence type. This plan creates the production-quality replacement with real media rendering capabilities.

Output: `source-viewer/` component directory with SourceViewerModal.tsx (shell), PdfViewer.tsx, AudioViewer.tsx, VideoViewer.tsx, ImageViewer.tsx. The old evidence-source-panel.tsx is refactored to use the new shared components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-CONTEXT.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-RESEARCH.md
@frontend/src/components/app/evidence-source-panel.tsx
@frontend/src/lib/api/files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install media dependencies and create source viewer modal shell</name>
  <files>
    frontend/src/components/source-viewer/SourceViewerModal.tsx
    frontend/src/components/source-viewer/PdfViewer.tsx
    frontend/src/components/source-viewer/AudioViewer.tsx
    frontend/src/components/source-viewer/VideoViewer.tsx
    frontend/src/components/source-viewer/ImageViewer.tsx
  </files>
  <action>
    **Step 1: Install dependencies**

    Use Context7 or library documentation to verify current API/versions for these libraries before installing:
    - `@react-pdf-viewer/core` — PDF rendering
    - `@react-pdf-viewer/default-layout` — Default toolbar/nav
    - `@react-pdf-viewer/highlight` — Text highlighting
    - `@react-pdf-viewer/page-navigation` — Jump-to-page
    - `@react-pdf-viewer/search` — Text search
    - `pdfjs-dist` — PDF.js worker (peer dependency)
    - `wavesurfer.js` — Audio waveform
    - `@wavesurfer/react` — React hooks for wavesurfer

    IMPORTANT: Use Context7 MCP tool to check the latest compatible versions and API signatures before writing code. The RESEARCH.md recommendations may be slightly stale. Verify:
    - `@react-pdf-viewer` plugin API (jumpToPage, highlight, search)
    - `@wavesurfer/react` hook API (useWavesurfer)
    - Worker URL for pdfjs-dist

    ```
    cd frontend && bun add @react-pdf-viewer/core @react-pdf-viewer/default-layout @react-pdf-viewer/highlight @react-pdf-viewer/page-navigation @react-pdf-viewer/search pdfjs-dist wavesurfer.js @wavesurfer/react
    ```

    **Step 2: Define the shared content type interface**

    The source viewer needs a content descriptor to know what to render. Define this type either in the SourceViewerModal file or in a small types file alongside:

    ```typescript
    interface SourceViewerContent {
      type: 'pdf' | 'audio' | 'video' | 'image';
      url: string;              // Signed URL to the file (from file download API)
      fileName: string;         // Display name
      page?: number;            // For PDF: jump to this page
      timestamp?: number;       // For audio/video: jump to this timestamp (seconds)
      highlightText?: string;   // For PDF: highlight this text excerpt
    }
    ```

    **Step 3: Create `SourceViewerModal.tsx`**

    ABOUTME comment. This is the modal shell that:
    - Receives `content: SourceViewerContent | null` and `onClose: () => void` props
    - When `content` is null, renders nothing
    - When content is set, renders a dark overlay panel that covers the main graph area
    - Dynamically selects and renders the correct sub-component based on `content.type`
    - Header: file name, content type icon, close (X) button
    - The modal should be absolutely positioned to cover the graph area but NOT the right sidebar (the sidebar stays interactive — this positioning is handled by the parent layout in Plan 05; the modal itself just takes `className` or `style` for positioning)
    - Visual style: `bg-jet` background, `border-stone/15` border, subtle shadow. NOT a full-screen overlay with backdrop blur. It's a panel, not a dialog.
    - Responsive: fills available space between left panel and right sidebar

    **Step 4: Create `PdfViewer.tsx`**

    ABOUTME comment. Uses `@react-pdf-viewer` with plugins:
    - Props: `fileUrl: string`, `initialPage?: number`, `highlightKeyword?: string`
    - Renders `<Worker>` wrapping `<Viewer>` with page-navigation and search plugins
    - When `initialPage` changes, calls `jumpToPage(initialPage - 1)` (0-indexed)
    - When `highlightKeyword` changes, calls search plugin to highlight that text
    - Dark theme styling to match Holmes design system
    - Worker URL: use the CDN URL for the matching pdfjs-dist version (verify with Context7)
    - Import the core CSS: `@react-pdf-viewer/core/lib/styles/index.css` and `@react-pdf-viewer/default-layout/lib/styles/index.css`

    PITFALL (from RESEARCH.md): The worker path must be explicitly set. If misconfigured, PDFs silently fail to render.

    **Step 5: Create `AudioViewer.tsx`**

    ABOUTME comment. Uses wavesurfer.js:
    - Props: `audioUrl: string`, `initialTimestamp?: number`, `transcriptEntries?: TranscriptEntry[]`
    - TranscriptEntry: `{ time: number; speaker: string; text: string }`
    - Renders waveform at top (using `useWavesurfer` hook from `@wavesurfer/react`)
    - Play/pause button, time display, seek bar
    - Below waveform: scrollable transcript cards (timestamped, speaker-labeled)
    - Playing audio highlights the active transcript card (based on currentTime)
    - Clicking a transcript card seeks to that timestamp
    - When `initialTimestamp` prop changes, seek to that position
    - Waveform colors: `waveColor: '#8A8A82'` (stone), `progressColor: '#F5F4EF'` (smoke), `height: 64`, `barWidth: 2`
    - PITFALL (from RESEARCH.md): Memoize the plugins array to prevent wavesurfer re-initialization errors

    If transcript data is not available (empty array), just show the waveform player without transcript cards. Graceful degradation.

    **Step 6: Create `VideoViewer.tsx`**

    ABOUTME comment. HTML5 video player:
    - Props: `videoUrl: string`, `initialTimestamp?: number`, `markers?: VideoMarker[]`
    - VideoMarker: `{ time: number; label: string }`
    - Native `<video>` element with controls
    - Custom seekbar overlay showing markers as dots/ticks at their positions
    - Clicking a marker jumps to that timestamp
    - When `initialTimestamp` prop changes, set `video.currentTime`
    - Dark background, rounded corners, metadata display (filename)

    **Step 7: Create `ImageViewer.tsx`**

    ABOUTME comment. Zoomable image viewer:
    - Props: `imageUrl: string`, `fileName: string`, `metadata?: Record<string, string>`
    - CSS `object-fit: contain` within container
    - Zoom in/out buttons (CSS transform scale)
    - Pan via mouse drag when zoomed in
    - Metadata display below image (filename, dimensions from naturalWidth/naturalHeight, any passed metadata)
    - No annotation overlays (deferred per CONTEXT.md)

    ALL files: Follow Holmes design system colors. Use `bg-jet`, `border-stone/15`, `text-smoke`, `text-stone` patterns. Use lucide-react for icons. Start each file with ABOUTME 2-line comment.
  </action>
  <verify>
    1. All 5 component files exist in `frontend/src/components/source-viewer/`
    2. `cd frontend && bun run typecheck` — the source-viewer components should have no type errors (they're self-contained, don't depend on old KG types)
    3. No `any` types in any file
    4. Each viewer component has clear props interface and ABOUTME comment
  </verify>
  <done>
    Source viewer modal shell + 4 media viewer sub-components created. PdfViewer uses @react-pdf-viewer with jump-to-page and search/highlight. AudioViewer uses wavesurfer.js with waveform and transcript cards. VideoViewer uses HTML5 video with timestamp markers. ImageViewer provides zoom/pan. All follow Holmes design system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor evidence-source-panel to use shared source viewer</name>
  <files>
    frontend/src/components/app/evidence-source-panel.tsx
  </files>
  <action>
    Refactor the existing `evidence-source-panel.tsx` (462 lines, all mock data) to become a thin wrapper that uses the new shared source viewer components.

    The current `EvidenceSourcePanel` is used by the detail sidebar context system. For backward compatibility (other views like Evidence Library may reference it), keep the file and export name, but gut the internals:

    1. Remove all mock data functions (`getMockEvidenceData`)
    2. Remove all inline content-type-specific rendering (the giant if/else blocks for document, video, image, audio, text)
    3. Instead, import `SourceViewerModal` and individual viewers from `@/components/source-viewer/`
    4. The component should accept a `content` prop (matching the `SourceViewerContent` interface) and render the modal
    5. If the old `Evidence` type prop is still needed by existing consumers, add a compatibility adapter that maps the old `Evidence` type to the new `SourceViewerContent` interface:
       ```typescript
       function evidenceToSourceContent(evidence: Evidence): SourceViewerContent | null {
         // Map evidence.type to source viewer content type
         // Map evidence.url to source URL
         // Return null if no URL available
       }
       ```
    6. Fix the visual issues mentioned in CONTEXT.md:
       - Remove excessive background blur/dimming
       - Fix centering
       - Reduce frosted glass to subtle level
       - Visual style: subtle glass hint of translucency, darker backdrop, no blur of content behind

    Keep the file at the same path. Do NOT rename or move it — other parts of the app may import it.

    NOTE: The old `Evidence` type from `@/types/knowledge-graph.ts` will be removed in Plan 01. If Plan 01 runs before this task, the imports will break. Handle this gracefully: define a minimal local compatibility type if needed, or import the new types. The key is that this file compiles.
  </action>
  <verify>
    1. `cd frontend && bun run typecheck` — evidence-source-panel.tsx has no type errors
    2. The file is significantly smaller than 462 lines (most mock data removed)
    3. It imports from `@/components/source-viewer/` for actual rendering
    4. No `any` types
  </verify>
  <done>
    `evidence-source-panel.tsx` refactored to thin wrapper using shared source viewer components. Mock data removed. Visual style fixed per CONTEXT.md (subtle glass, no heavy blur). Backward-compatible export name preserved.
  </done>
</task>

</tasks>

<verification>
- All 5 source-viewer component files exist and type-check
- `evidence-source-panel.tsx` refactored to use shared components
- PDF viewer correctly configures worker URL
- Audio viewer memoizes plugins array (pitfall prevention)
- All dependencies installed (`@react-pdf-viewer/*`, `pdfjs-dist`, `wavesurfer.js`, `@wavesurfer/react`)
- No `any` types in any file
- All files have ABOUTME comments
- Run `make generate-types` then `make format` before commit
</verification>

<success_criteria>
The source viewer system is complete and modular: a modal shell dynamically renders the correct media viewer based on content type. Each viewer (PDF, audio, video, image) is a standalone component that can be improved independently in future phases. The old evidence-source-panel is refactored to use these shared components.
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-02-SUMMARY.md`
</output>
