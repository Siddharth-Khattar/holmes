---
phase: 07.2-kg-frontend-d3-enhancement
plan: 02
subsystem: ui
tags: [source-viewer, pdf, wavesurfer, video, image, react, modular-components]

# Dependency graph
requires:
  - phase: 07.2-01
    provides: "SourceViewerContent types, knowledge-graph types, api/graph.ts client"
provides:
  - "SourceViewerModal shell with content-type routing (pdf/audio/video/image)"
  - "PdfViewer with @react-pdf-viewer, jump-to-page, keyword search/highlight"
  - "AudioViewer with wavesurfer.js waveform, transcript cards, active highlighting"
  - "VideoViewer with HTML5 video, custom seekbar, timestamp markers"
  - "ImageViewer with CSS transform zoom/pan, wheel zoom, drag panning"
  - "Shared SourceViewerContent, TranscriptEntry, VideoMarker types"
  - "Refactored evidence-source-panel.tsx as thin wrapper"
affects: [07.2-03, 07.2-04, 07.2-05]

# Tech tracking
tech-stack:
  added:
    - "@react-pdf-viewer/core@3.12.0"
    - "@react-pdf-viewer/default-layout@3.12.0"
    - "@react-pdf-viewer/highlight@3.12.0"
    - "@react-pdf-viewer/page-navigation@3.12.0"
    - "@react-pdf-viewer/search@3.12.0"
    - "pdfjs-dist@3.11.174"
    - "wavesurfer.js@7.12.1"
    - "@wavesurfer/react@1.0.12"
  patterns:
    - "Dynamic import for ESM-only libraries (wavesurfer.js)"
    - "Modular media viewers as standalone components inside a modal shell"
    - "SourceViewerContent descriptor pattern for content-type routing"

key-files:
  created:
    - "frontend/src/components/source-viewer/SourceViewerModal.tsx"
    - "frontend/src/components/source-viewer/PdfViewer.tsx"
    - "frontend/src/components/source-viewer/AudioViewer.tsx"
    - "frontend/src/components/source-viewer/VideoViewer.tsx"
    - "frontend/src/components/source-viewer/ImageViewer.tsx"
  modified:
    - "frontend/src/components/app/evidence-source-panel.tsx"
    - "frontend/src/types/detail-sidebar.ts"
    - "frontend/src/components/app/detail-sidebar.tsx"
    - "frontend/package.json"

key-decisions:
  - "pdfjs-dist pinned to 3.11.174 (not 5.x) for @react-pdf-viewer 3.12 compatibility"
  - "wavesurfer.js loaded via dynamic import due to ESM-only package"
  - "Zoom pan reset moved from useEffect to zoom handler callbacks (eslint react-hooks/set-state-in-effect)"
  - "detail-sidebar.ts KnowledgeGraphEvidenceContent uses SourceViewerContent instead of removed Evidence type"

patterns-established:
  - "Source viewer modal shell with pluggable media sub-components"
  - "Dynamic import pattern for ESM-only packages in Next.js client components"
  - "Pan reset colocated with zoom state transitions (no cascading effects)"

# Metrics
duration: 20min
completed: 2026-02-08
---

# Phase 7.2 Plan 02: Source Viewer Modal and Media Components Summary

**Modular source viewer system with SourceViewerModal shell, PdfViewer (@react-pdf-viewer + search/highlight), AudioViewer (wavesurfer.js waveform + transcript), VideoViewer (HTML5 + timestamp markers), ImageViewer (zoom/pan), and refactored evidence-source-panel wrapper**

## Performance

- **Duration:** 20 min
- **Started:** 2026-02-08T15:30:36Z
- **Completed:** 2026-02-08T15:50:21Z
- **Tasks:** 3
- **Files modified:** 9

## Accomplishments
- Created complete source-viewer component directory with 5 modular components
- Installed 8 media dependencies (@react-pdf-viewer suite, pdfjs-dist, wavesurfer.js, @wavesurfer/react)
- PdfViewer supports jump-to-page (1-indexed) and keyword search/highlight via plugins
- AudioViewer uses wavesurfer.js with waveform visualization, play/pause/seek, and synchronized transcript cards
- VideoViewer provides HTML5 video with custom seekbar overlay and clickable timestamp markers
- ImageViewer supports CSS transform zoom/pan, wheel zoom, drag panning, and metadata display
- Refactored evidence-source-panel.tsx from 462 lines of mock data to 58-line thin wrapper

## Task Commits

Each task was committed atomically:

1. **Task 1: Install media dependencies, create SourceViewerModal shell and PdfViewer** - `bb1a6fa` (feat)
2. **Task 2: Create AudioViewer, VideoViewer, and ImageViewer components** - `4b037d5` (feat)
3. **Task 3: Refactor evidence-source-panel to use shared source viewer** - `0d024c9` (refactor)

## Files Created/Modified
- `frontend/src/components/source-viewer/SourceViewerModal.tsx` - Modal shell with content-type routing and shared type exports
- `frontend/src/components/source-viewer/PdfViewer.tsx` - @react-pdf-viewer with page-navigation and search plugins
- `frontend/src/components/source-viewer/AudioViewer.tsx` - wavesurfer.js waveform player with transcript card display
- `frontend/src/components/source-viewer/VideoViewer.tsx` - HTML5 video with custom seekbar and timestamp markers
- `frontend/src/components/source-viewer/ImageViewer.tsx` - Zoomable image with pan/zoom controls and metadata
- `frontend/src/components/app/evidence-source-panel.tsx` - Refactored to thin wrapper delegating to SourceViewerModal
- `frontend/src/types/detail-sidebar.ts` - Updated KnowledgeGraphEvidenceContent to use SourceViewerContent
- `frontend/src/components/app/detail-sidebar.tsx` - Updated to pass content prop instead of evidence
- `frontend/package.json` - Added 8 media dependencies

## Decisions Made
- **pdfjs-dist 3.x (not 5.x):** @react-pdf-viewer 3.12 has peer dependency on pdfjs-dist 2.x or 3.x. The latest pdfjs-dist 5.x is incompatible. Pinned to 3.11.174.
- **Dynamic import for wavesurfer.js:** Package is ESM-only and cannot be statically imported in Next.js client components without build issues. Using dynamic `import()` inside useEffect.
- **Pan reset in zoom handlers:** Removed useEffect-based pan reset (eslint react-hooks/set-state-in-effect violation). Pan is now reset directly inside zoom state setter callbacks when zoom drops to 1x.
- **detail-sidebar type update:** The removed `Evidence` type was replaced with `SourceViewerContent` in the sidebar discriminated union to maintain compilation.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] pdfjs-dist version incompatibility**
- **Found during:** Task 1 (Install dependencies)
- **Issue:** bun installed pdfjs-dist@5.4.624 but @react-pdf-viewer 3.12 requires pdfjs-dist ^2.16 or ^3.0
- **Fix:** Removed pdfjs-dist 5.x and installed pdfjs-dist@^3.11 (resolved to 3.11.174)
- **Files modified:** frontend/package.json, bun.lock
- **Verification:** No peer dependency warnings, PDF worker URL matches installed version
- **Committed in:** bb1a6fa (Task 1 commit)

**2. [Rule 1 - Bug] eslint react-hooks/set-state-in-effect violation in ImageViewer**
- **Found during:** Task 2 (pre-commit hook)
- **Issue:** Calling setPan() inside useEffect with [zoom] dependency triggers cascading renders
- **Fix:** Moved pan reset logic from useEffect into zoom handler callbacks (handleZoomOut, handleWheel)
- **Files modified:** frontend/src/components/source-viewer/ImageViewer.tsx
- **Verification:** eslint passes, zoom-to-1x correctly resets pan position
- **Committed in:** 4b037d5 (Task 2 commit)

**3. [Rule 3 - Blocking] detail-sidebar.ts imports removed Evidence type**
- **Found during:** Task 3 (evidence-source-panel refactor)
- **Issue:** detail-sidebar.ts imported Evidence from knowledge-graph.ts, but Evidence was removed in Plan 01
- **Fix:** Replaced Evidence with SourceViewerContent in KnowledgeGraphEvidenceContent, updated detail-sidebar.tsx accordingly
- **Files modified:** frontend/src/types/detail-sidebar.ts, frontend/src/components/app/detail-sidebar.tsx
- **Verification:** Both files compile with no type errors
- **Committed in:** 0d024c9 (Task 3 commit)

---

**Total deviations:** 3 auto-fixed (1 blocking dep version, 1 bug/lint, 1 blocking import)
**Impact on plan:** All auto-fixes necessary for correctness. No scope creep.

## Issues Encountered
- Pre-existing type errors in knowledge-graph.tsx, page.tsx, mock-graph-data.ts, etc. remain from Plan 01 type rewrite. These are expected and will be fixed in Plans 03-05. Source-viewer files have zero type errors.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Source viewer system ready for integration with EntityTimeline (Plan 04) and KG page layout (Plan 05)
- SourceViewerContent type can be imported from SourceViewerModal.tsx or re-exported from evidence-source-panel.tsx
- Each media viewer can be independently improved without touching the modal shell or other viewers
- Plan 03 (FilterPanel) does not depend on source viewer components

---
*Phase: 07.2-kg-frontend-d3-enhancement*
*Completed: 2026-02-08*
