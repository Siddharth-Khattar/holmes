---
phase: 07.2-kg-frontend-d3-enhancement
plan: 04
type: execute
wave: 2
depends_on: ["07.2-01"]
files_modified:
  - frontend/src/components/knowledge-graph/FilterPanel.tsx
  - frontend/src/components/knowledge-graph/EntityTimeline.tsx
  - frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx
  - frontend/src/hooks/useGraphFilters.ts
autonomous: true

must_haves:
  truths:
    - "Filter panel shows domain toggles (Financial, Legal, Evidence, Strategy) that filter entities by source domain"
    - "Filter panel shows entity type toggles (all 9 types) with counts that filter by entity type"
    - "Entity search highlights matching nodes without removing non-matching ones from the graph"
    - "Entity timeline sidebar shows a chronological list of relationships involving the selected entity"
    - "Each timeline entry is expandable to reveal source document card with 'view source' link"
    - "Timeline sidebar has entity name header, date range, relationship count, close button, and entity search"
    - "'View source' button shows 'Source not yet available' gracefully when file URL cannot be resolved"
  artifacts:
    - path: "frontend/src/components/knowledge-graph/FilterPanel.tsx"
      provides: "Left collapsible filter panel with domain/type toggles, search, stats"
      min_lines: 100
    - path: "frontend/src/components/knowledge-graph/EntityTimeline.tsx"
      provides: "Right sidebar showing chronological relationship timeline for selected entity"
      min_lines: 80
    - path: "frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx"
      provides: "Single timeline entry with expandable source document card"
      min_lines: 40
    - path: "frontend/src/hooks/useGraphFilters.ts"
      provides: "Filter state management with domain/type toggles and search"
      exports: ["useGraphFilters"]
  key_links:
    - from: "frontend/src/hooks/useGraphFilters.ts"
      to: "frontend/src/types/knowledge-graph.ts"
      via: "GraphFilters type and EntityResponse/RelationshipResponse"
      pattern: "GraphFilters"
    - from: "frontend/src/components/knowledge-graph/EntityTimeline.tsx"
      to: "frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx"
      via: "renders list of EntityTimelineEntry"
      pattern: "EntityTimelineEntry"
    - from: "frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx"
      to: "SourceViewerContent"
      via: "onViewSource callback with content descriptor"
      pattern: "onViewSource"
---

<objective>
Build the filter panel (left) and entity timeline sidebar (right) — the two panel UI components that frame the graph canvas.

Purpose: The filter panel enables investigative exploration (narrow by domain, entity type, keyword search). The entity timeline sidebar shows a chronological view of all relationships involving a selected entity, with expandable source document cards. These are the primary interaction surfaces beyond the graph itself.

Output: FilterPanel.tsx, EntityTimeline.tsx, EntityTimelineEntry.tsx components, and useGraphFilters.ts hook.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-CONTEXT.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-RESEARCH.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-01-SUMMARY.md
@frontend/src/types/knowledge-graph.ts
@frontend/src/lib/knowledge-graph-config.ts
@frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useGraphFilters hook and FilterPanel component</name>
  <files>
    frontend/src/hooks/useGraphFilters.ts
    frontend/src/components/knowledge-graph/FilterPanel.tsx
  </files>
  <action>
    **A) Create `frontend/src/hooks/useGraphFilters.ts`**

    ABOUTME comment. Manages filter state for the knowledge graph visualization.

    **Interface:**
    ```typescript
    interface UseGraphFiltersProps {
      entities: EntityResponse[];
      relationships: RelationshipResponse[];
    }

    interface UseGraphFiltersReturn {
      filters: GraphFilters;
      setActiveDomains: (domains: Set<string>) => void;
      toggleDomain: (domain: string) => void;
      setActiveEntityTypes: (types: Set<string>) => void;
      toggleEntityType: (type: string) => void;
      setSearchQuery: (query: string) => void;
      setKeywordFilter: (keywords: string) => void;
      filteredEntities: EntityResponse[];
      filteredRelationships: RelationshipResponse[];
      searchMatchIds: Set<string>;       // Entity IDs matching search query
      entityTypeCounts: Map<string, number>; // Count per entity type
      domainCounts: Map<string, number>;     // Count per domain
    }
    ```

    **Implementation:**
    1. Initialize filters with all domains and entity types active (derived from entities array)
    2. `filteredEntities` (useMemo):
       - Start with all entities
       - If domain filters active: keep entities whose `domain` or any item in `domains[]` matches an active domain. An entity found by multiple domains stays visible as long as at least one active domain matches.
       - If entity type filters active: keep entities whose `entity_type` is in the active set
       - Keyword filter: if non-empty, split by comma, trim, fuzzy-match each keyword against entity names and relationship labels. Keep entities that match or are connected to matching relationships.
       - Search query does NOT filter — it only populates `searchMatchIds` for highlighting
    3. `filteredRelationships` (useMemo): keep relationships where BOTH source and target entities are in `filteredEntities`
    4. `searchMatchIds` (useMemo): if searchQuery is non-empty, find entities whose `name`, `aliases`, or `description_brief` contains the query (case-insensitive). Return their IDs.
    5. `entityTypeCounts` / `domainCounts`: computed from the FULL entity list (not filtered), showing how many entities exist per type/domain. These counts are displayed in the filter panel toggles.

    **B) Create `frontend/src/components/knowledge-graph/FilterPanel.tsx`**

    ABOUTME comment. Left collapsible filter panel for the knowledge graph.

    **Props:**
    ```typescript
    interface FilterPanelProps {
      isOpen: boolean;
      onToggle: () => void;
      filters: GraphFilters;
      onToggleDomain: (domain: string) => void;
      onToggleEntityType: (type: string) => void;
      onSearchChange: (query: string) => void;
      onKeywordChange: (keywords: string) => void;
      entityTypeCounts: Map<string, number>;
      domainCounts: Map<string, number>;
      totalEntities: number;
      totalRelationships: number;
    }
    ```

    **Layout (per CONTEXT.md):**
    - Collapsible — closed by default. When closed, show a thin vertical strip with a toggle button (filter icon). When open, expand to ~320px width.
    - Transition: 200-300ms ease-out for panel open/close
    - Background: `bg-jet` with `border-stone/15` right border
    - Panel is LOCAL to the KG canvas area, not the app-wide sidebar

    **Sections (top to bottom):**

    1. **Graph Stats:** Entity count, relationship count. Simple stat display at top.

    2. **Entity Search:** Debounced text input (use existing `useDebounce` hook if available, or a simple 300ms debounce). Placeholder: "Search entities...". This is for HIGHLIGHTING, not filtering.

    3. **Keyword Filter:** Text input. Placeholder: "Filter by keywords (comma-separated)". This IS a filter — it hides non-matching content.

    4. **Domain Layer Toggles:** Horizontal or vertical toggle buttons for Financial, Legal, Evidence, Strategy. Each shows count from `domainCounts`. Toggle on/off. "Select All" / "Deselect All" quick actions.

    5. **Entity Type Toggles:** List of all 9 entity types present in the graph. Each row: colored dot (from `getEntityColor`), type name (title-cased), count in parentheses. Toggle on/off. "Select All" / "Deselect All".

    **Styling:**
    - Follow the Holmes design system: `text-smoke` for primary text, `text-stone` for muted, `bg-charcoal/50` for toggle backgrounds
    - Active toggles: filled background with entity color at low opacity
    - Inactive toggles: transparent background, muted text
    - Use lucide-react icons: `Filter` for the collapsed strip, `Search` for search input, `X` for clear
  </action>
  <verify>
    1. `cd frontend && bun run typecheck` — hook and component type-check with no errors
    2. Filter panel renders all 9 entity type toggles with correct colors
    3. Domain toggles handle multi-domain entities correctly (entity visible if ANY active domain matches)
    4. Search populates match IDs without filtering the graph
    5. No `any` types
    6. Both files have ABOUTME comments
  </verify>
  <done>
    `useGraphFilters` hook manages filter state with domain/type toggles, search highlighting, and keyword filtering. `FilterPanel.tsx` renders collapsible left panel with graph stats, entity search, keyword filter, domain layer toggles, and entity type toggles — all styled in Holmes design system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EntityTimeline sidebar and EntityTimelineEntry component</name>
  <files>
    frontend/src/components/knowledge-graph/EntityTimeline.tsx
    frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx
  </files>
  <action>
    **A) Create `frontend/src/components/knowledge-graph/EntityTimeline.tsx`**

    ABOUTME comment. Right sidebar panel showing chronological relationship timeline for a selected entity. Inspired by the Command Center `NodeDetailsSidebar.tsx` layout pattern and the Epstein Doc Explorer right sidebar.

    **Props:**
    ```typescript
    interface EntityTimelineProps {
      entity: EntityResponse;
      relationships: RelationshipResponse[];  // All relationships involving this entity
      allEntities: EntityResponse[];          // For resolving connected entity names
      onClose: () => void;
      onViewSource: (content: SourceViewerContent) => void; // Opens source viewer modal
    }
    ```

    Where `SourceViewerContent` is the type from Plan 02's source viewer:
    ```typescript
    interface SourceViewerContent {
      type: 'pdf' | 'audio' | 'video' | 'image';
      url: string;
      fileName: string;
      page?: number;
      timestamp?: number;
      highlightText?: string;
    }
    ```

    Import this type from the source-viewer module (or define locally if cross-plan dependency is complex).

    **Layout (per CONTEXT.md — app-wide right sidebar similar to Command Center NodeDetailsSidebar):**

    This is a right sidebar panel, similar in layout approach to the Command Center's `NodeDetailsSidebar.tsx`. It renders as a fixed-width right panel managed by the page layout (Plan 05 handles the positioning).

    - Width: ~384px (w-96) or similar to NodeDetailsSidebar
    - Background: `bg-jet` with left border `border-stone/15`
    - Scroll: `overflow-y-auto` with thin scrollbar styling

    **Header:**
    - Entity name (large, bold, colored with entity type color)
    - Entity type badge (pill/badge with entity color)
    - Date range of relationships (parse `temporal_context` fields, show earliest..latest or "No dates available" if none have temporal_context)
    - Relationship count (e.g., "12 relationships")
    - Close (X) button — calls `onClose`
    - Brief description from `entity.description_brief` if available

    **Filter:**
    - Text input: "Filter by entity name..." — filters the timeline entries by the name of the connected entity

    **Timeline entries (sorted chronologically):**
    - Sort relationships by `temporal_context` (parse dates where possible, put null-dated ones at end)
    - Each relationship rendered as `EntityTimelineEntry`
    - Group by year/period if temporal_context is parseable (optional, Claude's discretion)
    - Scrollable list

    **Empty state:** If entity has no relationships, show "No relationships found for this entity."

    **Styling:**
    - Use similar patterns to NodeDetailsSidebar: gradient header, scrollable body, muted border colors
    - Entity names in entries color-coded: selected entity in one accent color (e.g., entity's own color), related entities in a complementary color
    - Subtle animation on open (slide from right, 200ms transition)

    **B) Create `frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx`**

    ABOUTME comment. Single timeline entry component — expandable to reveal source document card.

    **Props:**
    ```typescript
    interface EntityTimelineEntryProps {
      relationship: RelationshipResponse;
      selectedEntity: EntityResponse;
      connectedEntity: EntityResponse | null; // Resolved from allEntities
      onViewSource: (content: SourceViewerContent) => void;
    }
    ```

    **Layout (per CONTEXT.md):**

    **Collapsed state (default):**
    - Left: Date/year from `temporal_context` (or "Unknown date" if null) — muted text
    - Center: Relationship description showing entity names color-coded:
      - Pattern: `{source entity name} -> {relationship label} -> {target entity name}`
      - The selected entity name uses its entity type color
      - The connected entity name uses its entity type color (different from selected)
    - Right: Chevron toggle icon (down when collapsed, up when expanded)

    **Expanded state (on click):**
    - All of collapsed content visible
    - Below: Source document card (if `source_finding_ids` exist):
      - Card background: `bg-charcoal/30`, `border-stone/10`
      - Evidence excerpt: `relationship.evidence_excerpt` (truncated to ~200 chars with "..." and expand)
      - If `corroboration_count` > 1: badge showing "Corroborated by {N} agents"
      - "View source" button behavior:
        - The `source_finding_ids` point to case_findings, which link to agent_executions, which link to files. Resolving the full chain (source_finding_ids -> file download URL) requires a backend API that is NOT available in Phase 7.2.
        - For Phase 7.2, implement graceful degradation:
          - If `evidence_excerpt` exists: show it inline in the expanded card (this is always available).
          - The "View source" button should display "Source not yet available" in a disabled/muted style with a tooltip: "Full source navigation will be available in a future update."
          - Do NOT show a broken or non-functional "View source" button that errors on click.
        - The `onViewSource` callback is still wired and accepts `SourceViewerContent` — it just won't be called until file URL resolution is implemented (deferred beyond Phase 7.2 as a backend enhancement).
    - Temporal context: if available, show as a subtle badge below the description

    **Animation:** Smooth expand/collapse transition (height auto animation via CSS or motion).
  </action>
  <verify>
    1. `cd frontend && bun run typecheck` — both components type-check with no errors
    2. EntityTimeline renders header with entity name, type badge, date range, count, close button
    3. EntityTimelineEntry is expandable and shows relationship description with color-coded entity names
    4. "View source" shows "Source not yet available" in disabled/muted style (graceful degradation)
    5. Filter input in timeline sidebar works (filters by connected entity name)
    6. No `any` types
    7. Both files have ABOUTME comments
  </verify>
  <done>
    EntityTimeline sidebar shows chronological relationships for selected entity with header (name, type, date range, count), filter input, and scrollable timeline. EntityTimelineEntry is expandable, showing color-coded relationship descriptions and source document cards with evidence excerpts. "View source" gracefully shows "Source not yet available" — full file URL resolution (source_finding_ids to file download URL) deferred as a backend enhancement beyond Phase 7.2. Styled consistently with Holmes design system and Command Center sidebar patterns.
  </done>
</task>

</tasks>

<verification>
- Filter panel has domain toggles (4 domains), entity type toggles (9 types with counts), search, keyword filter, stats
- Domain filtering handles multi-domain entities correctly
- Search highlights without filtering
- Entity timeline shows chronological relationships for selected entity
- Timeline entries are expandable with source document cards
- Timeline header shows entity name, date range, relationship count, close button
- "View source" gracefully degrades to "Source not yet available" (file URL resolution deferred beyond 7.2)
- All components follow Holmes design system (bg-jet, border-stone/15, text-smoke/text-stone)
- No `any` types
- All files have ABOUTME comments
- Run `make generate-types` then `make format` before commit
</verification>

<success_criteria>
Both panel components are complete: FilterPanel enables investigative filtering by domain, entity type, keywords, and search highlighting. EntityTimeline shows a rich chronological view of relationships with expandable source cards and graceful source viewer degradation. Both are ready to be wired into the 3-panel layout in Plan 05.
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-04-SUMMARY.md`
</output>
