---
phase: 07.2-kg-frontend-d3-enhancement
plan: 04
subsystem: ui
tags: [react, d3, knowledge-graph, filter-panel, entity-timeline, hooks]

# Dependency graph
requires:
  - phase: 07.2-01
    provides: "EntityResponse, RelationshipResponse, GraphFilters types, getEntityColor config, knowledge-graph-config"
  - phase: 07.2-03
    provides: "GraphSvg component with searchMatchIds prop for search highlighting"
provides:
  - "useGraphFilters hook: filter state management with domain/type toggles, keyword filtering, search highlighting"
  - "FilterPanel: collapsible left filter panel with domain toggles, entity type toggles, search, keyword filter, stats"
  - "EntityTimeline: right sidebar showing chronological relationship timeline for selected entity"
  - "EntityTimelineEntry: expandable timeline entry with evidence excerpt and graceful source degradation"
affects: ["07.2-05 (page integration wires these panels into the 3-panel layout)"]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Disabled-set pattern: track what user turned OFF instead of what is ON, avoiding setState-in-effect/memo lint violations"
    - "Render-derived active sets: activeDomains = allDomains - disabledDomains (pure computation, no sync effects)"
    - "Chronological sorting with graceful date parsing: Date.parse fallback to year regex extraction, Infinity for unparseable"

key-files:
  created:
    - "frontend/src/hooks/useGraphFilters.ts"
    - "frontend/src/components/knowledge-graph/FilterPanel.tsx"
    - "frontend/src/components/knowledge-graph/EntityTimeline.tsx"
    - "frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx"
  modified: []

key-decisions:
  - "Disabled-set state pattern instead of active-set state: ESLint react-hooks rules prohibit setState in useMemo and useEffect; inverted model avoids sync entirely"
  - "EntityTimelineEntry does NOT wire onViewSource callback: file URL resolution (source_finding_ids -> download URL) requires backend API not available in Phase 7.2"
  - "EntityTimeline receives pre-filtered relationships (all involving selected entity) from parent, not full relationship list"

patterns-established:
  - "Disabled-set pattern: for toggle-all-on-by-default filters, track disabled items rather than active items to avoid sync when data changes"
  - "EntityTimelineEntry prop isSource: indicates directionality for color-coding source vs target entity names"

# Metrics
duration: 20min
completed: 2026-02-08
---

# Phase 7.2 Plan 04: FilterPanel + EntityTimeline Summary

**Collapsible left filter panel with domain/type/keyword/search controls, and right entity timeline sidebar with chronological expandable relationship entries and graceful source viewer degradation**

## Performance

- **Duration:** 20 min
- **Started:** 2026-02-08T16:29:42Z
- **Completed:** 2026-02-08T16:49:53Z
- **Tasks:** 2
- **Files created:** 4

## Accomplishments
- useGraphFilters hook manages filter state with disabled-set pattern (avoids ESLint setState-in-effect violations), providing domain/type toggles, keyword filtering, search highlighting, and entity/domain counts
- FilterPanel is a collapsible left panel (320px open, 40px closed strip) with graph stats, entity search (highlight-only), keyword filter, domain layer toggles (4 domains), and entity type toggles (9 types with counts and colored dots)
- EntityTimeline right sidebar shows entity name with type color, description, date range computation, relationship count, filter-by-entity-name input, and chronologically sorted timeline entries
- EntityTimelineEntry is expandable with color-coded source/target entity names, evidence excerpt, corroboration badge, confidence, and "Source not yet available" graceful degradation

## Task Commits

Each task was committed atomically:

1. **Task 1: useGraphFilters hook and FilterPanel component** - `1b4ff4e` (feat)
2. **Task 2: EntityTimeline sidebar and EntityTimelineEntry component** - `b22af42` (feat)

## Files Created/Modified
- `frontend/src/hooks/useGraphFilters.ts` - Filter state management hook with disabled-set pattern, domain/type toggles, keyword filtering, search highlighting, and computed counts
- `frontend/src/components/knowledge-graph/FilterPanel.tsx` - Collapsible left filter panel with graph stats, search, keyword filter, domain toggles, entity type toggles
- `frontend/src/components/knowledge-graph/EntityTimeline.tsx` - Right sidebar panel with gradient header, entity info, date range, filter input, chronological relationship list
- `frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx` - Expandable timeline entry with color-coded entity names, evidence excerpt, corroboration badge, graceful source degradation

## Decisions Made
- **Disabled-set state pattern**: ESLint `react-hooks/set-state-in-render` and `react-hooks/set-state-in-effect` rules prohibit calling setState inside useMemo or useEffect. Switched from tracking active items to tracking disabled items -- `activeDomains = allDomains - disabledDomains` is a pure render computation that needs no sync effects.
- **No onViewSource wiring**: The `source_finding_ids -> file download URL` chain requires a backend API (findings -> agent_executions -> files) that is not available in Phase 7.2. EntityTimelineEntry shows "Source not yet available" with a disabled style and tooltip.
- **EntityTimeline receives pre-filtered relationships**: Parent component filters relationships to those involving the selected entity before passing to EntityTimeline, keeping the component focused on display logic.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed ESLint setState-in-useMemo and setState-in-useEffect violations**
- **Found during:** Task 1 (useGraphFilters hook)
- **Issue:** Original implementation used useMemo to sync active domains/entity types when data changed. ESLint `react-hooks/set-state-in-render` and `react-hooks/set-state-in-effect` rules both blocked this pattern.
- **Fix:** Redesigned to use "disabled-set" state model. Instead of tracking what is active, track what the user has disabled. Active sets are derived as `allItems - disabledItems` during render -- pure computation with no effects needed.
- **Files modified:** `frontend/src/hooks/useGraphFilters.ts`
- **Verification:** ESLint pre-commit hook passes; prettier passes
- **Committed in:** `1b4ff4e` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug: lint violation)
**Impact on plan:** Auto-fix improved the state management pattern. No scope creep.

## Issues Encountered
None beyond the ESLint lint violations addressed above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 4 panel components ready for Plan 05 integration into the KnowledgeGraphCanvas 3-panel layout
- FilterPanel exports: `FilterPanel` component, consumed by page with `isOpen`/`onToggle` + filter props from `useGraphFilters`
- EntityTimeline exports: `EntityTimeline` component, consumed by page when `selectedEntityId` is set
- EntityTimelineEntry is an internal component of EntityTimeline (not directly imported by page)
- useGraphFilters hook provides all filter state needed by both FilterPanel (UI) and GraphSvg (filteredEntities/filteredRelationships/searchMatchIds)

---
*Phase: 07.2-kg-frontend-d3-enhancement*
*Completed: 2026-02-08*
