---
phase: 07.2-kg-frontend-d3-enhancement
plan: 05
type: execute
wave: 3
depends_on: ["07.2-01", "07.2-02", "07.2-03", "07.2-04"]
files_modified:
  - frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx
  - frontend/src/app/(app)/cases/[id]/knowledge-graph/page.tsx
  - frontend/src/components/app/knowledge-graph.tsx
  - frontend/src/lib/mock-graph-data.ts
autonomous: false

must_haves:
  truths:
    - "KG page shows a 3-panel layout: left filter panel (collapsible) | center graph | right entity timeline (on selection)"
    - "Clicking a node in the graph opens the entity timeline sidebar showing that entity's relationships"
    - "Clicking 'View source' in the timeline opens the source viewer modal overlaying the graph area"
    - "Right sidebar stays interactive while source viewer modal is open"
    - "Filter panel toggles correctly hide/show entities and their relationships in the graph"
    - "Search input highlights matching nodes with accent glow without filtering"
    - "Graph renders real curated KG data from the API (not mock data)"
    - "Fullscreen mode works (maximize button expands KG to fill viewport)"
    - "Graph with ~50 nodes renders smoothly without jank"
    - "D3 tick handler does NOT trigger React re-renders (verifiable via React DevTools Profiler)"
  artifacts:
    - path: "frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx"
      provides: "3-panel layout orchestrator composing GraphSvg, FilterPanel, EntityTimeline, SourceViewerModal"
      min_lines: 100
    - path: "frontend/src/app/(app)/cases/[id]/knowledge-graph/page.tsx"
      provides: "Page component fetching data and rendering KnowledgeGraphCanvas"
      min_lines: 30
  key_links:
    - from: "frontend/src/app/(app)/cases/[id]/knowledge-graph/page.tsx"
      to: "frontend/src/hooks/use-case-graph.ts"
      via: "useCaseGraph hook for API data"
      pattern: "useCaseGraph"
    - from: "frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx"
      to: "frontend/src/components/knowledge-graph/GraphSvg.tsx"
      via: "renders GraphSvg with filtered data"
      pattern: "GraphSvg"
    - from: "frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx"
      to: "frontend/src/components/knowledge-graph/FilterPanel.tsx"
      via: "renders FilterPanel with filter state"
      pattern: "FilterPanel"
    - from: "frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx"
      to: "frontend/src/components/knowledge-graph/EntityTimeline.tsx"
      via: "renders EntityTimeline when entity selected"
      pattern: "EntityTimeline"
    - from: "frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx"
      to: "frontend/src/components/source-viewer/SourceViewerModal.tsx"
      via: "renders SourceViewerModal when source viewer content is set"
      pattern: "SourceViewerModal"
---

<objective>
Wire everything together: the 3-panel layout orchestrator (KnowledgeGraphCanvas), the page component, and all inter-component state flows. Delete/archive the old monolith.

Purpose: This is the integration plan that brings Plans 01-04 together into a working KG page. The KnowledgeGraphCanvas orchestrates the layout and state flow: GraphSvg emits selection events, EntityTimeline emits view-source events, FilterPanel emits filter changes, and the orchestrator manages how these all interact. The page component fetches data and manages loading/error states.

Output: Working KG page with 3-panel layout, real API data, fullscreen capability, and all inter-component wiring complete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-CONTEXT.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-RESEARCH.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-01-SUMMARY.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-02-SUMMARY.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-03-SUMMARY.md
@.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-04-SUMMARY.md
@frontend/src/app/(app)/cases/[id]/knowledge-graph/page.tsx
@frontend/src/components/app/knowledge-graph.tsx
@frontend/src/types/knowledge-graph.ts
@frontend/src/lib/knowledge-graph-config.ts
@frontend/src/hooks/use-case-graph.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KnowledgeGraphCanvas orchestrator and rewrite page</name>
  <files>
    frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx
    frontend/src/app/(app)/cases/[id]/knowledge-graph/page.tsx
    frontend/src/components/app/knowledge-graph.tsx
    frontend/src/lib/mock-graph-data.ts
  </files>
  <action>
    **A) Create `frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx`**

    ABOUTME comment: Main orchestrator for the 3-panel KG layout. Composes GraphSvg, FilterPanel, EntityTimeline, and SourceViewerModal.

    **Props:**
    ```typescript
    interface KnowledgeGraphCanvasProps {
      entities: EntityResponse[];
      relationships: RelationshipResponse[];
    }
    ```

    **State managed by this component:**
    ```typescript
    // Filter state (from useGraphFilters hook)
    const { filters, filteredEntities, filteredRelationships, searchMatchIds, ... } = useGraphFilters({ entities, relationships });

    // Panel visibility
    const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false); // Closed by default
    const [selectedEntityId, setSelectedEntityId] = useState<string | null>(null);

    // Source viewer
    const [sourceViewerContent, setSourceViewerContent] = useState<SourceViewerContent | null>(null);

    // Fullscreen
    const [isFullscreen, setIsFullscreen] = useState(false);
    const containerRef = useRef<HTMLDivElement>(null);
    ```

    **Derived state:**
    ```typescript
    // Resolve selected entity and its relationships
    const selectedEntity = selectedEntityId
      ? entities.find(e => e.id === selectedEntityId) ?? null
      : null;

    const selectedEntityRelationships = selectedEntityId
      ? relationships.filter(r =>
          r.source_entity_id === selectedEntityId ||
          r.target_entity_id === selectedEntityId
        )
      : [];
    ```

    **Layout (per CONTEXT.md — 3-panel, all LOCAL to KG content area):**
    ```tsx
    <div
      ref={containerRef}
      className={clsx(
        "relative flex w-full h-full overflow-hidden",
        isFullscreen && "fixed inset-0 z-50 bg-charcoal"
      )}
    >
      {/* Left: Filter Panel (collapsible) */}
      <FilterPanel
        isOpen={isFilterPanelOpen}
        onToggle={() => setIsFilterPanelOpen(prev => !prev)}
        filters={filters}
        onToggleDomain={toggleDomain}
        onToggleEntityType={toggleEntityType}
        onSearchChange={setSearchQuery}
        onKeywordChange={setKeywordFilter}
        entityTypeCounts={entityTypeCounts}
        domainCounts={domainCounts}
        totalEntities={entities.length}
        totalRelationships={relationships.length}
      />

      {/* Center: Graph area (flexes to fill remaining space) */}
      <div className="relative flex-1 min-w-0">
        {/* GraphSvg fills center area */}
        <GraphSvg
          entities={filteredEntities}
          relationships={filteredRelationships}
          onEntitySelect={handleEntitySelect}
          selectedEntityId={selectedEntityId}
          searchMatchIds={searchMatchIds}
        />

        {/* Source viewer modal overlays graph area only (NOT the right sidebar) */}
        {sourceViewerContent && (
          <SourceViewerModal
            content={sourceViewerContent}
            onClose={() => setSourceViewerContent(null)}
          />
        )}

        {/* Fullscreen toggle button */}
        <button
          onClick={toggleFullscreen}
          className="absolute top-4 left-4 p-2 rounded bg-jet/80 border border-stone/15 text-stone hover:text-smoke transition-colors"
          title={isFullscreen ? "Exit fullscreen" : "Fullscreen"}
        >
          {/* Maximize/Minimize icon from lucide-react */}
        </button>
      </div>

      {/* Right: Entity Timeline sidebar (appears when entity selected) */}
      {selectedEntity && (
        <EntityTimeline
          entity={selectedEntity}
          relationships={selectedEntityRelationships}
          allEntities={entities}
          onClose={handleDeselectEntity}
          onViewSource={handleViewSource}
        />
      )}
    </div>
    ```

    **Event handlers:**
    ```typescript
    const handleEntitySelect = (entityId: string | null) => {
      setSelectedEntityId(entityId);
      // Close source viewer when selecting a different entity or deselecting
      if (entityId !== selectedEntityId) {
        setSourceViewerContent(null);
      }
    };

    const handleDeselectEntity = () => {
      setSelectedEntityId(null);
      setSourceViewerContent(null);
    };

    const handleViewSource = (content: SourceViewerContent) => {
      setSourceViewerContent(content);
      // Right sidebar stays open — no state change to selectedEntityId
    };

    const toggleFullscreen = () => {
      if (isFullscreen) {
        document.exitFullscreen?.();
        setIsFullscreen(false);
      } else {
        containerRef.current?.requestFullscreen?.();
        setIsFullscreen(true);
      }
    };
    ```

    **Search highlight integration:**
    Pass `searchMatchIds` to GraphSvg. GraphSvg accepts `searchMatchIds?: Set<string>` (added in Plan 03) and forwards it to useGraphSelection, which applies a distinct accent glow ring to matching nodes.

    **Source viewer behavior (per CONTEXT.md):**
    - Source viewer modal covers the graph center area
    - Graph is behind the modal and not visible while modal is open
    - Right sidebar stays fully interactive and NOT dimmed
    - User clicks different citations in the timeline sidebar -> source viewer updates dynamically
    - Close behavior: X button on modal closes viewer, returns to graph, timeline stays open

    **B) Rewrite `frontend/src/app/(app)/cases/[id]/knowledge-graph/page.tsx`**

    Simplify the page component:
    ```tsx
    "use client";

    import { useParams } from "next/navigation";
    import { Loader2 } from "lucide-react";
    import { KnowledgeGraphCanvas } from "@/components/knowledge-graph/KnowledgeGraphCanvas";
    import { useCaseGraph } from "@/hooks/use-case-graph";

    export default function KnowledgeGraphPage() {
      const params = useParams();
      const { data, loading, error } = useCaseGraph(params.id as string);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-full">
            <Loader2 className="w-8 h-8 animate-spin text-stone" />
            <p className="ml-3 text-sm text-stone">Loading knowledge graph...</p>
          </div>
        );
      }

      if (error) {
        return (
          <div className="flex items-center justify-center h-full">
            <p className="text-red-500 text-sm">Error: {error.message}</p>
          </div>
        );
      }

      if (!data || data.entity_count === 0) {
        return (
          <div className="flex flex-col items-center justify-center h-full text-center">
            <p className="text-smoke text-lg font-medium mb-2">No Knowledge Graph Data</p>
            <p className="text-stone text-sm max-w-md">
              Run the analysis pipeline from the Command Center to generate the knowledge graph.
            </p>
          </div>
        );
      }

      return (
        <div className="h-[calc(100vh-120px)]">
          <KnowledgeGraphCanvas
            entities={data.entities}
            relationships={data.relationships}
          />
        </div>
      );
    }
    ```

    **C) Handle the old `knowledge-graph.tsx` monolith:**

    The old `frontend/src/components/app/knowledge-graph.tsx` (1370 lines) is now superseded by the decomposed components. Do NOT delete it — rename it to indicate it's superseded:
    - Add a comment at the top: `// SUPERSEDED: This monolithic component has been decomposed into components/knowledge-graph/*`
    - Remove the `export` from the main `KnowledgeGraph` function (or rename the export) so nothing accidentally imports the old version
    - The file can be deleted in a future cleanup, but per CLAUDE.md we don't throw away implementations without permission

    **D) Update `mock-graph-data.ts`:**

    The mock data uses the old types (Entity, Evidence, etc.). Since the hook now calls the real API, the mock data is no longer used. Add a comment at the top:
    ```
    // SUPERSEDED: Mock data no longer used. The useCaseGraph hook now fetches real data from the API.
    // This file is preserved for reference but not imported anywhere.
    ```
    Remove any active imports of this file from other modules if they exist.

    **E) Type-check and build verification:**

    After all changes:
    1. Run `cd frontend && bun run typecheck` — MUST pass with zero errors
    2. Run `cd frontend && bun run build` — MUST succeed
    3. If type errors exist in files that import old types, fix them. The main culprits will be:
       - `knowledge-graph/page.tsx` — already rewritten above
       - `evidence-source-panel.tsx` — already refactored in Plan 02
       - Any files that import `KnowledgeGraph` from old monolith — update imports
    4. Run `make generate-types` and `make format` before committing
  </action>
  <verify>
    1. `cd frontend && bun run typecheck` — zero errors
    2. `cd frontend && bun run build` — succeeds
    3. The page renders the 3-panel layout (can verify visually or check component structure)
    4. No imports of old `KnowledgeGraph` component from `components/app/knowledge-graph.tsx`
    5. No imports of `generateMockGraphData` anywhere
    6. Source viewer modal positioning covers graph area but not the right sidebar
    7. No `any` types in any modified file
    8. All new files have ABOUTME comments
  </verify>
  <done>
    KnowledgeGraphCanvas orchestrates the 3-panel layout: collapsible left filter panel, center GraphSvg, conditional right EntityTimeline sidebar, and SourceViewerModal overlay. Page component fetches real API data, shows loading/error/empty states. All inter-component state flows wired. Old monolith marked as superseded. Build passes with zero type errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Knowledge Graph visualization overhaul:
    - 3-panel layout (filter panel | graph | entity timeline)
    - D3.js force simulation with 5 forces, sqrt-scaled nodes, radial centrality
    - Edge deduplication with multi-relationship display
    - Selection highlighting (click node to highlight subgraph)
    - Search match highlighting (accent glow ring on matching nodes)
    - Filter panel with domain/entity type toggles, search, keyword filter
    - Entity timeline sidebar with chronological relationships
    - Source viewer modal with PDF, audio, video, image viewers
    - Fullscreen capability
    - Connected to real KG API (curated data from LLM KG Builder)
  </what-built>
  <how-to-verify>
    1. Navigate to a case that has been analyzed (has KG data from pipeline run)
    2. Open the Knowledge Graph tab from the case sidebar
    3. Verify the graph loads with real entity nodes (not mock data)
    4. Check that high-connection entities are closer to center
    5. Click a node — verify it highlights and connected edges turn bright, unconnected nodes/edges dim
    6. Check that the right sidebar opens showing relationships for the selected entity
    7. Click the chevron on a timeline entry to expand and see the source card
    8. Open the filter panel (left toggle) — toggle domain/entity type filters
    9. Type in the entity search box — verify matching nodes get an accent glow ring (distinct from selection)
    10. Click fullscreen button — verify the KG fills the viewport
    11. If source viewer works: click "View source" in a timeline entry, verify the modal opens
    12. URL to test: http://localhost:3000/cases/{your-case-id}/knowledge-graph

    **Performance check (important):**
    13. Open React DevTools Profiler, record while the graph simulation is running (nodes still moving)
    14. Verify that the GraphSvg component does NOT re-render on every tick — the Profiler should show minimal React renders during simulation (D3 handles tick updates via refs, not state)
    15. Note: 500-node stress testing is deferred — CONTEXT.md explicitly targets graphs of ~15-50 nodes. The density slider (for pruning large graphs) was intentionally skipped. If future cases produce >100 nodes, performance optimization will be addressed then.
  </how-to-verify>
  <resume-signal>Type "approved" to finalize, or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
- 3-panel layout renders correctly: left filter, center graph, right timeline
- GraphSvg receives filtered data and search match IDs
- Entity selection flows: graph click -> timeline opens, timeline close -> deselect
- Source viewer flows: timeline "View source" -> modal opens, modal close -> back to graph
- Fullscreen mode works (both enter and exit)
- Filter changes update the visible graph in real-time
- Search highlights with accent glow ring without filtering
- Empty state shows when no KG data exists
- Old monolith marked as superseded, not actively imported
- `bun run typecheck` passes
- `bun run build` passes
- No `any` types
- All new files have ABOUTME comments
- `make generate-types` and `make format` run cleanly
- D3 tick handler does NOT trigger React re-renders (verify with React DevTools Profiler)
- 500-node performance testing deferred: CONTEXT.md explicitly targets ~15-50 node graphs; density slider was intentionally skipped
</verification>

<success_criteria>
The complete KG visualization is working end-to-end: real API data renders as a force-directed graph with filtering, selection, search highlighting, entity timeline, source viewer, and fullscreen. A first-time user can identify key persons, organizations, and their relationships by exploring the graph. The codebase is cleanly decomposed into modular components replacing the old 1370-line monolith.
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-05-SUMMARY.md`
</output>
