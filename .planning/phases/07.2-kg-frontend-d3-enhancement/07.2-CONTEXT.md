# Phase 7.2: Knowledge Graph Frontend (D3.js Enhancement) - Context

**Gathered:** 2026-02-08
**Status:** Ready for planning

<domain>
## Phase Boundary

Transform the existing D3.js knowledge graph (`knowledge-graph.tsx`) into a premium investigative visualization with Epstein Doc Explorer-inspired force layout, physics, filtering, entity timeline panel, and multi-media source viewer — all local to the KG canvas, adapted to Holmes's Liquid Glass design system. Connected to real curated KG data from Phase 7.1 via existing KG API endpoints.

This phase does NOT include: new API endpoints, backend changes, chat integration, synthesis/hypothesis views, or new data processing. It consumes existing `GET /api/cases/:caseId/graph`, entity, and relationship APIs.

</domain>

<decisions>
## Implementation Decisions

### Node visual design
- 9 entity types: PERSON, ORGANIZATION, LOCATION, EVENT, ASSET, FINANCIAL_ENTITY, COMMUNICATION, DOCUMENT, OTHER
- Domain-based color palette derived from Holmes Liquid Glass warm palette — take cues from the Command Center muted color system (`command-center-config.ts` AGENT_TYPE_TINTS) for consistency
- Expressive node sizing: sqrt-scaled radius from 10-60px based on connection count (degree)
- Node labels below circles showing entity name

### Edge visual design
- Edge thickness varies by relationship strength (0-100 scale)
- Relationship label displayed directly on the edge — always horizontally oriented regardless of edge direction/angle (not rotated along the edge path)
- Hover tooltip shows extended but lightweight relationship details (must see the data available from the endpoint response or check the backend schemas to see what is made available)
- Multiple relationships between same entity pair → single edge with count (edge deduplication). However find a suitable and intuitive way to showcase both the relationships in a highly intuitive UX - no information should be lost.

### Selection highlighting
- Click a node → selected node gets accent glow/border
- Connected edges turn bright/white, connected nodes stay visible
- Unconnected nodes AND edges fade to ~20% opacity (dim everything unrelated)
- Click same node again → deselect, restore all to normal

### Two-panel layout (local to KG canvas)
- **Left panel (filters):** Collapsible toggle — closed by default for maximum canvas space, opens as panel (not overlay) pushing the graph
- **Center:** D3.js force-directed graph SVG canvas with dark background - the existing must be refined.
- All panels are LOCAL to the KG page content area, not in the app-wide sidebar
- Bottom instruction bar: "Click nodes to explore relationships · Scroll to zoom · Drag to pan"

### Right panel (App wide right sidebar with similar layout to the Command center sidebar at @frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx ) — Entity timeline
- Inspired by Epstein Doc Explorer right sidebar (see attached reference screenshot layout, adapt to Holmes design)
- Header: entity name, date range of relationships (IMPORTANT TO handle the case when the API response doesn't contain any timestamps), relationship count, close (X) button
- Filter by related entity name (text search input)
- Chronological list of relationships involving the selected entity
- Each entry: date/year, relationship description with entity names color-coded (selected entity in one accent, related entities in another) - colors should suit the overall app theme and vibe - see the colors from Command center and its sidebar.
- Expandable entries (chevron toggle) — expanding reveals the source document card inline:
  - Document name (clickable), summary, "Click to view full document" link
- Clicking "view full document/image/video/audio" opens the source viewer modal

### Source viewer modal
- Opens as a panel on top of the graph area (left of the right sidebar)
- Graph is behind the modal and not visible while modal is open
- **Right sidebar remains fully interactive and NOT dimmed** — acts as a navigation index/remote control
- User clicks different citations/sources in the timeline sidebar → source viewer updates dynamically to show that content
- Content type determines the viewer rendered inside the modal. Each of these dynamic content features must be modular components that are rendered inside the parent modal but can be extended and improved independantly:
  - **PDF/Document:** Embedded PDF viewer (react-pdf or similar). THIS FUNCTIONALITY DESERVES ITS OWN DEDICATED STEP: Clicking on a source from the right sidebar makes the pdf jump to cited page, AND highlight relevant sections - IT MUST BE (WEB) RESEARCHED EXTENSIVELY WHAT ARE THE BEST LIBRARIES TO SUPPORT THIS.
  - **Audio:** Audio waveform player at top (play/pause/seek) with synchronized transcript cards below. Playing audio highlights the active speaker card. Timestamped entries with speaker diarization.
  - **Video:** HTML5 video player with visual timestamp markers on the seekbar for cited moments. Click a marker to jump to that timestamp.
  - **Image:** Zoomable image with pan/zoom controls. Metadata below (filename, dimensions, date). No annotation overlays for Phase 7.2.
- Close behavior (two levels):
  - X button on modal → closes viewer, returns to graph, timeline stays open
  - Deselecting entity in right panel → closes viewer, returns to graph, timeline stays open

### Shared source viewer component
- The existing `evidence-source-panel.tsx` must be refactored into a shared, modular source viewer component
- Used by BOTH the Evidence Library and Knowledge Graph screens
- Current issues to fix: removes background blur/dimming, fix centering, fix z-index (app sidebar must not overlay it), reduce frosted glass to subtle level
- Visual style: subtle glass — hint of translucency but much less than current, darker backdrop, no blur of content behind it. Refined, not heavy.
- **Architecture must be highly modular** — individual content-type viewers (PDF, audio, video, image) are separate sub-components that render dynamically inside the modal shell. This enables future improvements to individual viewers without touching the modal or other viewers.

### Filtering controls (left panel)
- **Domain layer toggles:** Financial, Legal, Evidence, Strategy — filter by relationship source domain (entities found ONLY by toggled-off domain are hidden; entities found by multiple domains stay visible when at least one source domain is active)
- **Entity type toggles:** All 9 types (PERSON, ORGANIZATION, LOCATION, EVENT, ASSET, FINANCIAL_ENTITY, COMMUNICATION, DOCUMENT, OTHER) with count per type (e.g., "PERSON (7)")
- **Entity search:** Debounced text input. Matching nodes get bright highlight ring/glow. Non-matching nodes fade to low opacity. Graph stays complete — search highlights, doesn't filter.
- **Keyword filter:** Comma-separated fuzzy match against relationship labels and entity names
- **Graph stats display:** Entity count, relationship count, domain breakdown
- **No density threshold slider** for Phase 7.2 — skip for smaller graphs (~15-50 nodes)

### D3.js force simulation
- 5 forces: link, charge, center, collision, radial
- Radial force: high-connection entities gravitate toward center, low-connection pushed outward (Research a proper physics based system for this-feel free to check out the frontend code and formula from Epstein repo files at @DOCS/reference/epstein-network-ui/Epstein-doc-explorer/network-ui/ )
- Collision detection using actual circle radius + padding
- Continuous simulation with tick-based position updates
- Drag individual nodes (fix position during drag, release on drop)
- Zoom/pan with d3.zoom()
- Performance: separate useEffect for selection highlighting (don't re-run simulation on select changes, use stored D3 selection refs)

### Claude's Discretion
- Exact force simulation tuning parameters (charge strength, link distance, radial strength)
- Node label font size and truncation for long entity names
- Exact color hex values for the 9 entity type palette (inspired by Command Center tints)
- Edge label positioning algorithm (ensure horizontal orientation)
- Zoom extent limits
- Animation easing for panel open/close transitions
- Mobile/responsive breakpoints (if applicable)
- Exact waveform library choice for audio player (something minimalistic and aesthetic)

</decisions>

<specifics>
## Specific Ideas

- "Take cues from the Command Center muted color system for the entity type palette" — consistency across Holmes visualization screens
- Entity timeline right panel layout inspired by Epstein Doc Explorer right sidebar (chronological entries, expandable to show source document cards, entity names color-coded)
- Source viewer modal acts as a dynamic content area controlled by the right sidebar — sidebar is the "remote control", modal is the "screen"
- Audio viewer should show transcript with timestamped speaker entries (like the audio reference screenshot: timestamp + speaker name + content per card)
- The shared source viewer modal must be reusable and modular for future improvements to individual content-type viewers

## Reference Code

- **Epstein Doc Explorer network-ui:** `DOCS/reference/epstein-network-ui/Epstein-doc-explorer/network-ui/src/` — Use as light reference for D3.js force layout patterns, panel architecture, entity timeline, and document viewer. Key files: `components/NetworkGraph.tsx`, `components/Sidebar.tsx`, `components/RightSidebar.tsx`, `components/DocumentModal.tsx`, `App.tsx`, `types.ts`
- **Epstein README analysis:** `DOCS/reference/epstein-network-ui/README.md` — Detailed adaptation notes for Holmes (force formula, color mapping, layout, data types)

</specifics>

<deferred>
## Deferred Ideas

- Density threshold slider — skip for Phase 7.2, revisit if graphs grow beyond ~50 nodes
- Image annotation overlays (bounding boxes on image viewer) — future enhancement
- vis-network alternative (Phase 7.3, optional)

</deferred>

---

*Phase: 07.2-kg-frontend-d3-enhancement*
*Context gathered: 2026-02-08*
