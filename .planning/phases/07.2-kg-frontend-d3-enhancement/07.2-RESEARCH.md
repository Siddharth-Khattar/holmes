# Phase 7.2: Knowledge Graph Frontend (D3.js Enhancement) - Research

**Researched:** 2026-02-08
**Domain:** D3.js force-directed graph visualization, React panel layout, multi-media source viewer
**Confidence:** HIGH

## Summary

This research covers the full scope of Phase 7.2: transforming the existing `knowledge-graph.tsx` D3.js force graph into a premium investigative visualization with Epstein Doc Explorer-inspired layout, panels, and a multi-media source viewer. The research covers the existing codebase state, the reference Epstein code patterns, the backend API data shape, the design system, and library choices for PDF viewing and audio waveform display.

The existing KnowledgeGraph component is a 1370-line monolith using D3 force simulation with 5 forces, SVG rendering via React state updates per tick, zoom/pan, drag, and a simple node info panel. It uses mock data via `useCaseGraph` hook. The backend API (`GET /api/cases/:caseId/graph`) returns `GraphResponse` with rich entity/relationship schemas including `degree`, `domain`, `entity_type`, `temporal_context`, `evidence_excerpt`, `source_finding_ids`, and `domains` fields -- far richer than the current frontend types model.

The Epstein Doc Explorer reference provides validated patterns for: separated selection useEffect (performance), sqrt-scaled node radius via `d3.scalePow().exponent(0.5)`, radial force formula for centrality, edge deduplication with count, right sidebar entity timeline with expandable document cards, and document text viewer with dual-term highlighting.

**Primary recommendation:** Decompose the monolithic `knowledge-graph.tsx` into modular components (graph canvas, left filter panel, right entity timeline sidebar, source viewer modal with pluggable media sub-components), connect to the real KG API replacing mock data, and use `@react-pdf-viewer/core` for PDF viewing and `wavesurfer.js` + `@wavesurfer/react` for audio waveforms.

## Standard Stack

### Core (already installed)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `d3-force` | ^3.0.0 | Force simulation engine | Already in use, proven D3 force simulation |
| `d3-selection` | ^3.0.0 | DOM manipulation for D3 | Already in use, needed for stored selection refs |
| `d3-zoom` | ^3.0.0 | Zoom/pan behavior | Already in use |
| `d3-drag` | ^3.0.0 | Node drag behavior | Already installed but not imported yet |
| `d3-transition` | ^3.0.1 | Smooth zoom transitions | Already in use |

### New Dependencies Required
| Library | Version | Purpose | Why This Library |
|---------|---------|---------|------------------|
| `@react-pdf-viewer/core` | ^3.12 | PDF rendering in modal | Built on pdf.js, TypeScript-first, plugin architecture for highlight + page navigation |
| `@react-pdf-viewer/default-layout` | ^3.12 | Default PDF layout with toolbar | Provides page nav, zoom, search out of the box |
| `@react-pdf-viewer/highlight` | ^3.12 | Text/area highlighting in PDF | `jumpToHighlightArea` function for citation-based navigation |
| `@react-pdf-viewer/page-navigation` | ^3.12 | Jump-to-page API | `jumpToPage()` function for sidebar-driven navigation |
| `@react-pdf-viewer/search` | ^3.12 | Text search within PDF | Programmatic keyword highlighting |
| `pdfjs-dist` | ^3.11 | PDF.js worker (peer dep) | Required by @react-pdf-viewer |
| `wavesurfer.js` | ^7.x | Audio waveform visualization | De facto standard for web audio waveforms, 14K+ weekly npm downloads |
| `@wavesurfer/react` | ^1.x | React hooks for wavesurfer | Official React wrapper by wavesurfer author, `useWavesurfer` hook |
| `d3-scale` | ^4.0.0 | Scale functions (scalePow for sqrt) | Needed for `d3.scalePow().exponent(0.5)` node sizing |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| `@react-pdf-viewer/core` | `react-pdf` (wojtekmaj) | react-pdf is simpler but lacks built-in highlight/search plugins; would need manual highlight overlays |
| `@react-pdf-viewer/core` | `react-pdf-highlighter` | Good for annotation UX but designed for user-created highlights, not programmatic citation jumping |
| `wavesurfer.js` | `react-wavy-audio` | Less mature, fewer features, smaller community |
| `wavesurfer.js` | Native HTML5 `<audio>` + canvas | Would need to hand-roll waveform rendering |

**Installation:**
```bash
bun add @react-pdf-viewer/core @react-pdf-viewer/default-layout @react-pdf-viewer/highlight @react-pdf-viewer/page-navigation @react-pdf-viewer/search pdfjs-dist wavesurfer.js @wavesurfer/react d3-scale
```

## Architecture Patterns

### Current State (What Exists)

```
frontend/src/
  components/app/
    knowledge-graph.tsx          # 1370-line monolith (D3 force graph + all UI)
    evidence-source-panel.tsx    # 462-line mock source viewer (used by detail sidebar)
  types/
    knowledge-graph.ts           # Types with 6 entity types (needs 9), old Evidence model
  lib/
    mock-graph-data.ts           # Mock data generator (to be replaced with real API)
  hooks/
    use-case-graph.ts            # Hook returning mock data (needs real API integration)
    useDetailSidebar.ts          # App-wide right sidebar context hooks
  app/(app)/cases/[id]/
    knowledge-graph/page.tsx     # Simple page wrapper passing mock data to component
```

### Target Architecture

```
frontend/src/
  components/knowledge-graph/
    KnowledgeGraphCanvas.tsx       # Main container: 3-panel layout orchestrator
    GraphSvg.tsx                   # D3 force simulation SVG canvas (extracted from monolith)
    FilterPanel.tsx                # Left collapsible panel (domain, entity type, search, keyword, stats)
    EntityTimeline.tsx             # Right sidebar panel (relationship chronology)
    EntityTimelineEntry.tsx        # Single timeline entry (expandable with source card)
    SourceViewerModal.tsx          # Modal shell overlaying graph area
    viewers/
      PdfViewer.tsx                # @react-pdf-viewer integration
      AudioViewer.tsx              # wavesurfer.js waveform + transcript cards
      VideoViewer.tsx              # HTML5 video with timestamp markers
      ImageViewer.tsx              # Zoomable image with metadata
    hooks/
      useKnowledgeGraph.ts         # Real API hook (replaces use-case-graph mock)
      useGraphSimulation.ts        # D3 force simulation lifecycle
      useGraphSelection.ts         # Selection state + highlighting (separate from simulation)
      useGraphFilters.ts           # Filter state management
  types/
    knowledge-graph.ts             # Updated types matching backend GraphResponse schema
```

### Pattern 1: D3 Simulation Lifecycle via useRef (No React Re-renders on Tick)

**What:** The D3 force simulation runs independently of React's render cycle. Node positions are updated directly via D3 selection refs, not via React state.
**When to use:** Always for force simulation tick handlers. The current code uses `setNodePositions(new Map(...))` per tick which creates excessive React re-renders.
**Source:** Epstein Doc Explorer `NetworkGraph.tsx` lines 448-456

```typescript
// CORRECT: D3 updates DOM directly via stored refs
const nodeGroupRef = useRef<d3.Selection<SVGGElement, GraphNode, SVGGElement, unknown>>();
const linkGroupRef = useRef<d3.Selection<SVGLineElement, GraphLink, SVGGElement, unknown>>();

simulation.on('tick', () => {
  linkGroupRef.current
    ?.attr('x1', (d: ForceLink) => (d.source as ForceNode).x!)
    .attr('y1', (d: ForceLink) => (d.source as ForceNode).y!)
    .attr('x2', (d: ForceLink) => (d.target as ForceNode).x!)
    .attr('y2', (d: ForceLink) => (d.target as ForceNode).y!);

  nodeGroupRef.current
    ?.attr('transform', (d: ForceNode) => `translate(${d.x},${d.y})`);
});
```

```typescript
// WRONG (current code): React state update per tick causes excessive re-renders
simulation.on('tick', () => {
  const newPositions = new Map<string, Position>();
  forceNodesRef.current.forEach((node) => {
    newPositions.set(node.id, { x: node.x!, y: node.y! });
  });
  requestAnimationFrame(() => setNodePositions(newPositions)); // BAD: triggers React re-render
});
```

### Pattern 2: Separate Selection useEffect (Performance)

**What:** Selection highlighting runs in a separate `useEffect` that only updates node/link visual attributes, never re-creates or re-runs the simulation.
**When to use:** Whenever selection state changes (node click/deselect).
**Source:** Epstein Doc Explorer `NetworkGraph.tsx` lines 465-500

```typescript
// Separate effect: selection changes do NOT re-run simulation
useEffect(() => {
  if (!nodeGroupRef.current || !linkGroupRef.current) return;

  // Update node opacity/fill
  nodeGroupRef.current.selectAll('circle')
    .attr('fill', (d: GraphNode) =>
      selectedNodeId && d.id === selectedNodeId ? SELECTED_COLOR : d.color
    )
    .attr('opacity', (d: GraphNode) => {
      if (!selectedNodeId) return 1;
      return d.id === selectedNodeId || connectedIds.has(d.id) ? 1 : 0.2;
    });

  // Update edge opacity/stroke
  linkGroupRef.current
    .attr('stroke', (d: ForceLink) => isConnected(d) ? '#ffffff' : EDGE_DEFAULT_COLOR)
    .attr('stroke-opacity', (d: ForceLink) => {
      if (!selectedNodeId) return 0.6;
      return isConnected(d) ? 1 : 0.15;
    });
}, [selectedNodeId]); // Only dependency is selection state
```

### Pattern 3: Edge Deduplication with Count

**What:** Multiple relationships between the same entity pair are collapsed into a single rendered edge with a count badge.
**Source:** Epstein Doc Explorer `NetworkGraph.tsx` lines 34-83

```typescript
// Build deduplicated edges
const edgeMap = new Map<string, { relationships: Relationship[]; count: number }>();

relationships.forEach((rel) => {
  // Canonical key: sorted pair ensures A->B and B->A are same edge
  const ids = [rel.source_entity_id, rel.target_entity_id].sort();
  const edgeKey = `${ids[0]}|||${ids[1]}`;

  if (!edgeMap.has(edgeKey)) {
    edgeMap.set(edgeKey, { relationships: [rel], count: 1 });
  } else {
    const existing = edgeMap.get(edgeKey)!;
    existing.relationships.push(rel);
    existing.count += 1;
  }
});
```

### Pattern 4: Radial Force Formula (Centrality-Based)

**What:** Nodes with more connections are pulled toward the center; low-connection nodes are pushed outward.
**Source:** Epstein Doc Explorer uses `(50 - Math.min(val, 50)) * 33 + 200` for large graphs. For Holmes (~15-50 nodes), adapt to smaller radius range.

```typescript
// Holmes adaptation for smaller graphs
const maxConnections = Math.max(...nodes.map(n => n.degree), 1);

forceRadial<ForceNode>((d) => {
  const degree = d.degree ?? 0;
  // High degree = small radius (center), low degree = large radius (periphery)
  const normalized = degree / maxConnections; // 0 to 1
  const minRadius = 50;
  const maxRadius = Math.min(width, height) * 0.35;
  return maxRadius - normalized * (maxRadius - minRadius);
}, width / 2, height / 2).strength((d) => {
  const degree = d.degree ?? 0;
  return degree === 0 ? 0.15 : 0.05 + (degree / maxConnections) * 0.1;
})
```

### Pattern 5: Right Sidebar as "Remote Control" for Source Viewer

**What:** The right sidebar (entity timeline) stays interactive when the source viewer modal is open. Clicking different citations in the sidebar updates the modal content.
**When to use:** Source viewer modal + right sidebar interaction.

```typescript
// State management pattern
interface KGPageState {
  selectedEntityId: string | null;
  sourceViewerContent: SourceViewerContent | null; // { type, url, page?, timestamp? }
  isFilterPanelOpen: boolean;
}

// Right sidebar clicks update source viewer without closing sidebar
const handleViewSource = (content: SourceViewerContent) => {
  setSourceViewerContent(content); // Modal opens/updates
  // Sidebar stays open and interactive
};
```

### Anti-Patterns to Avoid

- **React state per simulation tick:** The current code sets `nodePositions` state on every tick, causing React re-renders at 60fps. Use D3 selection refs instead.
- **Monolithic component:** The 1370-line `knowledge-graph.tsx` must be decomposed. Force simulation, rendering, panels, and modals should be separate components.
- **Evidence nodes as graph nodes:** The current mock data treats evidence items as graph nodes (squares). The real KG API returns only entities and relationships. Evidence is accessed via `source_finding_ids` on entities/relationships, not as graph nodes.
- **Hardcoded entity types:** The current `EntityType` has 6 types. The backend/CONTEXT specifies 9: PERSON, ORGANIZATION, LOCATION, EVENT, ASSET, FINANCIAL_ENTITY, COMMUNICATION, DOCUMENT, OTHER.
- **String-based entity_type:** The backend returns `entity_type` as a free-form string (e.g., "person", "organization"). The frontend must handle this gracefully with a color map that has a fallback for unknown types.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| PDF rendering + page navigation | Custom PDF canvas renderer | `@react-pdf-viewer/core` + plugins | PDF.js integration is complex; page-level rendering, text layer, search, and highlight all need the PDF.js text layer which is non-trivial |
| Audio waveform visualization | Canvas-based custom waveform | `wavesurfer.js` + `@wavesurfer/react` | Waveform generation from audio buffers requires Web Audio API decoding and canvas rendering; wavesurfer handles this with a mature API |
| Sqrt-scaled node sizing | Manual `Math.sqrt()` with linear interpolation | `d3.scalePow().exponent(0.5).domain([min, max]).range([10, 60])` | D3's scale functions handle domain/range mapping, clamping, and edge cases correctly |
| D3 zoom behavior | Custom wheel + drag handlers | `d3.zoom()` with `.scaleExtent()` and `.filter()` | Already in use; D3 zoom handles touch events, momentum, and transform composition |
| Debounced search input | Custom setTimeout tracking | `useDebounce` hook (already exists at `hooks/useDebounce.ts`) | Already in codebase |

## Common Pitfalls

### Pitfall 1: React State Updates in D3 Tick Handler
**What goes wrong:** Setting React state (e.g., `setNodePositions`) on every simulation tick (60fps) causes React to re-render the entire component tree 60 times per second. This creates janky animations and high CPU usage.
**Why it happens:** The natural React pattern is to store positions in state, but force simulations tick at animation-frame rate.
**How to avoid:** Use D3 selection refs (`nodeGroupRef.current`, `linkGroupRef.current`) to update DOM attributes directly. React never knows about intermediate positions.
**Warning signs:** Component re-renders visible in React DevTools profiler during simulation, `setNodePositions` in tick handler, `requestAnimationFrame` wrapping state updates.

### Pitfall 2: Re-Running Simulation on Selection Change
**What goes wrong:** If the selection highlighting effect is inside the same `useEffect` as simulation setup, clicking a node re-creates the entire simulation, causing nodes to jump and re-animate.
**Why it happens:** `selectedNodeId` is in the dependency array of the simulation setup effect.
**How to avoid:** Two separate `useEffect` hooks: one for simulation lifecycle (depends on data/dimensions), one for selection styling (depends only on `selectedNodeId`).
**Warning signs:** Nodes visually reset/jump when clicking, simulation alpha resets to 1.0 on node click.

### Pitfall 3: Frontend Types Mismatch with Backend API
**What goes wrong:** The current frontend `EntityType` is `"person" | "organization" | "location" | "event" | "document" | "evidence"` (6 types), but the backend returns 9+ types as free-form strings. The `Relationship` type uses `strength: number` (0-1 float), but the backend returns `strength: int` (0-100 integer).
**Why it happens:** Frontend types were designed around mock data, not the actual API schema.
**How to avoid:** Rewrite `knowledge-graph.ts` types to match `EntityResponse` and `RelationshipResponse` from `backend/app/schemas/knowledge_graph.py`. Use the backend field names (e.g., `entity_type`, `source_entity_id`, `target_entity_id`).
**Warning signs:** TypeScript errors when consuming API data, missing fields, incorrect strength scaling.

### Pitfall 4: wavesurfer.js Plugin Array Re-creation
**What goes wrong:** Passing a new plugins array on every render causes wavesurfer.js to error because it mutates plugin instances during initialization.
**Why it happens:** Inline array literals create new references on each render.
**How to avoid:** Memoize the plugins array with `useMemo` or define it outside the component.
**Warning signs:** Console errors from wavesurfer about plugin re-initialization.

### Pitfall 5: PDF.js Worker Path Configuration
**What goes wrong:** `@react-pdf-viewer/core` requires the `pdfjs-dist` worker to be available at a specific path. If misconfigured, PDFs silently fail to render.
**Why it happens:** Next.js bundles differently from Vite; the worker path needs explicit configuration.
**How to avoid:** Set the worker URL explicitly: `import { Worker } from '@react-pdf-viewer/core'; <Worker workerUrl="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js">`. Alternatively, copy the worker to the `public/` directory.
**Warning signs:** Blank PDF viewer, console errors about worker not found.

### Pitfall 6: Detail Sidebar vs Local Sidebar Confusion
**What goes wrong:** The current code uses the app-wide `useDetailSidebarDispatch` to push evidence content to the global right sidebar. Phase 7.2 wants a LOCAL right panel within the KG canvas area, NOT the app-wide detail sidebar.
**Why it happens:** The existing implementation uses the app-wide detail sidebar system (`DetailSidebarProvider`, `useDetailSidebar`).
**How to avoid:** The entity timeline right panel should be a LOCAL component rendered inside the KG page layout, managed by local state, NOT by the global `DetailSidebarProvider`. Remove the `useDetailSidebarDispatch` usage from the KG component.
**Warning signs:** Right panel appearing in the app-wide sidebar slot instead of within the KG content area.

## Code Examples

### Backend API Response Shape (EntityResponse)

The backend `GraphResponse` shape from `GET /api/cases/:caseId/graph`:

```typescript
// From backend/app/schemas/knowledge_graph.py
interface GraphResponse {
  entities: EntityResponse[];
  relationships: RelationshipResponse[];
  entity_count: number;
  relationship_count: number;
}

interface EntityResponse {
  id: string;          // UUID
  case_id: string;     // UUID
  name: string;
  name_normalized: string;
  entity_type: string; // "person", "organization", "location", "event", "asset",
                       // "financial_entity", "communication", "document", "other"
  domain: string;      // "financial", "legal", "evidence", "strategy"
  confidence: number;  // 0-100
  properties: Record<string, unknown> | null;
  context: string | null;
  aliases: string[] | null;
  description_brief: string | null;    // One-liner for tooltips
  description_detailed: string | null; // Multi-sentence synthesis
  domains: string[] | null;            // ALL domains this entity appears in
  source_finding_ids: string[] | null; // For tracing back to evidence
  source_execution_id: string | null;
  source_finding_index: number | null;
  merged_into_id: string | null;
  merge_count: number;
  degree: number;      // Pre-computed connection count for node sizing
  created_at: string;  // ISO datetime
}

interface RelationshipResponse {
  id: string;          // UUID
  case_id: string;
  source_entity_id: string;
  target_entity_id: string;
  relationship_type: string;   // "associated_with", "owns", "sent_to", etc.
  label: string;               // Human-readable edge label
  strength: number;            // 0-100 integer (NOT 0-1 float)
  source_execution_id: string | null;
  properties: Record<string, unknown> | null;
  evidence_excerpt: string | null;      // Verbatim source quote
  source_finding_ids: string[] | null;
  temporal_context: string | null;      // "2023-Q3", "March 2024", etc.
  corroboration_count: number | null;   // How many agents found this
  confidence: number | null;            // 0-100
  created_at: string;
}
```

### Node Sizing with d3.scalePow (Sqrt Scale)

```typescript
import { scalePow } from 'd3-scale';

// Entity degree comes from API (pre-computed in backend)
const maxDegree = Math.max(...entities.map(e => e.degree), 1);

const radiusScale = scalePow()
  .exponent(0.5)          // Square root scaling
  .domain([0, maxDegree])
  .range([10, 60])        // 10px min, 60px max per CONTEXT.md
  .clamp(true);

// Usage: radiusScale(entity.degree) -> pixel radius
```

### Edge Thickness by Relationship Strength

```typescript
// Relationship strength is 0-100 integer from backend
const edgeWidthScale = (strength: number): number => {
  // Map 0-100 to 1-6px stroke width
  return 1 + (strength / 100) * 5;
};
```

### 9 Entity Type Color Palette

```typescript
// Inspired by Command Center agent tints (warm, muted palette)
const ENTITY_TYPE_COLORS: Record<string, string> = {
  person:           '#5B8DEF', // Soft blue
  organization:     '#8B7BEF', // Muted purple
  location:         '#4DAF7C', // Sage green
  event:            '#E87461', // Warm coral
  asset:            '#D4A843', // Amber gold
  financial_entity: '#45B5AA', // Teal
  communication:    '#C27ADB', // Lavender
  document:         '#E09D5C', // Warm orange
  other:            '#8A8A82', // Stone (from design system)
};

// Fallback for any unknown types
const getEntityColor = (entityType: string): string =>
  ENTITY_TYPE_COLORS[entityType.toLowerCase()] ?? ENTITY_TYPE_COLORS.other;
```

### WaveSurfer.js Audio Viewer Pattern

```typescript
import { useRef, useMemo, useCallback } from 'react';
import { useWavesurfer } from '@wavesurfer/react';

interface AudioViewerProps {
  audioUrl: string;
  onTimeUpdate?: (currentTime: number) => void;
}

function AudioViewer({ audioUrl, onTimeUpdate }: AudioViewerProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  // IMPORTANT: memoize plugins to prevent re-initialization errors
  const plugins = useMemo(() => [], []);

  const { wavesurfer, isReady, isPlaying, currentTime } = useWavesurfer({
    container: containerRef,
    url: audioUrl,
    waveColor: '#8A8A82',       // stone color
    progressColor: '#F5F4EF',   // accent color
    height: 64,
    barWidth: 2,
    barGap: 1,
    barRadius: 2,
    plugins,
  });

  const handlePlayPause = useCallback(() => {
    wavesurfer?.playPause();
  }, [wavesurfer]);

  const handleSeek = useCallback((timestamp: number) => {
    wavesurfer?.seekTo(timestamp / (wavesurfer.getDuration() || 1));
  }, [wavesurfer]);

  return (
    <div>
      <div ref={containerRef} />
      {/* Play/pause button, time display, etc. */}
    </div>
  );
}
```

### React PDF Viewer with Jump-to-Page

```typescript
import { Viewer, Worker } from '@react-pdf-viewer/core';
import { pageNavigationPlugin } from '@react-pdf-viewer/page-navigation';
import { searchPlugin } from '@react-pdf-viewer/search';
import '@react-pdf-viewer/core/lib/styles/index.css';

interface PdfViewerProps {
  fileUrl: string;
  initialPage?: number;
  highlightKeyword?: string;
}

function PdfViewer({ fileUrl, initialPage, highlightKeyword }: PdfViewerProps) {
  const pageNavInstance = pageNavigationPlugin();
  const searchInstance = searchPlugin();
  const { jumpToPage } = pageNavInstance;
  const { highlight } = searchInstance;

  useEffect(() => {
    if (initialPage !== undefined && initialPage > 0) {
      // jumpToPage is 0-indexed
      jumpToPage(initialPage - 1);
    }
  }, [initialPage, jumpToPage]);

  useEffect(() => {
    if (highlightKeyword) {
      highlight({ keyword: highlightKeyword });
    }
  }, [highlightKeyword, highlight]);

  return (
    <Worker workerUrl="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js">
      <Viewer
        fileUrl={fileUrl}
        plugins={[pageNavInstance, searchInstance]}
        theme={{ theme: 'dark' }}
      />
    </Worker>
  );
}
```

## Existing Code Inventory

### What Must Change

| File | Current State | Required Change |
|------|---------------|-----------------|
| `knowledge-graph.tsx` | 1370-line monolith, all logic in one component | Decompose into GraphSvg, FilterPanel, EntityTimeline, SourceViewerModal. Refactor tick handler to use D3 refs instead of React state. |
| `types/knowledge-graph.ts` | 6 entity types, Evidence as graph node, Relationship.strength 0-1 float | Rewrite to match backend schema: 9+ entity types, no Evidence nodes, strength 0-100 int, add all EntityResponse/RelationshipResponse fields |
| `hooks/use-case-graph.ts` | Returns mock data with setTimeout(500) | Connect to real `GET /api/cases/:caseId/graph` endpoint, transform to frontend graph format |
| `lib/mock-graph-data.ts` | Mock entities/evidence/relationships | Update to match new types, or remove if real API is reliable |
| `evidence-source-panel.tsx` | Mock data, hardcoded in detail sidebar, evidence-centric | Refactor into shared modular source viewer with pluggable media sub-components |
| `knowledge-graph/page.tsx` | Simple wrapper, passes mock data | Orchestrate the new 3-panel layout, manage state for filter/selection/source viewer |
| `types/detail-sidebar.ts` | Has `KnowledgeGraphEvidenceContent` type | KG will no longer use the app-wide detail sidebar; remove or keep for future |
| `hooks/useDetailSidebar.ts` | Used by KG for evidence panel | KG should stop using this; entity timeline is local |

### What Must Be Preserved

| File/Pattern | Why Preserve |
|--------------|-------------|
| D3 force simulation setup (5 forces) | Core physics engine is correct, just needs parameter tuning |
| Zoom/pan via `d3.zoom()` | Working correctly |
| Canvas zoom controls component | `CanvasZoomControls` is reusable UI component |
| SVG dotted background pattern | Design element to keep |
| Node glow filter (`#node-glow`) | Visual polish to keep |
| Simulation freeze/unfreeze toggle | Useful UX feature |

### Key Backend Fields for Frontend Display

| Backend Field | Frontend Use |
|---------------|-------------|
| `entity.degree` | Node radius (sqrt-scaled 10-60px) |
| `entity.entity_type` | Node color |
| `entity.domain` / `entity.domains` | Filter panel domain toggles |
| `entity.description_brief` | Node tooltip |
| `entity.description_detailed` | Entity timeline header |
| `entity.aliases` | Search matching |
| `entity.source_finding_ids` | Link to source documents |
| `relationship.strength` (0-100) | Edge thickness |
| `relationship.label` | Edge label text |
| `relationship.temporal_context` | Timeline sorting, display |
| `relationship.evidence_excerpt` | Timeline entry expanded view |
| `relationship.source_finding_ids` | "View source" button in timeline |
| `relationship.corroboration_count` | Display in tooltip or timeline |

## State of the Art

| Old Approach (current code) | Current Approach (target) | Impact |
|---------------------------|--------------------------|--------|
| React state per tick (`setNodePositions`) | D3 selection refs (`nodeGroupRef.current.attr()`) | Eliminates 60fps React re-renders during simulation |
| 6 hardcoded entity types | 9 entity types matching backend schema + fallback | Accurate visualization of all KG entities |
| Evidence as graph nodes (squares) | Entities only; evidence accessed via source_finding_ids | Matches real API data model; cleaner graph |
| Mock data via `generateMockGraphData()` | Real `GET /api/cases/:caseId/graph` API | Live data from KG Builder agent |
| App-wide detail sidebar for evidence | Local right panel (entity timeline) + source viewer modal | Better UX; panels stay within KG canvas |
| Fixed 30px node radius | sqrt-scaled 10-60px based on `entity.degree` | Visual hierarchy showing entity importance |
| Static relationship labels | Horizontal relationship labels with strength-based thickness | Information density without visual clutter |
| No filtering | Domain toggles, entity type toggles, text search, keyword filter | Investigative exploration capability |

## Design System Integration

### Color System
- **Background:** `var(--color-charcoal)` / `#050505` (dark mode graph canvas)
- **Panel backgrounds:** `var(--color-jet)` / `#111111`
- **Text:** `var(--color-smoke)` / `#f8f7f4` (primary), `var(--color-stone)` / `#8a8a82` (muted)
- **Borders:** `rgba(138, 138, 130, 0.15)` (stone at 15%)
- **Entity type colors:** Muted, warm palette inspired by Command Center tints
- **Edge default:** `#4b5563` (gray-600), selected: `#ffffff` (white)

### Typography
- **Font:** DM Sans (`var(--font-family-sans)`)
- **Node labels:** 11-12px, below node, truncated with ellipsis
- **Panel headers:** 13-14px font-medium
- **Panel content:** 12-13px text-sm

### Panel Styling
- Use `border-stone/15` for panel borders
- Use `bg-jet` or `bg-charcoal` for panel backgrounds
- Follow `CollapsibleSection` pattern from `NodeDetailsSidebar.tsx` for consistent section styling
- Panel transitions: 200-300ms ease-out for open/close

### Right Sidebar Pattern (from NodeDetailsSidebar)
- Width: fixed-width right panel (similar to `w-96` or custom width)
- Header: gradient background with `hsl(tint / 0.15)` pattern
- Sections: `CollapsibleSection` with color-coded left border
- Scrollable content area with `scrollbarWidth: "thin"`
- Status badges and pills pattern for metadata display

## Open Questions

1. **Source document file URLs:** The backend `source_finding_ids` on entities/relationships point to `case_findings` table entries. How do we get the actual file URL (PDF, audio, video, image) for the source viewer? The `case_findings` likely reference files via the file upload system. Need to trace: `source_finding_ids` -> `case_findings` -> `file_id` -> file URL from storage. This may require an additional API call or embedding file metadata in the graph response.

2. **Transcript data for audio:** The CONTEXT specifies "timestamped entries with speaker diarization" for the audio viewer. Where does transcript/diarization data come from? It would need to be stored in `case_findings` or a separate transcript table. If not available from the backend, the audio viewer should gracefully degrade to waveform-only.

3. **PDF page citation:** The CONTEXT specifies jumping to cited page and highlighting sections. The `evidence_excerpt` field on relationships has the text quote, but there's no `page_number` field. Without page numbers, we can use the search plugin to find the excerpt text in the PDF, but this requires the PDF to have a text layer (scanned PDFs won't work without OCR).

4. **Video timestamp markers:** The CONTEXT mentions "visual timestamp markers on the seekbar for cited moments." There's no backend field for video timestamps on relationships. This would need `temporal_context` to contain parseable video timestamps, or a separate metadata structure.

## Sources

### Primary (HIGH confidence)
- Backend API schemas: `backend/app/schemas/knowledge_graph.py` - all EntityResponse and RelationshipResponse fields
- Backend API endpoints: `backend/app/api/knowledge_graph.py` - GET /graph, entity CRUD, relationship CRUD
- Backend models: `backend/app/models/knowledge_graph.py` - KgEntity and KgRelationship SQLAlchemy models
- Existing frontend: `frontend/src/components/app/knowledge-graph.tsx` - current 1370-line implementation
- Frontend types: `frontend/src/types/knowledge-graph.ts` - current type definitions
- Design system: `DOCS/UI/DESIGN-SYSTEM.md` - color tokens, typography, glass effects
- Globals CSS: `frontend/src/app/globals.css` - Tailwind tokens, Command Center scoped variables
- Command center config: `frontend/src/lib/command-center-config.ts` - agent color system
- Command center sidebar: `frontend/src/components/CommandCenter/NodeDetailsSidebar.tsx` - CollapsibleSection pattern
- Detail sidebar context: `frontend/src/contexts/detail-sidebar-context.tsx` - app-wide sidebar system
- Epstein reference: `DOCS/reference/epstein-network-ui/README.md` - adaptation guide
- Epstein NetworkGraph: `DOCS/reference/epstein-network-ui/.../NetworkGraph.tsx` - D3 patterns
- Epstein RightSidebar: `DOCS/reference/epstein-network-ui/.../RightSidebar.tsx` - timeline pattern
- Epstein DocumentModal: `DOCS/reference/epstein-network-ui/.../DocumentModal.tsx` - document viewer pattern
- Context decisions: `.planning/phases/07.2-kg-frontend-d3-enhancement/07.2-CONTEXT.md`

### Secondary (MEDIUM confidence)
- [React PDF Viewer](https://react-pdf-viewer.dev/) - Highlight, page navigation, search plugins
- [React PDF Viewer GitHub](https://github.com/react-pdf-viewer/react-pdf-viewer) - TypeScript support, plugin architecture
- [@wavesurfer/react npm](https://www.npmjs.com/package/@wavesurfer/react) - Official React wrapper, useWavesurfer hook
- [WaveSurfer.js](https://wavesurfer.xyz/) - Audio waveform library
- [D3.js + React patterns](https://medium.com/@tibotiber/react-d3-js-balancing-performance-developer-experience-4da35f912484) - useRef/useEffect best practices

### Tertiary (LOW confidence)
- [react-pdf-highlighter-extended](https://github.com/DanielArnould/react-pdf-highlighter-extended) - Alternative PDF highlighting
- [react-wave-audio-player](https://github.com/theabhipatel/react-wave-audio-player) - Alternative audio waveform

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - existing D3 deps verified in package.json, new deps verified via npm/GitHub
- Architecture: HIGH - full codebase read, all existing patterns understood, clear decomposition plan
- Backend API shape: HIGH - read actual schemas, models, and API endpoints
- Pitfalls: HIGH - identified from code review of current implementation vs target
- PDF viewer: MEDIUM - @react-pdf-viewer verified via docs but not tested in this codebase
- Audio waveform: MEDIUM - @wavesurfer/react verified via npm but not tested in this codebase
- Open questions: HIGH - honestly documented gaps that need resolution during planning

**Research date:** 2026-02-08
**Valid until:** 2026-03-10 (30 days - stable domain, libraries are mature)
