---
phase: 08-synthesis-intelligence
plan: 07
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - frontend/src/types/timeline.types.ts
  - frontend/src/constants/timeline.constants.ts
  - frontend/src/lib/api/timelineApi.ts
  - frontend/src/hooks/useTimelineData.ts
  - frontend/src/components/Timeline/TimelineEventCard.tsx
  - frontend/src/app/(app)/cases/[id]/layout.tsx
  - frontend/src/components/app/case-nav-section.tsx
  - frontend/src/lib/api/cases.ts
  - frontend/src/types/case.ts
  - backend/app/schemas/case.py
autonomous: true

must_haves:
  truths:
    - "Timeline page shows real synthesis-generated events from the API (not mock data)"
    - "Timeline events have domain-based filtering (financial, legal, evidence, strategy)"
    - "Timeline event cards show domain tag and category"
    - "Case header shows verdict badge (Conclusive/Substantial/Inconclusive) when synthesis complete"
    - "Cases list page shows verdict badge for each case"
    - "Pre-synthesis state shows 'Pending Analysis' badge"
    - "Backend CaseResponse schema includes verdict_label and verdict_summary fields"
  artifacts:
    - path: "frontend/src/hooks/useTimelineData.ts"
      provides: "Real API data fetching (mock fallback removed)"
      contains: "timelineApi.getTimelineEvents"
    - path: "frontend/src/types/timeline.types.ts"
      provides: "Updated TimelineLayer to include 'financial'"
      contains: "financial"
    - path: "backend/app/schemas/case.py"
      provides: "CaseResponse with verdict_label and verdict_summary fields"
      contains: "verdict_label"
  key_links:
    - from: "frontend/src/hooks/useTimelineData.ts"
      to: "backend/app/api/timeline.py"
      via: "GET /api/cases/{caseId}/timeline"
      pattern: "getTimelineEvents"
    - from: "frontend/src/app/(app)/cases/[id]/layout.tsx"
      to: "backend/app/api/cases.py"
      via: "Case verdict_label field in API response"
      pattern: "verdict_label"
    - from: "backend/app/schemas/case.py"
      to: "backend/app/models/case.py"
      via: "from_attributes serialization of verdict columns"
      pattern: "verdict_label"
---

<objective>
Wire the Timeline page to real synthesis-generated API data, add verdict badge to case header and case list, and update backend CaseResponse schema to include verdict fields.

Purpose: Timeline currently uses mock data with API fallback. After synthesis runs, real timeline events exist in the DB. The case header and list also need verdict badges to show synthesis results at a glance. The backend CaseResponse schema must explicitly include the new verdict columns for them to appear in API responses.

Output: Timeline fetches from real API (mock removed), updated filter dimensions, verdict badge in case header and list, CaseResponse schema updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-synthesis-intelligence/08-CONTEXT.md
@.planning/phases/08-synthesis-intelligence/08-RESEARCH.md
@.planning/phases/08-synthesis-intelligence/08-03-SUMMARY.md
@frontend/src/types/timeline.types.ts
@frontend/src/hooks/useTimelineData.ts
@frontend/src/lib/api/timelineApi.ts
@frontend/src/constants/timeline.constants.ts
@frontend/src/components/Timeline/TimelineEventCard.tsx
@frontend/src/app/(app)/cases/[id]/layout.tsx
@frontend/src/components/app/case-nav-section.tsx
@backend/app/schemas/case.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Timeline to real API data</name>
  <files>
    frontend/src/types/timeline.types.ts
    frontend/src/constants/timeline.constants.ts
    frontend/src/lib/api/timelineApi.ts
    frontend/src/hooks/useTimelineData.ts
    frontend/src/components/Timeline/TimelineEventCard.tsx
  </files>
  <action>
**1. Update `frontend/src/types/timeline.types.ts`**:

- Add "financial" to `TimelineLayerSchema`: change from `z.enum(["evidence", "legal", "strategy"])` to `z.enum(["evidence", "legal", "strategy", "financial"])`
- Add optional `event_type` (category) field to `TimelineEventSchema`: `eventType: z.string().optional()` -- this is the category (transaction, meeting, filing, communication, etc.) from synthesis
- Add optional `domain` field as alias for layer: `domain: z.string().optional()` (the backend sends `layer` which maps to domain)
- The `date` field should accept the backend's `event_date` format. The backend returns `event_date` as an ISO datetime. The frontend timelineApi needs to remap this (see below).

**2. Update `frontend/src/constants/timeline.constants.ts`**:

- Update `TIMELINE_BASE_PATH` to use `NEXT_PUBLIC_API_URL`:
  ```typescript
  TIMELINE_BASE_PATH: `${process.env.NEXT_PUBLIC_API_URL || ""}/api/cases`
  ```
  Check what the current value is -- it might already be correct. If it's using a relative path, update it to use the environment variable pattern consistent with other API clients (check `lib/api/graph.ts` for the pattern).

- Add "financial" to any layer color/label mappings if they exist in the constants file.

**3. Update `frontend/src/lib/api/timelineApi.ts`**:

The `getTimelineEvents` method fetches from the backend. The backend now returns `TimelineEventResponse` objects with `event_date` (not `date`), and `layer` (which maps to the frontend's `layer` field).

Update the `getTimelineEvents` method to:
- Use `credentials: "include"` in the fetch call for auth (check if this is already done)
- Transform the response: map each event from backend format to frontend format:
  ```typescript
  const transformEvent = (backendEvent: Record<string, unknown>): TimelineEvent => ({
    id: backendEvent.id as string,
    caseId: backendEvent.case_id as string,
    title: backendEvent.title as string,
    description: backendEvent.description as string | undefined,
    date: backendEvent.event_date as string, // Remap field name
    layer: backendEvent.layer as TimelineLayer,
    sourceIds: (backendEvent.source_entity_ids as string[]) || [],
    entityIds: (backendEvent.source_entity_ids as string[]) || [],
    confidence: 0.8, // Backend doesn't have confidence; default
    isUserCorrected: false,
    metadata: { eventType: backendEvent.event_type },
    createdAt: backendEvent.created_at as string,
    updatedAt: backendEvent.created_at as string, // No separate updated_at in backend
  });
  ```
- The response shape from backend matches: `{ events: [...], totalCount: N, dateRange: {...}, layerCounts: {...} }`. Transform `events` array, pass through the rest. Adjust field names if backend uses snake_case vs camelCase.

**4. Update `frontend/src/hooks/useTimelineData.ts`**:

- Remove the mock data import: `import { generateMockTimelineResponse } from "@/lib/mock-timeline-data"`
- Remove the entire `catch` block that falls back to mock data. Replace with:
  ```typescript
  catch (error) {
    console.error("Timeline API failed:", error);
    throw error; // Let React Query handle the error state
  }
  ```
- Remove the mock data filtering logic
- The hook should now be a clean React Query wrapper around `timelineApi.getTimelineEvents`

**5. Update `frontend/src/components/Timeline/TimelineEventCard.tsx`**:

- Add domain/category tag display. Show the `layer` (domain) as a colored badge (use domain colors consistent with KG: financial=teal, legal=purple, evidence=orange, strategy=blue -- check `knowledge-graph-config.ts` for the exact domain colors).
- Show `eventType` from metadata if available as a secondary tag (e.g., "transaction", "filing")
- Keep existing card structure intact, just add the domain badge

Note: Do NOT remove the mock-timeline-data.ts file itself -- just remove the import from useTimelineData.ts. The file can be cleaned up later.
  </action>
  <verify>Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- no type errors. Check that `useTimelineData.ts` no longer imports mock data.</verify>
  <done>Timeline fetches from real backend API, mock data fallback removed from hook, TimelineLayer includes "financial", event cards show domain + category tags, field name mapping (event_date->date, layer->layer) works correctly</done>
</task>

<task type="auto">
  <name>Task 2: Backend CaseResponse schema + verdict badge in case header and list</name>
  <files>
    backend/app/schemas/case.py
    frontend/src/types/case.ts
    frontend/src/app/(app)/cases/[id]/layout.tsx
    frontend/src/components/app/case-nav-section.tsx
    frontend/src/lib/api/cases.ts
  </files>
  <action>
**1. Update backend CaseResponse schema** in `backend/app/schemas/case.py`:

Add two fields to the `CaseResponse` Pydantic model (or whatever the case response schema is named -- check the file):
```python
verdict_label: str | None = None
verdict_summary: str | None = None
```

This is REQUIRED for the backend to serialize and include these fields in API responses. Without this, the Case model's new verdict columns will not appear in GET /api/cases or GET /api/cases/{id} responses even though the DB columns exist.

Verify: After adding, run `python -c "from app.schemas.case import CaseResponse; print('verdict_label' in CaseResponse.model_fields)"` -- should print True.

**2. Update case types** (check `frontend/src/types/case.ts` or wherever the Case interface is defined):

Add two optional fields to the Case TypeScript interface:
```typescript
verdict_label?: "Conclusive" | "Substantial" | "Inconclusive" | null;
verdict_summary?: string | null;
```

If there's no dedicated case type file, find where the Case type is defined (might be inline in `lib/api/cases.ts` or `types/` somewhere) and add these fields.

**3. Update case header in `frontend/src/app/(app)/cases/[id]/layout.tsx`**:

The case layout shows a header with case name and status badge. Modify:
- If `case.verdict_label` exists (not null), show a verdict badge INSTEAD of the regular status badge
  - Conclusive: green badge
  - Substantial: amber badge
  - Inconclusive: red/gray badge
- Show `case.verdict_summary` as a one-line subtitle next to or below the case name (truncate with ellipsis if too long)
- If `verdict_label` is null, show "Pending Analysis" badge in neutral gray (when case has been processed but synthesis hasn't run yet) or the regular status badge for DRAFT cases
- The verdict badge should be small and compact -- not dominating the header

Look at the existing status badge styling and follow the same visual pattern, just with different colors and text.

**4. Update case list page**:

Find the cases list page (likely `frontend/src/app/(app)/cases/page.tsx` or similar). In each case card/row:
- If `case.verdict_label` is set, show a small verdict badge (Conclusive/Substantial/Inconclusive) instead of or alongside the case status
- Per CONTEXT.md: verdict badge only, no summary snippet on the list page
- Keep existing status badge for cases without verdict

**5. If the case API client** (`frontend/src/lib/api/cases.ts`) has a fetch function that returns Case objects, verify it passes through the new `verdict_label` and `verdict_summary` fields from the backend response. No code change should be needed if it's using spread or generic JSON parsing, but verify.
  </action>
  <verify>Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/backend && source .venv/bin/activate && python -c "from app.schemas.case import CaseResponse; print('verdict_label' in CaseResponse.model_fields)"` -- should print True. Then `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck && bun run build` -- both pass.</verify>
  <done>Backend CaseResponse schema includes verdict_label and verdict_summary. Case header shows verdict badge (Conclusive=green, Substantial=amber, Inconclusive=red) when synthesis complete, shows "Pending Analysis" otherwise. Case list shows verdict badge per case. verdict_summary displayed as subtitle in case header.</done>
</task>

</tasks>

<verification>
- Timeline page loads with real API data (no mock fallback in hook)
- Timeline events have "financial" as a valid layer/domain
- Timeline event cards show domain-colored badge + event type category
- Case header shows verdict badge when synthesis has completed
- Cases list shows verdict badge for analyzed cases
- Backend CaseResponse schema includes verdict_label and verdict_summary fields
- `bun run typecheck` and `bun run build` pass (frontend)
- `python -c "from app.schemas.case import CaseResponse; print('verdict_label' in CaseResponse.model_fields)"` prints True (backend)
</verification>

<success_criteria>
- Timeline shows synthesis-generated events from backend API
- "financial" layer is fully supported in filters and display
- Verdict badge replaces status badge in case header (Conclusive/Substantial/Inconclusive)
- One-line summary visible in case header next to verdict badge
- Cases list shows verdict badge without summary snippet
- Backend CaseResponse serializes verdict fields in API responses
- No `any` types, no mock data in production code path
</success_criteria>

<output>
After completion, create `.planning/phases/08-synthesis-intelligence/08-07-SUMMARY.md`
</output>
