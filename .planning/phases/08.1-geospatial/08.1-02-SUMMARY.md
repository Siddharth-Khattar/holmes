---
phase: 08.1-geospatial
plan: 02
subsystem: agents
tags: [gemini, geospatial, geocoding, google-maps, python, pydantic, sqlalchemy]

# Dependency graph
requires:
  - phase: 08.1-01
    provides: GeocodingService with Google Maps API integration
  - phase: 08-synthesis
    provides: SynthesisAgentRunner pattern for text-only LLM agents
  - phase: 07.1-kg-builder
    provides: DomainAgentRunner base class and LLM agent factory pattern
provides:
  - GeospatialAgentRunner for location extraction and geocoding
  - Geospatial system prompt with citation requirements
  - Pipeline Stage 9 integration (post-synthesis)
  - SSE geospatial-complete event
affects: [08.1-03-locations-api, 08.1-04-frontend-integration, 09-chat]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Text-only LLM agent pattern (follows SynthesisAgentRunner)"
    - "Clear-and-rebuild DB write pattern for agent outputs"
    - "Auto-geocoding in write phase (LLM extracts, service geocodes)"

key-files:
  created:
    - backend/app/schemas/geospatial.py
    - backend/app/agents/prompts/geospatial.py
    - backend/app/agents/geospatial.py
  modified:
    - backend/app/agents/factory.py
    - backend/app/services/agent_events.py
    - backend/app/services/pipeline.py

key-decisions:
  - "Use Flash model (not Pro) for geospatial agent - cost efficiency for location extraction"
  - "Store integer entity IDs directly in source_entity_ids - LLM outputs 1,2,3..., no UUID mapping yet"
  - "Adapt to existing Location schema - use coordinates/temporal_associations JSONB instead of adding columns"
  - "Non-blocking pipeline failure - geospatial failure logs warning, doesn't crash pipeline"
  - "0.0-1.0 confidence scale (not percentages) - consistent with synthesis agent patterns"

patterns-established:
  - "Geospatial prompt pattern: 8 sections (role, instructions, quality requirements, example)"
  - "Citation requirement: EVERY location must have file_id + locator + excerpt"
  - "Input assembly: 6 DB sources (case, synthesis, timeline, entities, findings) formatted as markdown sections"

# Metrics
duration: 6min
completed: 2026-02-09
---

# Phase 08.1 Plan 02: Geospatial Agent Summary

**LLM-based geospatial agent extracts locations from case data with mandatory citations, auto-geocodes via Google Maps, and integrates as non-blocking pipeline Stage 9**

## Performance

- **Duration:** 6 minutes
- **Started:** 2026-02-09T22:46:03Z
- **Completed:** 2026-02-09T22:52:00Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- GeospatialAgentRunner following DomainAgentRunner pattern for text-only LLM agent execution
- Geospatial system prompt with citation requirements and 5-category location type classification
- Pipeline Stage 9 integration after synthesis (non-blocking failure handling)
- Auto-geocoding: LLM extracts location names, GeocodingService geocodes in write phase
- SSE geospatial-complete event emitted after location data committed

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Geospatial schemas and prompt** - `5957696` (feat)
2. **Task 2: Implement GeospatialAgentRunner with pipeline integration** - `60e114c` (feat)

## Files Created/Modified

**Created:**
- `backend/app/schemas/geospatial.py` - GeospatialOutput Pydantic schema with Citation, EventAtLocation, LocationOutput, PathOutput models
- `backend/app/agents/prompts/geospatial.py` - GEOSPATIAL_SYSTEM_PROMPT with 8-section structure (role, instructions, quality requirements, example)
- `backend/app/agents/geospatial.py` - GeospatialAgentRunner subclass, assemble_geospatial_input, write_geospatial_output, run_geospatial

**Modified:**
- `backend/app/agents/factory.py` - Added create_geospatial_agent factory method (Flash model, medium thinking)
- `backend/app/services/agent_events.py` - Added GEOSPATIAL_COMPLETE event type and emit_geospatial_complete helper
- `backend/app/services/pipeline.py` - Added Stage 9 (geospatial) after synthesis with non-blocking failure

## Decisions Made

**1. Use Flash model instead of Pro for geospatial agent**
- Rationale: Location extraction is less complex than synthesis; Flash model provides cost efficiency
- Implementation: AgentFactory.create_geospatial_agent uses MODEL_FLASH with medium thinking

**2. Adapt to existing Location schema instead of adding new columns**
- Rationale: Location model has coordinates (JSONB) and temporal_associations (JSONB) instead of individual lat/lng/temporal_start/temporal_end columns
- Implementation: write_geospatial_output builds JSONB structures from LocationOutput fields

**3. Store integer entity IDs directly without UUID mapping**
- Rationale: LLM outputs 1,2,3... referencing [ENTITY:N:uuid:name] in input; immediate UUID mapping deferred
- Implementation: source_entity_ids stores integer list directly; Phase 8.2 or 9 can resolve to UUIDs

**4. Non-blocking pipeline failure for geospatial agent**
- Rationale: Geospatial analysis optional; failure shouldn't crash entire pipeline
- Implementation: try/except in pipeline Stage 9 logs warning, emits error SSE, continues to file status update

**5. Use 0.0-1.0 confidence scale (not percentages)**
- Rationale: Consistency with synthesis agent patterns; avoids confusion between 0-1 and 0-100 scales
- Implementation: EventAtLocation.confidence field uses 0.0-1.0 range with Pydantic ge/le validators

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation followed SynthesisAgentRunner pattern without complications.

## User Setup Required

None - Google Maps API key already configured in Phase 08.1-01.

## Next Phase Readiness

**Ready for Phase 08.1-03 (Locations API):**
- GeospatialAgentRunner produces location data in locations table
- Clear-and-rebuild pattern established
- SSE geospatial-complete event triggers frontend cache invalidation

**Ready for Phase 08.1-04 (Frontend Integration):**
- Geospatial data persisted in DB with coordinates and temporal associations
- Pipeline Stage 9 runs automatically after synthesis
- Frontend can fetch locations via API (to be built in 08.1-03)

**Blockers/Concerns:**
- None - geospatial agent operational and integrated into pipeline

---
*Phase: 08.1-geospatial*
*Completed: 2026-02-09*
