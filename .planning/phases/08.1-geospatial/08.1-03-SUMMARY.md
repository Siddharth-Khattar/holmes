---
phase: 08.1-geospatial
plan: 03
subsystem: api
tags: [fastapi, geospatial, rest-api, locations, async]

# Dependency graph
requires:
  - phase: 08.1-02
    provides: GeospatialAgentRunner with pipeline integration
provides:
  - 6 REST API endpoints for geospatial data access
  - On-demand geospatial analysis trigger
  - Location listing and detail retrieval
  - Geospatial status checking
affects: [08.1-04, 09]

# Tech tracking
tech-stack:
  added: []
  patterns: [async-task-spawning, sse-event-emission, annotated-query-params]

key-files:
  created:
    - backend/app/api/locations.py
  modified:
    - backend/app/main.py

key-decisions:
  - "Async task spawning with asyncio.create_task for non-blocking generation"
  - "Adapted API response structure to match actual Location schema (coordinates JSONB, temporal_associations JSONB)"
  - "Empty file_id for emit_agent_started since geospatial doesn't process individual files"

patterns-established:
  - "Annotated Query parameter pattern: Annotated[type, Query(description=...)] = default"
  - "Event extraction from temporal_associations JSONB in detail endpoint"

# Metrics
duration: 7min
completed: 2026-02-09
---

# Phase 08.1 Plan 03: Locations API Summary

**6 REST endpoints for geospatial intelligence with async task spawning and SSE event emission**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-09T03:35:41Z
- **Completed:** 2026-02-09T03:42:46Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- 6 REST API endpoints for geospatial data generation and retrieval
- Non-blocking geospatial analysis via asyncio.create_task
- Auth enforcement via CurrentUser dependency and case ownership checks
- Adapted to actual Location schema with JSONB fields

## Task Commits

Each task was committed atomically:

1. **Task 1: Create locations API endpoints** - `c82f544` (feat)
2. **Task 2: Register locations router in main.py** - `41feec7` (feat)

## Files Created/Modified
- `backend/app/api/locations.py` - 6 geospatial endpoints with auth and SSE integration
- `backend/app/main.py` - Registered locations router

## API Endpoints Implemented

### POST /api/cases/{case_id}/geospatial/generate
- Trigger on-demand geospatial analysis
- Returns 202 Accepted immediately
- Spawns async task with asyncio.create_task
- Emits agent-started and geospatial-complete SSE events
- Optional force parameter to regenerate existing analysis

### GET /api/cases/{case_id}/geospatial/status
- Check if geospatial analysis exists
- Returns location count and last generation timestamp
- Status: not_started or complete

### GET /api/cases/{case_id}/locations
- List all locations for map visualization
- Optional location_type filter (crime_scene, witness_location, etc.)
- Returns minimal data: id, name, coordinates, type, event_count
- Ordered by location name

### GET /api/cases/{case_id}/locations/{location_id}
- Detailed location data with full temporal information
- Extracts events from temporal_associations JSONB
- Extracts temporal period (start/end) from temporal_associations
- Returns source entity IDs

### GET /api/cases/{case_id}/paths
- Movement paths for visualization
- Returns empty array for v1 (paths not persisted to DB yet)
- Placeholder for Phase 8.2 enhancement

### DELETE /api/cases/{case_id}/geospatial
- Clear all geospatial data for a case
- Returns count of deleted locations
- Enables regeneration workflow

## Decisions Made

**1. Async task spawning pattern**
- Used asyncio.create_task for non-blocking generation
- Follows synthesis.py pattern from Phase 8
- Allows immediate 202 response while work continues in background

**2. Schema adaptation**
- Plan expected separate latitude, longitude, events, citations columns
- Actual Location model uses coordinates JSONB dict {lat, lng}
- Events stored in temporal_associations JSONB list
- Citations not persisted in v1 (only in GeospatialOutput, not written to DB)
- Adapted endpoints to extract and transform JSONB data for response

**3. Empty file_id for SSE events**
- Geospatial agent doesn't process individual files
- Used file_id="" and file_name="geospatial-analysis"
- Follows synthesis agent pattern from pipeline.py

**4. Annotated Query parameter pattern**
- Modern FastAPI pattern: Annotated[type, Query(description=...)] = default
- Avoids "non-default after default" Python syntax errors
- Consistent with synthesis.py reference implementation

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed parameter annotation pattern**
- **Found during:** Task 1 verification
- **Issue:** Old FastAPI pattern `param: type = Query(...)` caused syntax error when mixed with dependency injection
- **Fix:** Updated to Annotated pattern: `param: Annotated[type, Query(...)] = default`
- **Files modified:** app/api/locations.py
- **Verification:** Import succeeds, pyright passes with 0 errors
- **Committed in:** c82f544 (Task 1 commit)

**2. [Rule 2 - Missing Critical] Adapted response structure to actual schema**
- **Found during:** Task 1 implementation
- **Issue:** Plan expected separate latitude/longitude/events/citations columns, but Location model uses JSONB fields (coordinates, temporal_associations)
- **Fix:** Extracted coordinates from JSONB dict, parsed temporal_associations to extract events and periods
- **Files modified:** app/api/locations.py
- **Verification:** Response structure matches actual DB schema, detail endpoint successfully extracts nested data
- **Committed in:** c82f544 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (1 bug, 1 missing critical)
**Impact on plan:** Both fixes necessary for correctness. Response structure deviation required to match actual DB schema implemented in Plan 01.

## Issues Encountered

None - plan executed smoothly with schema adaptation.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Phase 08.1 Plan 04:**
- Backend API complete with 6 endpoints
- All routes registered and accessible
- Auth + case ownership enforcement in place
- SSE events for real-time updates

**Frontend Integration (Plan 04) can now:**
- Trigger geospatial analysis via POST /generate
- Check status via GET /status
- Fetch locations for map visualization via GET /locations
- Get detailed location data via GET /locations/{id}
- Subscribe to SSE for geospatial-complete events

**Blockers:** None

---
*Phase: 08.1-geospatial*
*Completed: 2026-02-09*
