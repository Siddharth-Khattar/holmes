---
phase: 08.1-geospatial
plan: 04
subsystem: ui
tags: [react, typescript, react-query, api-client, geospatial, maps]

# Dependency graph
requires:
  - phase: 08.1-03
    provides: Backend geospatial API endpoints (status, generate, locations, delete)
provides:
  - Frontend geospatial data management with useGeospatialData hook
  - Trigger UI with status banner (not_started, generating, complete)
  - Real-time polling during generation (3-second intervals)
  - Button and Alert reusable UI components
affects: [Phase 10 (Source Panel - may need geospatial citations)]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Polling pattern for async operations (3-second intervals until complete)
    - Confirmation button pattern (click twice to execute destructive action)
    - Status banner state machine (not_started → generating → complete)

key-files:
  created:
    - frontend/src/lib/api/geospatial.ts
    - frontend/src/hooks/useGeospatialData.ts
    - frontend/src/components/ui/button.tsx
    - frontend/src/components/ui/alert.tsx
  modified:
    - frontend/src/app/(app)/cases/[id]/geospatial/page.tsx

key-decisions:
  - "Use 3-second polling interval for generation status (balance between responsiveness and API load)"
  - "Refresh button requires confirmation to prevent accidental regeneration"
  - "Create reusable Button and Alert components (needed for geospatial page, will benefit other pages)"

patterns-established:
  - "API client pattern: Use shared api client from api-client.ts for JWT auth consistency"
  - "Hook transformation pattern: Transform API response types to frontend types in hook layer"
  - "Polling cleanup: Store interval ID and clear on status change or component unmount"

# Metrics
duration: 12min
completed: 2026-02-09
---

# Phase 8.1 Plan 04: Geospatial Frontend Integration Summary

**On-demand geospatial intelligence generation with real-time status tracking and polling-based completion detection**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-09T04:42:00Z
- **Completed:** 2026-02-09T04:54:00Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Real API integration replacing mock data on geospatial page
- Status-driven UI with 3-state banner (not_started, generating, complete)
- On-demand generation trigger with polling for completion
- Reusable Button and Alert components created for Holmes UI library

## Task Commits

Each task was committed atomically:

1. **Task 1: Create geospatial API client and hook** - `94163e0` (feat)
2. **Task 2: Update geospatial page with trigger UI and real data** - `42810bd` (feat)

## Files Created/Modified

**Created:**
- `frontend/src/lib/api/geospatial.ts` - API client with 5 functions (status, generate, locations, detail, delete)
- `frontend/src/hooks/useGeospatialData.ts` - React hook with status tracking, polling, and data transformation
- `frontend/src/components/ui/button.tsx` - Reusable button component (3 variants, 3 sizes)
- `frontend/src/components/ui/alert.tsx` - Reusable alert component with AlertDescription subcomponent

**Modified:**
- `frontend/src/app/(app)/cases/[id]/geospatial/page.tsx` - Replaced mock data with real API integration, added trigger UI

## Technical Implementation

### API Client (`geospatial.ts`)

5 API functions following synthesis.ts pattern:

1. `fetchGeospatialStatus(caseId)` - Check if data exists, status, count
2. `generateGeospatialIntelligence(caseId, force)` - Trigger generation (202 Accepted)
3. `fetchLocations(caseId, typeFilter?)` - Get all locations with optional filter
4. `fetchLocationDetail(caseId, locationId)` - Get single location with events/citations
5. `deleteGeospatialData(caseId)` - Delete all geospatial data for case

All use shared `api` client from `api-client.ts` for JWT authentication.

### Data Hook (`useGeospatialData.ts`)

State management with 6 returned values:

- `status` - GeospatialStatus object (exists, status, count, last_generated)
- `locations` - Transformed Landmark[] for map display
- `loading` - Initial data fetch state
- `generating` - Generation in progress state
- `error` - Error message string
- `generate(force)` - Trigger generation, start polling
- `refresh()` - Delete + regenerate
- `refetch()` - Manual refetch

**Key logic:**

- `transformLocation()` - Converts API `LocationResponse` to frontend `Landmark` type
- Polling: 3-second interval, clears when status becomes "complete"
- Refresh: DELETE request followed by POST generation with force=true

### Status Banner State Machine

3 states with distinct UI:

1. **not_started**: Generate button, explanation text
2. **generating**: Spinner, "Analyzing locations..." message, can leave page
3. **complete**: Green checkmark, location count, last updated time, Refresh button

Refresh button uses confirmation pattern (click twice to execute).

### UI Components

**Button component:**
- Variants: default (primary-600), outline (transparent + border), destructive (red-600)
- Sizes: sm (h-8), default (h-10), lg (h-12)
- Supports disabled state with opacity-50

**Alert component:**
- Variants: default (neutral-900), destructive (red-950)
- AlertDescription subcomponent for message content
- forwardRef pattern for ref forwarding

## Decisions Made

1. **3-second polling interval**: Balance between responsiveness (user sees updates quickly) and API load (not hammering backend). Can be adjusted if needed.

2. **Confirmation for Refresh**: First click shows "Confirm Refresh?", second click executes. Prevents accidental deletion + regeneration of expensive geospatial analysis.

3. **Created Button/Alert components**: Geospatial page needed these for trigger UI. Rather than inline styles or one-off components, created reusable UI library components. These will benefit other pages (already seeing need in Command Center for action buttons).

4. **Transform API types in hook**: API returns `LocationResponse`, frontend map needs `Landmark`. Transformation happens in `useGeospatialData` hook, not in component. Keeps page.tsx clean and logic reusable.

5. **Empty state for unmappable locations**: When coordinates are null, fallback to `{lat: 0, lng: 0}` rather than filtering out. Preserves location in data but doesn't crash map. User can see "unmappable location" in UI.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Created Button and Alert components**
- **Found during:** Task 2 (Update geospatial page)
- **Issue:** Plan specified using `@/components/ui/button` and `@/components/ui/alert` but these components didn't exist in the codebase
- **Fix:** Created Button component with 3 variants (default, outline, destructive) and 3 sizes (sm, default, lg). Created Alert component with 2 variants (default, destructive) and AlertDescription subcomponent. Both use forwardRef pattern for proper ref handling.
- **Files created:** `frontend/src/components/ui/button.tsx`, `frontend/src/components/ui/alert.tsx`
- **Verification:** TypeScript compilation passes, build succeeds, components render correctly
- **Committed in:** `42810bd` (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Auto-fix was necessary to complete the plan as specified. The plan referenced UI components that didn't exist. Creating them as reusable components benefits the entire codebase, not just geospatial page. No scope creep.

## Issues Encountered

None - plan executed smoothly after creating required UI components.

## User Setup Required

None - no external service configuration required. Google Maps API key already configured in frontend/.env.

## Next Phase Readiness

**Ready for:**
- Phase 9 (Chat Interface): Geospatial query tools can be added to chat agent
- Phase 10 (Source Panel): Geospatial citations can be wired to source viewer

**Complete stack:**
- Backend: GeospatialAgentRunner + GeocodingService + 6 REST API endpoints (Plans 01-03)
- Frontend: API client + data hook + trigger UI + status tracking (Plan 04)

**User flow:**
1. User navigates to Geospatial tab
2. Sees "not yet generated" banner with Generate button
3. Clicks Generate → status changes to "generating" → 3-second polling starts
4. Agent runs, extracts locations, geocodes addresses → status becomes "complete"
5. Map displays locations with events
6. User can click Refresh to regenerate (requires confirmation)

**Known limitations:**
- Paths not exposed in v1 (backend writes to temporal_associations but frontend doesn't render paths yet)
- Event details loaded on demand (detail endpoint exists but not wired to map popups)
- No SSE streaming (polling-based, works but not real-time like Command Center)

---
*Phase: 08.1-geospatial*
*Completed: 2026-02-09*
