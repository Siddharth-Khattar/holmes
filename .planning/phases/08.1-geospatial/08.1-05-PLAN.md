---
phase: 08.1-geospatial
plan: 05
type: execute
wave: 5
depends_on: ["08.1-04"]
files_modified:
  - frontend/src/components/Geospatial/GeospatialMap.tsx
autonomous: true

must_haves:
  truths:
    - "Location detail panel shows event list with timestamps"
    - "Location detail panel shows citations with excerpts"
    - "Location detail panel shows temporal analysis (date range)"
    - "Location detail panel shows related entities with type badges"
  artifacts:
    - path: "frontend/src/components/Geospatial/GeospatialMap.tsx"
      provides: "Enhanced location detail panel with citations, temporal analysis, and entities"
      contains: "Citations Section"
      contains: "Temporal Analysis Section"
      contains: "Related Entities Section"
  key_links:
    - from: "GeospatialMap detail panel"
      to: "fetchLocationDetail API"
      via: "onMarkerClick handler"
      pattern: "fetchLocationDetail\\("
    - from: "Citations section"
      to: "citation data from API"
      via: "map over citations array"
      pattern: "citations\\.map"
    - from: "Related Entities section"
      to: "entity badges"
      via: "EntityBadge component"
      pattern: "EntityBadge"
---

<objective>
Enhance GeospatialMap location detail panel to display citations, temporal analysis, and related entities from real API data.

Purpose: Provide full evidence context for each location with source citations, temporal relevance, and entity connections.
Output: Enhanced detail panel with 4 sections (Events, Citations, Temporal Analysis, Related Entities).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-geospatial/CONTEXT.md
@.planning/phases/08.1-geospatial/REQUIREMENTS.md

# Current component
@frontend/src/components/Geospatial/GeospatialMap.tsx

# API client
@frontend/src/lib/api/geospatial.ts

# Entity badge reference (from KG)
@frontend/src/lib/knowledge-graph-config.ts
@frontend/src/components/knowledge-graph/KnowledgeGraphEntityPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance GeospatialMap with detailed location panel</name>
  <files>frontend/src/components/Geospatial/GeospatialMap.tsx</files>
  <action>
Update `GeospatialMap.tsx` to fetch location details when marker clicked and display enhanced panel:

**Key Changes:**

1. **Add fetchLocationDetail import and state:**
```typescript
import { fetchLocationDetail, type LocationDetailResponse } from "@/lib/api/geospatial";

// Inside component
const [selectedLocationDetail, setSelectedLocationDetail] =
  useState<LocationDetailResponse | null>(null);
const [loadingDetail, setLoadingDetail] = useState(false);
```

2. **Update marker click handler to fetch detail:**
```typescript
const handleMarkerClick = async (landmark: Landmark) => {
  setSelectedLandmark(landmark);
  setIsDetailOpen(true);

  // Fetch full location detail
  try {
    setLoadingDetail(true);
    const detail = await fetchLocationDetail(caseId, landmark.id);
    setSelectedLocationDetail(detail);
  } catch (error) {
    console.error("Failed to fetch location detail:", error);
  } finally {
    setLoadingDetail(false);
  }
};
```

3. **Enhance detail panel content:**

Inside the existing detail panel Dialog, add 4 sections AFTER the existing content:

```tsx
{/* Existing: Location name, type, coordinates, Street View button */}

{/* Section 1: Events at this Location (already exists, but update to use real data) */}
<div className="mt-6">
  <h4 className="mb-3 flex items-center text-sm font-semibold text-neutral-200">
    <Calendar className="mr-2 h-4 w-4" />
    Events at this Location ({selectedLocationDetail?.events.length || 0})
  </h4>
  {loadingDetail ? (
    <p className="text-xs text-neutral-400">Loading events...</p>
  ) : selectedLocationDetail && selectedLocationDetail.events.length > 0 ? (
    <div className="space-y-2">
      {selectedLocationDetail.events.map((event, idx) => (
        <div
          key={idx}
          className="rounded-lg border border-neutral-800 bg-neutral-900/50 p-3"
        >
          <p className="text-sm font-medium text-neutral-200">
            {event.event_title}
          </p>
          <p className="mt-1 text-xs text-neutral-400">
            {event.event_description}
          </p>
          <div className="mt-2 flex items-center gap-4 text-xs text-neutral-500">
            <span>{new Date(event.timestamp).toLocaleString()}</span>
            <span className="capitalize">Layer: {event.layer}</span>
            <span>Confidence: {(event.confidence * 100).toFixed(0)}%</span>
          </div>
        </div>
      ))}
    </div>
  ) : (
    <p className="text-xs text-neutral-500">No events at this location</p>
  )}
</div>

{/* Section 2: Citations (NEW) */}
<div className="mt-6">
  <h4 className="mb-3 flex items-center text-sm font-semibold text-neutral-200">
    <FileText className="mr-2 h-4 w-4" />
    Citations ({selectedLocationDetail?.citations.length || 0})
  </h4>
  {loadingDetail ? (
    <p className="text-xs text-neutral-400">Loading citations...</p>
  ) : selectedLocationDetail && selectedLocationDetail.citations.length > 0 ? (
    <div className="space-y-3">
      {selectedLocationDetail.citations.map((citation, idx) => (
        <div
          key={idx}
          className="rounded-lg border border-neutral-800 bg-neutral-900/50 p-3"
        >
          <div className="flex items-start justify-between">
            <div className="flex-1">
              <p className="text-xs font-medium text-neutral-300">
                {citation.file_name || "Source Document"}
              </p>
              <p className="mt-1 text-xs text-neutral-500">{citation.locator}</p>
            </div>
            <button
              onClick={() => onViewSource?.(citation.file_id, citation.locator)}
              className="text-xs text-primary-400 hover:text-primary-300"
            >
              View
            </button>
          </div>
          <div className="mt-2 rounded bg-neutral-950/50 p-2">
            <p className="text-xs italic text-neutral-400">
              "{citation.excerpt}"
            </p>
          </div>
        </div>
      ))}
    </div>
  ) : (
    <p className="text-xs text-neutral-500">No citations available</p>
  )}
</div>

{/* Section 3: Temporal Analysis (NEW) */}
<div className="mt-6">
  <h4 className="mb-3 flex items-center text-sm font-semibold text-neutral-200">
    <Clock className="mr-2 h-4 w-4" />
    Temporal Analysis
  </h4>
  {loadingDetail ? (
    <p className="text-xs text-neutral-400">Loading temporal data...</p>
  ) : selectedLocationDetail?.temporal_associations ? (
    <div className="rounded-lg border border-neutral-800 bg-neutral-900/50 p-3">
      <p className="text-xs text-neutral-400">Location was relevant during:</p>
      <p className="mt-1 text-sm font-medium text-neutral-200">
        {selectedLocationDetail.temporal_associations.start
          ? new Date(
              selectedLocationDetail.temporal_associations.start
            ).toLocaleDateString()
          : "Unknown start"}
        {" → "}
        {selectedLocationDetail.temporal_associations.end
          ? new Date(
              selectedLocationDetail.temporal_associations.end
            ).toLocaleDateString()
          : "Unknown end"}
      </p>
    </div>
  ) : (
    <p className="text-xs text-neutral-500">No temporal data available</p>
  )}
</div>

{/* Section 4: Related Entities (NEW) */}
<div className="mt-6">
  <h4 className="mb-3 flex items-center text-sm font-semibold text-neutral-200">
    <Link2 className="mr-2 h-4 w-4" />
    Related Entities ({selectedLocationDetail?.source_entity_ids.length || 0})
  </h4>
  {loadingDetail ? (
    <p className="text-xs text-neutral-400">Loading entities...</p>
  ) : selectedLocationDetail &&
    selectedLocationDetail.source_entity_ids.length > 0 ? (
    <div className="space-y-2">
      {selectedLocationDetail.source_entity_ids.map((entityId) => (
        <div
          key={entityId}
          className="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900/50 p-2"
        >
          <div className="h-2 w-2 rounded-full bg-primary-500" />
          <p className="text-xs text-neutral-300">{entityId}</p>
          {/* Phase 10: Add click handler to navigate to KG filtered by entity */}
        </div>
      ))}
      <p className="mt-2 text-xs text-neutral-500">
        Click entity to view in Knowledge Graph (Phase 10)
      </p>
    </div>
  ) : (
    <p className="text-xs text-neutral-500">No related entities</p>
  )}
</div>
```

4. **Add missing icon imports:**
```typescript
import { Calendar, FileText, Clock, Link2 } from "lucide-react";
```

5. **Pass caseId prop to GeospatialMap:**

The component needs caseId to call fetchLocationDetail. Update component signature:
```typescript
interface GeospatialMapProps {
  caseId: string; // ADD THIS
  landmarks: Landmark[];
  paths?: GeospatialPath[];
  onViewSource?: (fileId: string, locator: string) => void;
}
```

Update page.tsx to pass caseId:
```tsx
<GeospatialMap
  caseId={caseId}
  landmarks={locations}
  paths={[]}
  onViewSource={(fileId, locator) => {
    console.log("View source:", fileId, locator);
  }}
/>
```

**Key Implementation Details:**
- Fetch location detail on marker click (async)
- Show loading state while fetching detail
- Citations section: display file name, locator, excerpt with "View" button
- Temporal analysis: show date range in readable format
- Related entities: show entity IDs (entity names not available until we resolve IDs to entities)
- onViewSource prop already exists for Phase 10 integration
- No changes to map rendering or existing functionality

**Why this approach:**
- Minimal changes to existing component (add sections, don't refactor)
- Lazy load details only when needed (don't fetch all details upfront)
- Graceful degradation if detail fetch fails
- Prepare for Phase 10 (Source Panel) by including View buttons
  </action>
  <verify>
Run `cd frontend && bun run typecheck` to verify TypeScript compilation.

Check for missing imports:
```bash
cd frontend
bun run build 2>&1 | grep -i "GeospatialMap" || echo "✓ No GeospatialMap build errors"
```
  </verify>
  <done>GeospatialMap enhanced with 4-section detail panel (Events, Citations, Temporal Analysis, Related Entities). fetchLocationDetail integrated. Loading states added.</done>
</task>

</tasks>

<verification>
**Type Check:**
```bash
cd frontend
bun run typecheck
```

**Build Check:**
```bash
cd frontend
bun run build
```

**Component Verification:**
```bash
cd frontend
grep -A 5 "Citations Section" src/components/Geospatial/GeospatialMap.tsx | head -10
grep -A 5 "Temporal Analysis" src/components/Geospatial/GeospatialMap.tsx | head -10
grep -A 5 "Related Entities" src/components/Geospatial/GeospatialMap.tsx | head -10
```

All checks must pass.
</verification>

<success_criteria>
- GeospatialMap component updated with fetchLocationDetail integration
- Location detail panel includes 4 sections:
  1. Events at this Location (enhanced with real data)
  2. Citations (NEW: file name, locator, excerpt, View button)
  3. Temporal Analysis (NEW: date range)
  4. Related Entities (NEW: entity ID list)
- Loading state shows while fetching detail
- Citations clickable with onViewSource callback (Phase 10 integration point)
- Related entities displayed (entity names deferred to Phase 10)
- TypeScript compiles without errors
- Component builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-geospatial/08.1-05-SUMMARY.md` with:
- Detail panel enhancement details
- 4-section breakdown (Events, Citations, Temporal, Entities)
- fetchLocationDetail integration approach
- Phase 10 preparation (View buttons, entity navigation placeholders)
- Example screenshots or UI description
</output>
