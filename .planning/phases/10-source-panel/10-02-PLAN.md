---
phase: 10-source-panel
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - frontend/src/components/knowledge-graph/KnowledgeGraphEntityPanel.tsx
  - frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx
  - frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx
  - frontend/src/components/Geospatial/GeospatialMap.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a source finding ID in KG entity panel opens SourceViewerModal with the correct document at the cited page/timestamp"
    - "EntityTimelineEntry shows a clickable 'View source' link instead of 'Source not yet available'"
    - "Clicking 'View' on a geospatial citation opens SourceViewerModal with the correct file"
    - "Geospatial Related Entities section shows entity names and type badges instead of raw UUID strings"
  artifacts:
    - path: "frontend/src/components/knowledge-graph/KnowledgeGraphEntityPanel.tsx"
      provides: "Source Documents section with clickable CitationLinks"
    - path: "frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx"
      provides: "Clickable source link resolving relationship source_finding_ids"
    - path: "frontend/src/components/Geospatial/GeospatialMap.tsx"
      provides: "Citations open SourceViewerModal; entity IDs resolved to names with EntityBadge"
  key_links:
    - from: "KnowledgeGraphEntityPanel.tsx"
      to: "useSourceNavigation"
      via: "openFromFinding(findingId) for source_finding_ids"
      pattern: "openFromFinding"
    - from: "EntityTimelineEntry.tsx"
      to: "useSourceNavigation"
      via: "onViewSource callback prop from parent"
      pattern: "onViewSource"
    - from: "GeospatialMap.tsx"
      to: "useSourceNavigation"
      via: "openSource(citation) for location citations"
      pattern: "openSource"
    - from: "GeospatialMap.tsx"
      to: "useEntityResolver"
      via: "resolveEntities(source_entity_ids)"
      pattern: "useEntityResolver|resolveEntities"
---

<objective>
Wire source navigation and entity resolution into the Knowledge Graph and Geospatial views. Replace all "source not yet available" placeholders and raw UUID displays with functional clickable citations and resolved entity names.

Purpose: KG entity panel shows truncated finding UUIDs, EntityTimelineEntry says "Source not yet available", and Geospatial shows raw entity UUID strings. This plan makes all of these functional.

Output: 4 modified files with working citation click-to-source and entity name resolution
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-source-panel/10-CONTEXT.md
@.planning/phases/10-source-panel/10-RESEARCH.md
@.planning/phases/10-source-panel/10-01-SUMMARY.md
@frontend/src/components/knowledge-graph/KnowledgeGraphEntityPanel.tsx
@frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx
@frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx
@frontend/src/components/Geospatial/GeospatialMap.tsx
@frontend/src/hooks/useSourceNavigation.ts
@frontend/src/hooks/useEntityResolver.ts
@frontend/src/components/ui/citation-link.tsx
@frontend/src/components/ui/entity-badge.tsx
@frontend/src/lib/api/geospatial.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire KG Entity Panel and EntityTimelineEntry to source navigation</name>
  <files>
    frontend/src/components/knowledge-graph/KnowledgeGraphEntityPanel.tsx
    frontend/src/components/knowledge-graph/EntityTimelineEntry.tsx
    frontend/src/components/knowledge-graph/KnowledgeGraphCanvas.tsx
  </files>
  <action>
**KnowledgeGraphEntityPanel.tsx -- Source Documents section:**

The panel currently shows `sourceIds` (finding UUIDs) as truncated `id.slice(0, 8)` text in the "Source Documents" CollapsibleSection. Replace these with clickable items that trigger the source viewer.

1. Add an `onViewFinding?: (findingId: string) => void` prop to `KnowledgeGraphEntityPanelProps`.

2. In the "Source Documents" CollapsibleSection, replace the current static `<div>` items with clickable buttons. For each source finding ID:
   - Render a button with FileText icon, "Source Finding" label, truncated ID, and a "View Source" action text
   - On click, call `onViewFinding?.(id)`
   - Style: same bg-charcoal/50 border-stone/10 rounded-lg but add `cursor-pointer hover:bg-charcoal/70 transition-colors` when onViewFinding is provided
   - Keep the existing styling (entity-colored FileText icon, "Source Finding" label, truncated ID) but make the whole row a clickable button

**EntityTimelineEntry.tsx -- "View source" link:**

Currently shows "Source not yet available" with cursor-not-allowed in the expanded content. Replace with a functional source link.

1. Add an `onViewSource?: (findingIds: string[]) => void` prop to `EntityTimelineEntryProps`.

2. Replace the static "Source not yet available" span in the expanded content (the `mt-2 pt-2 border-t` section):
   - If `relationship.source_finding_ids` exists and has entries AND `onViewSource` is provided:
     - Render a clickable button: FileSearch icon + "View source evidence" text
     - Style: `text-xs text-stone hover:text-smoke cursor-pointer transition-colors inline-flex items-center gap-1.5`
     - On click: `onViewSource(relationship.source_finding_ids)`
   - If source_finding_ids is empty/null or onViewSource not provided:
     - Keep the existing "Source not yet available" graceful degradation text

**KnowledgeGraphEntityPanel.tsx -- pass onViewSource through to EntityTimelineEntry:**

In the `filteredRelationships.map()` where `<EntityTimelineEntry>` is rendered, pass the `onViewFinding` callback. But EntityTimelineEntry receives `onViewSource` (plural finding IDs), so the parent (KnowledgeGraphEntityPanel) should receive `onViewFinding` and forward it:
   - Pass to EntityTimelineEntry: `onViewSource={(findingIds) => { if (findingIds.length > 0) onViewFinding?.(findingIds[0]); }}`

**KnowledgeGraphCanvas.tsx -- wire useSourceNavigation and pass callbacks:**

1. Import `useSourceNavigation` from `@/hooks/useSourceNavigation`. Get the case ID from the URL params (use `useParams` from `next/navigation`).

2. Call `const { openFromFinding, sourceContent: navSourceContent, isLoading: navLoading, closeSource: navCloseSource } = useSourceNavigation(caseId)`.

3. In the `handleEntitySelect` callback (or wherever the detail sidebar content is set for KG entity), pass `onViewFinding={openFromFinding}` to `KnowledgeGraphEntityPanel` via the sidebar descriptor.

   Since KnowledgeGraphEntityPanel is rendered through the DetailSidebar system (via `KnowledgeGraphEntityContent` descriptor), we need to pass the callback. Two approaches:

   **Approach (preferred):** Add `onViewFinding?: (findingId: string) => void` to `KnowledgeGraphEntityContent.props` in `detail-sidebar.ts`. Then:
   - In KnowledgeGraphCanvas, when calling `setContent({ type: "knowledge-graph-entity", props: { ..., onViewFinding: openFromFinding } })`, pass the callback
   - In `detail-sidebar.tsx` where `KnowledgeGraphEntityPanel` is rendered for the `knowledge-graph-entity` case, spread the `onViewFinding` prop through

4. Merge the nav source content with the existing KG source viewer state. If `navSourceContent` is set, it takes priority over the existing `sourceViewerContent` state. Use a combined approach:
   - The existing `sourceViewerContent` state remains for KG-internal source viewing (if any)
   - Add the SourceViewerModal also responds to `navSourceContent`: pass `content={navSourceContent ?? sourceViewerContent}` and `onClose` calls both `navCloseSource` and `setSourceViewerContent(null)`

Update `frontend/src/types/detail-sidebar.ts` to add `onViewFinding` to `KnowledgeGraphEntityContent.props`:
```
onViewFinding?: (findingId: string) => void;
```

Update `frontend/src/components/app/detail-sidebar.tsx` to pass `onViewFinding` through to `KnowledgeGraphEntityPanel` in the `knowledge-graph-entity` case.
  </action>
  <verify>
    Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero type errors. Then `bun run build` for full verification.
  </verify>
  <done>
    - KG entity panel source documents are clickable buttons that trigger openFromFinding
    - EntityTimelineEntry shows "View source evidence" link when source_finding_ids exist
    - KnowledgeGraphCanvas wires useSourceNavigation and passes callbacks through sidebar descriptor
    - SourceViewerModal opens with correct file content when clicking source references
    - Graceful degradation preserved when no sources available
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Geospatial detail panel with source navigation and entity resolution</name>
  <files>
    frontend/src/components/Geospatial/GeospatialMap.tsx
  </files>
  <action>
**GeospatialMap.tsx -- Citations section:**

The detail dialog currently has a "View" button that calls `onViewSource(citation.file_id, citation.locator)` but this callback is not connected to SourceViewerModal. Replace the `onViewSource` prop pattern with the `useSourceNavigation` hook.

1. Import `useSourceNavigation` from `@/hooks/useSourceNavigation`.
2. Call `const { openSource, sourceContent: geoSourceContent, closeSource: geoCloseSource, isLoading: sourceLoading } = useSourceNavigation(caseId)`.
3. Remove the `onViewSource` prop from `GeospatialMapProps` (it is no longer needed since the component manages its own source navigation internally).
4. In the Citations section, replace the `onViewSource && <button>` pattern:
   - The "View" button should call `openSource({ file_id: citation.file_id, locator: citation.locator, excerpt: citation.excerpt })`
   - Show "Opening..." text when sourceLoading is true
   - Always show the View button (no conditional on onViewSource prop)
5. Import and render `SourceViewerModal` inside the component (portaled alongside the detail dialog, or as a sibling). Render it when `geoSourceContent` is not null:
   ```
   {geoSourceContent && createPortal(
     <div className="fixed inset-0 z-[60] flex items-center justify-center p-4" style={{ backgroundColor: "rgba(0,0,0,0.7)" }}>
       <div className="w-full max-w-5xl h-[85vh]">
         <SourceViewerModal content={geoSourceContent} onClose={geoCloseSource} />
       </div>
     </div>,
     document.body
   )}
   ```
   Use z-[60] to layer above the detail dialog (z-50).

**GeospatialMap.tsx -- Related Entities section:**

Currently shows raw entity IDs. Replace with resolved entity names and type badges.

1. Import `useEntityResolver` from `@/hooks/useEntityResolver` and `EntityBadge` from `@/components/ui/entity-badge`.
2. Call `const { resolveEntities, isLoading: entitiesLoading } = useEntityResolver(caseId)`.
3. In the Related Entities section, replace the current `source_entity_ids.map(entityId => ...)` rendering:
   - Call `resolveEntities(selectedLocationDetail.source_entity_ids)` to get resolved entities
   - Render each resolved entity using `<EntityBadge name={entity.name} entityType={entity.entity_type} color={entity.color} />`
   - If entitiesLoading, show "Resolving entities..." text
   - Remove the "Click entity to view in Knowledge Graph (Phase 10)" placeholder text
   - Remove the raw `{entityId}` display

4. Also update the "Source Document" display in the Citations section: resolve the `citation.file_id` to show the actual file name. Import `useQuery` and `listFiles`:
   - Use the same React Query cache as useSourceNavigation: `useQuery({ queryKey: ["case-files", caseId], queryFn: () => listFiles(caseId, 1, 200), staleTime: 5 * 60 * 1000 })`
   - Look up `citation.file_id` in the file list to get `original_filename`
   - Replace "Source Document" text with the actual file name

5. Clean up: Remove the `eslint-disable @typescript-eslint/no-explicit-any` at the top if possible. If the google maps `any` casts are still needed, keep it but add a specific comment explaining why.

6. Update the parent component (geospatial page) that renders `<GeospatialMap>` to remove the `onViewSource` prop if it was being passed. Search for GeospatialMap usage and remove the prop.
  </action>
  <verify>
    Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero type errors. Then `bun run build`.
  </verify>
  <done>
    - Geospatial "View" button on citations opens SourceViewerModal with correct file at correct location
    - SourceViewerModal renders in a portal above the detail dialog (z-[60])
    - Related Entities shows resolved entity names + type badges via EntityBadge
    - Citation file names resolved from file metadata cache
    - onViewSource prop removed from GeospatialMapProps (self-contained navigation)
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero errors
2. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run build` -- builds successfully
3. KG entity panel: Source Documents section has clickable entries
4. EntityTimelineEntry: "View source evidence" replaces "Source not yet available"
5. Geospatial: View button opens SourceViewerModal, entity IDs show as names with badges
</verification>

<success_criteria>
- KG entity panel source finding IDs are clickable, triggering openFromFinding -> two-hop resolution -> SourceViewerModal
- EntityTimelineEntry "Source not yet available" replaced with functional "View source evidence" link
- Geospatial citations open SourceViewerModal at correct page/timestamp
- Geospatial Related Entities shows "John Smith (Person)" style badges instead of UUID strings
- All type checking and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-source-panel/10-02-SUMMARY.md`
</output>
