---
phase: 10-source-panel
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - frontend/src/components/verdict/HypothesisDetailPanel.tsx
  - frontend/src/components/verdict/ContradictionDetailPanel.tsx
  - frontend/src/components/verdict/GapDetailPanel.tsx
  - frontend/src/components/Timeline/TimelineEventCard.tsx
  - frontend/src/types/detail-sidebar.ts
  - frontend/src/components/app/detail-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking an evidence item in the hypothesis detail panel opens SourceViewerModal with the cited source file"
    - "Clicking a source excerpt in the contradiction detail panel opens SourceViewerModal"
    - "Gap entity badges use getEntityColor for consistent color coding"
    - "Timeline event card source count is clickable and shows citation details"
  artifacts:
    - path: "frontend/src/components/verdict/HypothesisDetailPanel.tsx"
      provides: "EvidenceRow with clickable finding_id -> source navigation"
    - path: "frontend/src/components/verdict/ContradictionDetailPanel.tsx"
      provides: "SourceExcerpt with clickable finding_id -> source navigation"
    - path: "frontend/src/components/verdict/GapDetailPanel.tsx"
      provides: "Entity badges using getEntityColor for consistent styling"
    - path: "frontend/src/components/Timeline/TimelineEventCard.tsx"
      provides: "Source count with citation detail expansion"
  key_links:
    - from: "HypothesisDetailPanel.tsx"
      to: "useSourceNavigation"
      via: "onViewFinding callback prop from sidebar descriptor"
      pattern: "onViewFinding"
    - from: "ContradictionDetailPanel.tsx"
      to: "useSourceNavigation"
      via: "onViewFinding callback prop from sidebar descriptor"
      pattern: "onViewFinding"
    - from: "TimelineEventCard.tsx"
      to: "useSourceNavigation"
      via: "onViewSource callback prop from parent"
      pattern: "onViewSource"
---

<objective>
Wire source navigation into Verdict detail panels (hypothesis, contradiction, gap) and Timeline event cards. Complete the citation coverage across all remaining views.

Purpose: Hypothesis, contradiction, and gap detail panels show evidence items with truncated finding IDs but no click behavior. Timeline cards show source counts but nothing is interactive. This plan makes every citation reference clickable across these views.

Output: 6 modified files with working citation-to-source navigation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-source-panel/10-CONTEXT.md
@.planning/phases/10-source-panel/10-RESEARCH.md
@.planning/phases/10-source-panel/10-01-SUMMARY.md
@frontend/src/components/verdict/HypothesisDetailPanel.tsx
@frontend/src/components/verdict/ContradictionDetailPanel.tsx
@frontend/src/components/verdict/GapDetailPanel.tsx
@frontend/src/components/Timeline/TimelineEventCard.tsx
@frontend/src/types/detail-sidebar.ts
@frontend/src/components/app/detail-sidebar.tsx
@frontend/src/hooks/useSourceNavigation.ts
@frontend/src/components/ui/entity-badge.tsx
@frontend/src/types/synthesis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Verdict detail panels with source navigation callbacks</name>
  <files>
    frontend/src/components/verdict/HypothesisDetailPanel.tsx
    frontend/src/components/verdict/ContradictionDetailPanel.tsx
    frontend/src/components/verdict/GapDetailPanel.tsx
    frontend/src/types/detail-sidebar.ts
    frontend/src/components/app/detail-sidebar.tsx
  </files>
  <action>
**Step 1: Update detail-sidebar types to pass source navigation callbacks**

In `frontend/src/types/detail-sidebar.ts`:
- Add `onViewFinding?: (findingId: string) => void` to `VerdictHypothesisContent.props`
- Add `onViewFinding?: (findingId: string) => void` to `VerdictContradictionContent.props`
- No changes needed for `VerdictGapContent` (gaps don't have citation references to files)

In `frontend/src/components/app/detail-sidebar.tsx`:
- For the `verdict-hypothesis` case, pass `onViewFinding={content.props.onViewFinding}` to HypothesisDetailPanel
- For the `verdict-contradiction` case, pass `onViewFinding={content.props.onViewFinding}` to ContradictionDetailPanel
- Read this file first to understand the current switch structure before making changes.

**Step 2: HypothesisDetailPanel.tsx -- clickable evidence items**

1. Add `onViewFinding?: (findingId: string) => void` to `HypothesisDetailPanelProps`.

2. Pass `onViewFinding` down to the `EvidenceRow` subcomponent: add `onViewFinding?: (findingId: string) => void` to EvidenceRow's implicit props.

3. In `EvidenceRow`, make the evidence item clickable when `onViewFinding` is provided and `item.finding_id` exists:
   - Wrap the whole evidence card in a clickable container: add `onClick={() => onViewFinding?.(item.finding_id)}` to the outer div
   - Add hover state: `cursor-pointer hover:bg-charcoal/70 transition-colors` (when onViewFinding is available)
   - Replace the truncated finding_id display (`{item.finding_id.slice(0, 8)}`) with a more informative label: keep the truncated ID but add a FileText icon and "View source" text that appears on hover
   - Specifically: change the finding_id span to be a row with:
     - The truncated ID as before
     - A "View source" text that shows on group-hover: `<span className="hidden group-hover:inline text-[10px] text-stone/70 ml-1">View source</span>`
   - Add `group` class to the outer div to enable group-hover

4. Pass `onViewFinding` from HypothesisDetailPanel to each EvidenceRow:
   ```
   <EvidenceRow key={...} item={item} onViewFinding={onViewFinding} />
   ```

**Step 3: ContradictionDetailPanel.tsx -- clickable source excerpts**

1. Add `onViewFinding?: (findingId: string) => void` to `ContradictionDetailPanelProps`.

2. In the `SourceExcerpt` subcomponent, add `onViewFinding?: (findingId: string) => void` to `SourceExcerptProps`.

3. Make the source excerpt card clickable when `onViewFinding` is provided and `findingId` exists:
   - Add `onClick={() => { if (findingId) onViewFinding?.(findingId); }}` to the outer div
   - Add hover state: `cursor-pointer hover:bg-charcoal/70 transition-colors` (when both onViewFinding and findingId exist)
   - Replace the truncated finding_id display with same pattern as hypothesis: truncated ID + hover "View source" text
   - Add `group` class to outer div

4. Pass `onViewFinding` from ContradictionDetailPanel to each SourceExcerpt:
   ```
   <SourceExcerpt ... onViewFinding={onViewFinding} />
   ```

**Step 4: GapDetailPanel.tsx -- improved entity badges**

Gaps already show resolved entity names via the backend `_resolve_entity_ids`. The current rendering uses inline styling. Upgrade to use the shared `EntityBadge` component for consistency:

1. Import `EntityBadge` from `@/components/ui/entity-badge`.
2. Replace the inline entity rendering in the "Related Entities" CollapsibleSection:
   - Current: manual div with AlertCircle icon + entity.name + entity.entity_type
   - Replace with: `<EntityBadge name={entity.name} entityType={entity.entity_type} />`
   - This gives consistent color-coding via getEntityColor and matches the style used in geospatial

**Step 5: Wire the callbacks from the VerdictView or CC page**

Find where `verdict-hypothesis` and `verdict-contradiction` sidebar descriptors are created and add the `onViewFinding` callback. This is likely in `VerdictView.tsx` or similar. Search for where `setContent({ type: "verdict-hypothesis"` is called.

- Import `useSourceNavigation` in the component that creates these descriptors
- Get caseId from URL params
- Call `const { openFromFinding, sourceContent, closeSource } = useSourceNavigation(caseId)`
- Pass `onViewFinding: openFromFinding` in the descriptor props
- Render `SourceViewerModal` in this parent component (with `sourceContent` and `closeSource`)
- The modal should render as a portal to body with appropriate z-index (z-[60])

Read VerdictView.tsx and the CC page to find exactly where these descriptors are created before making changes.
  </action>
  <verify>
    Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero type errors. Then `bun run build`.
  </verify>
  <done>
    - HypothesisDetailPanel evidence items are clickable with hover state and "View source" text
    - ContradictionDetailPanel source excerpts are clickable with hover state
    - GapDetailPanel entity badges use EntityBadge component for consistent styling
    - detail-sidebar.ts types updated with onViewFinding callbacks
    - Source viewer opens via portal when evidence is clicked from verdict panels
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Timeline event cards with source citation details</name>
  <files>
    frontend/src/components/Timeline/TimelineEventCard.tsx
  </files>
  <action>
**TimelineEventCard.tsx -- source and entity info:**

The card currently shows source count ("3 sources") and entity count ("2 entities") as static text in the footer. Make the source count actionable and show entity names.

1. Add optional callback props:
   ```
   onViewSource?: (sourceId: string) => void
   onViewEntity?: (entityId: string) => void
   ```

2. **Source count enhancement:**
   - Keep the existing source count display ("3 sources") as the default collapsed state
   - When `onViewSource` is provided, make the source count text a clickable link:
     - Style: `cursor-pointer hover:text-smoke transition-colors underline decoration-stone/30`
     - On click (stopPropagation to not trigger the card's onClick): show source IDs as individual clickable items
   - Alternative simpler approach: if `event.sourceIds.length > 0` and `onViewSource` provided, make each source ID clickable. Since the footer is compact, show source IDs as small clickable pills on click/expand:
     - On clicking "3 sources", expand a small section below the footer showing each sourceId as a clickable `<button>` with a FileText icon and truncated ID
     - Each button calls `onViewSource(sourceId)` with stopPropagation
   - Use local state `showSources: boolean` to toggle the expanded view

3. **Entity count enhancement:**
   - When `event.entityIds` has entries, show entity count as before
   - No expansion needed for v1 (entity names in timeline cards would require the resolver hook at a higher level). Just keep the count display for now.
   - The entity resolution can be added if there's a natural place to call useEntityResolver in the Timeline parent. If the Timeline parent (Timeline.tsx or TimelineCore.tsx) already has caseId, consider adding useEntityResolver there and passing resolved names down. But this is LOW priority for this plan -- focus on source clickability.

4. The `onViewSource` callback expects a finding ID (since sourceIds in TimelineEvent are finding UUIDs from the backend `source_entity_ids` field -- actually check: the TimelineEvent.sourceIds field name is confusing; it comes from the backend `timeline_events.citations` JSONB).

   **Check the actual data mapping:** Read `frontend/src/lib/api/timelineApi.ts` to understand what `sourceIds` contains. Based on RESEARCH.md, TimelineEvent may have `metadata.citations` as the citation array. The `sourceIds` field in the Zod schema is `z.array(z.string()).default([])`.

   Look at how the backend timeline API transforms data. If `sourceIds` are finding UUIDs, use `onViewSource` as `onViewFinding`. If they are something else, adapt accordingly.

   Given the timeline transform in timelineApi.ts, sourceIds likely maps to finding IDs or citation file IDs. Examine and wire accordingly.

5. Ensure `event.stopPropagation()` is called on the source expansion click to prevent the card's `onClick` from firing.

6. Update the parent component that renders TimelineEventCard (likely TimelineCore.tsx) to pass `onViewSource`. The parent needs access to `useSourceNavigation`:
   - If TimelineCore.tsx has access to caseId, import useSourceNavigation there
   - Pass `onViewSource={(sourceId) => openFromFinding(sourceId)}` to each TimelineEventCard
   - Render SourceViewerModal at the TimelineCore level or the Timeline page level

Read the Timeline component tree (Timeline.tsx, TimelineCore.tsx) to find the right place to inject useSourceNavigation before making changes. Only modify the minimum files needed.
  </action>
  <verify>
    Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero type errors. Then `bun run build`.
  </verify>
  <done>
    - Timeline event card "sources" count is clickable and expands to show individual source links
    - Clicking a source link triggers openFromFinding -> SourceViewerModal
    - SourceViewerModal renders from the Timeline view
    - Card click event properly isolated from source link clicks (stopPropagation)
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero errors
2. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run build` -- builds successfully
3. Verdict hypothesis evidence items are clickable
4. Verdict contradiction source excerpts are clickable
5. Gap entities use EntityBadge styling
6. Timeline source counts expand to show clickable source links
7. SourceViewerModal opens from each view (Verdict panels, Timeline)
</verification>

<success_criteria>
- Every evidence item in hypothesis detail panel triggers source navigation on click
- Every source excerpt in contradiction detail panel triggers source navigation on click
- Gap entity badges are color-coded via getEntityColor (EntityBadge component)
- Timeline event card source count expands to show clickable source references
- SourceViewerModal opens from Verdict and Timeline views via portal
- All type checking and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-source-panel/10-03-SUMMARY.md`
</output>
