---
phase: 10-source-panel
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - frontend/src/components/verdict/HypothesisDetailPanel.tsx
  - frontend/src/components/verdict/ContradictionDetailPanel.tsx
  - frontend/src/components/verdict/GapDetailPanel.tsx
  - frontend/src/components/verdict/VerdictView.tsx
  - frontend/src/components/Timeline/TimelineEventCard.tsx
  - frontend/src/components/Timeline/TimelineCore.tsx
  - frontend/src/types/detail-sidebar.ts
  - frontend/src/components/app/detail-sidebar.tsx
  - frontend/src/app/(app)/cases/[id]/command-center/page.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking an evidence item in the hypothesis detail panel opens SourceViewerModal with the cited source file"
    - "Clicking a source excerpt in the contradiction detail panel opens SourceViewerModal"
    - "Gap entity badges use getEntityColor for consistent color coding"
    - "Timeline event card shows citation links from event.metadata.citations, clicking opens SourceViewerModal"
  deferred:
    - "Chat message citations are deferred to Phase 9+ -- the chat backend and structured citation format do not yet exist. Phase 10 covers KG, Verdict, Geospatial, and Timeline only."
  artifacts:
    - path: "frontend/src/components/verdict/HypothesisDetailPanel.tsx"
      provides: "EvidenceRow with clickable finding_id -> source navigation"
    - path: "frontend/src/components/verdict/ContradictionDetailPanel.tsx"
      provides: "SourceExcerpt with clickable finding_id -> source navigation"
    - path: "frontend/src/components/verdict/GapDetailPanel.tsx"
      provides: "Entity badges using EntityBadge for consistent styling"
    - path: "frontend/src/components/verdict/VerdictView.tsx"
      provides: "Passes onViewFinding callback through sidebar descriptors"
    - path: "frontend/src/components/Timeline/TimelineEventCard.tsx"
      provides: "Source citations expandable and clickable via metadata.citations"
    - path: "frontend/src/components/Timeline/TimelineCore.tsx"
      provides: "Wires useSourceNavigation and passes callbacks to TimelineEventCard"
    - path: "frontend/src/types/detail-sidebar.ts"
      provides: "onViewFinding callback added to VerdictHypothesisContent and VerdictContradictionContent props"
    - path: "frontend/src/components/app/detail-sidebar.tsx"
      provides: "Passes onViewFinding through to verdict detail panels"
    - path: "frontend/src/app/(app)/cases/[id]/command-center/page.tsx"
      provides: "useSourceNavigation hook + SourceViewerModal for verdict source viewing"
  key_links:
    - from: "HypothesisDetailPanel.tsx"
      to: "useSourceNavigation"
      via: "onViewFinding callback prop from sidebar descriptor"
      pattern: "onViewFinding"
    - from: "ContradictionDetailPanel.tsx"
      to: "useSourceNavigation"
      via: "onViewFinding callback prop from sidebar descriptor"
      pattern: "onViewFinding"
    - from: "TimelineEventCard.tsx"
      to: "useSourceNavigation"
      via: "onViewCitation callback prop receiving Citation objects from metadata.citations"
      pattern: "onViewCitation"
    - from: "TimelineCore.tsx"
      to: "useSourceNavigation"
      via: "openSource(citation) for metadata.citations"
      pattern: "openSource"
    - from: "command-center/page.tsx"
      to: "useSourceNavigation"
      via: "openFromFinding passed through VerdictView -> sidebar descriptors -> detail panels"
      pattern: "openFromFinding"
---

<objective>
Wire source navigation into Verdict detail panels (hypothesis, contradiction, gap) and Timeline event cards. Complete the citation coverage across all remaining views (excluding Chat, which is deferred to Phase 9+).

Purpose: Hypothesis, contradiction, and gap detail panels show evidence items with truncated finding IDs but no click behavior. Timeline cards show source counts but nothing is interactive. This plan makes every citation reference clickable across these views.

Output: 9 modified files with working citation-to-source navigation

Note: Chat message citations are explicitly deferred. The chat backend (Phase 9) does not yet produce structured citations in a format the source viewer can consume. Phase 10 coverage: KG, Verdict, Geospatial, Timeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-source-panel/10-CONTEXT.md
@.planning/phases/10-source-panel/10-RESEARCH.md
@.planning/phases/10-source-panel/10-01-SUMMARY.md
@.planning/phases/10-source-panel/10-02-SUMMARY.md
@frontend/src/components/verdict/HypothesisDetailPanel.tsx
@frontend/src/components/verdict/ContradictionDetailPanel.tsx
@frontend/src/components/verdict/GapDetailPanel.tsx
@frontend/src/components/verdict/VerdictView.tsx
@frontend/src/app/(app)/cases/[id]/command-center/page.tsx
@frontend/src/components/Timeline/TimelineEventCard.tsx
@frontend/src/components/Timeline/TimelineCore.tsx
@frontend/src/types/detail-sidebar.ts
@frontend/src/components/app/detail-sidebar.tsx
@frontend/src/hooks/useSourceNavigation.ts
@frontend/src/components/ui/entity-badge.tsx
@frontend/src/types/synthesis.ts
@frontend/src/types/timeline.types.ts
@frontend/src/lib/api/timelineApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Verdict detail panels with source navigation callbacks</name>
  <files>
    frontend/src/components/verdict/HypothesisDetailPanel.tsx
    frontend/src/components/verdict/ContradictionDetailPanel.tsx
    frontend/src/components/verdict/GapDetailPanel.tsx
    frontend/src/components/verdict/VerdictView.tsx
    frontend/src/types/detail-sidebar.ts
    frontend/src/components/app/detail-sidebar.tsx
    frontend/src/app/(app)/cases/[id]/command-center/page.tsx
  </files>
  <action>
**Step 1: Update detail-sidebar types to pass source navigation callbacks**

In `frontend/src/types/detail-sidebar.ts`:
- Add `onViewFinding?: (findingId: string) => void` to `VerdictHypothesisContent.props`
- Add `onViewFinding?: (findingId: string) => void` to `VerdictContradictionContent.props`
- No changes needed for `VerdictGapContent` (gaps don't have citation references to files)

In `frontend/src/components/app/detail-sidebar.tsx`:
- For the `verdict-hypothesis` case, pass `onViewFinding={content.props.onViewFinding}` to HypothesisDetailPanel
- For the `verdict-contradiction` case, pass `onViewFinding={content.props.onViewFinding}` to ContradictionDetailPanel
- Read this file first to understand the current `renderContent` switch structure before making changes.

**Step 2: HypothesisDetailPanel.tsx -- clickable evidence items**

1. Add `onViewFinding?: (findingId: string) => void` to `HypothesisDetailPanelProps`.

2. Pass `onViewFinding` down to the `EvidenceRow` subcomponent: add `onViewFinding?: (findingId: string) => void` to EvidenceRow's implicit props.

3. In `EvidenceRow`, make the evidence item clickable when `onViewFinding` is provided and `item.finding_id` exists:
   - Wrap the whole evidence card in a clickable container: add `onClick={() => onViewFinding?.(item.finding_id)}` to the outer div
   - Add hover state: `cursor-pointer hover:bg-charcoal/70 transition-colors` (when onViewFinding is available)
   - Replace the truncated finding_id display (`{item.finding_id.slice(0, 8)}`) with a more informative label: keep the truncated ID but add a FileText icon and "View source" text that appears on hover
   - Specifically: change the finding_id span to be a row with:
     - The truncated ID as before
     - A "View source" text that shows on group-hover: `<span className="hidden group-hover:inline text-[10px] text-stone/70 ml-1">View source</span>`
   - Add `group` class to the outer div to enable group-hover

4. Pass `onViewFinding` from HypothesisDetailPanel to each EvidenceRow:
   ```
   <EvidenceRow key={...} item={item} onViewFinding={onViewFinding} />
   ```

**Step 3: ContradictionDetailPanel.tsx -- clickable source excerpts**

1. Add `onViewFinding?: (findingId: string) => void` to `ContradictionDetailPanelProps`.

2. In the `SourceExcerpt` subcomponent, add `onViewFinding?: (findingId: string) => void` to `SourceExcerptProps`.

3. Make the source excerpt card clickable when `onViewFinding` is provided and `findingId` exists:
   - Add `onClick={() => { if (findingId) onViewFinding?.(findingId); }}` to the outer div
   - Add hover state: `cursor-pointer hover:bg-charcoal/70 transition-colors` (when both onViewFinding and findingId exist)
   - Replace the truncated finding_id display with same pattern as hypothesis: truncated ID + hover "View source" text
   - Add `group` class to outer div

4. Pass `onViewFinding` from ContradictionDetailPanel to each SourceExcerpt:
   ```
   <SourceExcerpt ... onViewFinding={onViewFinding} />
   ```

**Step 4: GapDetailPanel.tsx -- improved entity badges**

Gaps already show resolved entity names via the backend `_resolve_entity_ids`. The current rendering uses inline styling. Upgrade to use the shared `EntityBadge` component for consistency:

1. Import `EntityBadge` from `@/components/ui/entity-badge`.
2. Replace the inline entity rendering in the "Related Entities" CollapsibleSection:
   - Current: manual div with AlertCircle icon + entity.name + entity.entity_type
   - Replace with: `<EntityBadge name={entity.name} entityType={entity.entity_type} />`
   - This gives consistent color-coding via getEntityColor and matches the style used in geospatial

**Step 5: Wire callbacks from command-center/page.tsx through VerdictView**

The sidebar descriptors for `verdict-hypothesis` and `verdict-contradiction` are created in `frontend/src/components/verdict/VerdictView.tsx` in the `handleHypothesisClick` and `handleContradictionClick` callbacks. The `VerdictView` is rendered in `frontend/src/app/(app)/cases/[id]/command-center/page.tsx`.

In `frontend/src/app/(app)/cases/[id]/command-center/page.tsx`:
1. Import `useSourceNavigation` from `@/hooks/useSourceNavigation`
2. Import `SourceViewerModal` from `@/components/source-viewer/SourceViewerModal`
3. Call `const { openFromFinding, sourceContent: verdictSourceContent, closeSource: verdictCloseSource } = useSourceNavigation(caseId)`
4. Pass `onViewFinding={openFromFinding}` to `VerdictView` as a new prop
5. Render `SourceViewerModal` as a portal when `verdictSourceContent` is not null:
   ```
   {verdictSourceContent && createPortal(
     <div className="fixed inset-0 z-[60] flex items-center justify-center p-4" style={{ backgroundColor: "rgba(0,0,0,0.7)" }}>
       <div className="w-full max-w-5xl h-[85vh]">
         <SourceViewerModal content={verdictSourceContent} onClose={verdictCloseSource} />
       </div>
     </div>,
     document.body
   )}
   ```

In `frontend/src/components/verdict/VerdictView.tsx`:
1. Add `onViewFinding?: (findingId: string) => void` to `VerdictViewProps`
2. In `handleHypothesisClick`, include `onViewFinding` in the descriptor props:
   ```
   onOpenDetail?.({
     type: "verdict-hypothesis",
     props: { hypothesis, onViewFinding },
   });
   ```
3. In `handleContradictionClick`, include `onViewFinding` in the descriptor props:
   ```
   onOpenDetail?.({
     type: "verdict-contradiction",
     props: { contradiction, onViewFinding },
   });
   ```
  </action>
  <verify>
    Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero type errors. Then `bun run build`.
  </verify>
  <done>
    - detail-sidebar.ts types updated with onViewFinding for verdict hypothesis and contradiction
    - detail-sidebar.tsx passes onViewFinding through to verdict detail panels
    - HypothesisDetailPanel evidence items are clickable with hover state and "View source" text
    - ContradictionDetailPanel source excerpts are clickable with hover state
    - GapDetailPanel entity badges use EntityBadge component for consistent styling
    - VerdictView.tsx passes onViewFinding through sidebar descriptors
    - command-center/page.tsx wires useSourceNavigation and renders SourceViewerModal via portal
    - Source viewer opens when evidence is clicked from verdict panels
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Timeline event cards with source citation details</name>
  <files>
    frontend/src/components/Timeline/TimelineEventCard.tsx
    frontend/src/components/Timeline/TimelineCore.tsx
  </files>
  <action>
**IMPORTANT DATA MAPPING NOTE:** In `timelineApi.ts`, the `transformBackendEvent` function maps:
- `sourceIds` <- `backendEvent.source_entity_ids` (these are **entity UUIDs**, NOT finding IDs)
- `entityIds` <- `backendEvent.source_entity_ids` (same entity UUIDs, duplicated)
- `metadata.citations` <- `backendEvent.citations` (array of `{ file_id, locator, excerpt }` objects -- these are the actual citation objects)

Therefore, to open source files from timeline events, use `event.metadata.citations` with `openSource()`, NOT `event.sourceIds` with `openFromFinding()`. The `sourceIds` field is misnamed -- it contains entity UUIDs.

**TimelineEventCard.tsx -- citation click support:**

1. Define a local `TimelineCitation` interface (or import `Citation` from `@/lib/citation-utils` once Plan 01 is complete):
   ```
   interface TimelineCitation {
     file_id: string;
     locator: string;
     excerpt?: string;
   }
   ```

2. Add optional callback prop:
   ```
   onViewCitation?: (citation: TimelineCitation) => void
   ```

3. **Source count enhancement with citation expansion:**
   - Extract citations from `event.metadata?.citations` (cast to `TimelineCitation[]` with a type guard or safe parse). If metadata is undefined or citations is not an array, treat as empty.
   - Keep the existing source count display in the footer ("3 sources") but use the citations array length instead of `event.sourceIds.length` for the count:
     ```
     const citations: TimelineCitation[] = Array.isArray(event.metadata?.citations) ? event.metadata.citations as TimelineCitation[] : [];
     ```
   - If `citations.length > 0` and `onViewCitation` is provided, make the source count text a clickable link:
     - Style: `cursor-pointer hover:text-foreground transition-colors underline decoration-muted-foreground/30`
     - Add local state `showCitations: boolean` (default false), toggled on click (with `e.stopPropagation()`)
   - When `showCitations` is true, render citation list below the footer:
     - For each citation, render a clickable row with:
       - FileText icon (size 12)
       - Truncated file_id (`citation.file_id.slice(0, 8)...`) or a locator label (e.g., "Page 3" for "page:3", or the raw locator)
       - Truncated excerpt if available (line-clamp-1, text-xs, italic)
     - On click (with `e.stopPropagation()`): call `onViewCitation(citation)`
     - Style each row: `flex items-center gap-2 px-2 py-1.5 rounded text-xs hover:bg-muted/50 cursor-pointer transition-colors`
   - Wrap the expanded section in a `<div className="mt-2 pt-2 border-t border-border/50 space-y-1">`

4. **Entity count:** Keep the existing entity count display unchanged for now (entity name resolution in timeline cards is low priority per plan scope).

5. Ensure `e.stopPropagation()` is called on both the citation toggle click and individual citation clicks to prevent the card's `onClick` from firing.

6. Remove the old sourceIds-based count display and replace with citations-based:
   - Old: `{event.sourceIds && event.sourceIds.length > 0 && (<span>... {event.sourceIds.length} sources</span>)}`
   - New: `{citations.length > 0 && (<span/button>... {citations.length} sources</span/button>)}`

**TimelineCore.tsx -- wire useSourceNavigation:**

1. Import `useSourceNavigation` from `@/hooks/useSourceNavigation` and `SourceViewerModal` from `@/components/source-viewer/SourceViewerModal`.

2. Add `caseId: string` prop to `TimelineCoreProps`:
   ```
   interface TimelineCoreProps {
     events: TimelineEvent[];
     zoomLevel: TimelineZoomLevel;
     caseId: string;       // <-- add this
     onEventClick?: (event: TimelineEvent) => void;
     className?: string;
   }
   ```

3. Call `const { openSource, sourceContent: timelineSourceContent, closeSource: timelineCloseSource } = useSourceNavigation(caseId)`.

4. Pass `onViewCitation` to each `TimelineEventCard`:
   ```
   <TimelineEventCard
     event={event}
     onClick={() => onEventClick?.(event)}
     onViewCitation={(citation) => openSource(citation)}
   />
   ```

5. Render `SourceViewerModal` at the bottom of the TimelineCore component when `timelineSourceContent` is not null. Use a portal to document.body:
   ```
   {timelineSourceContent && createPortal(
     <div className="fixed inset-0 z-[60] flex items-center justify-center p-4" style={{ backgroundColor: "rgba(0,0,0,0.7)" }}>
       <div className="w-full max-w-5xl h-[85vh]">
         <SourceViewerModal content={timelineSourceContent} onClose={timelineCloseSource} />
       </div>
     </div>,
     document.body
   )}
   ```

6. Update the parent component(s) that render `<TimelineCore>` to pass the `caseId` prop. Search for `<TimelineCore` usage and add the prop. The `Timeline.tsx` component likely has access to caseId from its own props.
  </action>
  <verify>
    Run `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero type errors. Then `bun run build`.
  </verify>
  <done>
    - Timeline event card citation count is derived from event.metadata.citations (not sourceIds)
    - Clicking citation count expands to show individual citation rows with file info
    - Clicking a citation row triggers openSource with the Citation object -> SourceViewerModal
    - SourceViewerModal renders from TimelineCore via portal
    - Card click events properly isolated from citation clicks (stopPropagation)
    - TimelineCore receives caseId prop and wires useSourceNavigation
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run typecheck` -- zero errors
2. `cd /Users/siddharth/Development/Hackathons/Gemini_3_2025/holmes/frontend && bun run build` -- builds successfully
3. Verdict hypothesis evidence items are clickable
4. Verdict contradiction source excerpts are clickable
5. Gap entities use EntityBadge styling
6. Timeline source counts derived from metadata.citations and expand to show clickable citation links
7. SourceViewerModal opens from each view (Verdict panels via CC page portal, Timeline via TimelineCore portal)
</verification>

<success_criteria>
- Every evidence item in hypothesis detail panel triggers source navigation on click
- Every source excerpt in contradiction detail panel triggers source navigation on click
- Gap entity badges are color-coded via getEntityColor (EntityBadge component)
- Timeline event card citation count uses metadata.citations (not entity UUIDs from sourceIds)
- Timeline citations expand to show clickable source references using openSource
- SourceViewerModal opens from Verdict and Timeline views via portal
- All type checking and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-source-panel/10-03-SUMMARY.md`
</output>
